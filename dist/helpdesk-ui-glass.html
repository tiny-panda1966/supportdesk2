<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Support Desk</title>
    <link href="https://fonts.googleapis.com/css2?family=Wix+Madefor+Text:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
/* Helpdesk Glassmorphism Styles */
* { margin: 0; padding: 0; box-sizing: border-box; }

::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.15); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: rgba(0,0,0,0.25); }

:root {
    --accent: #e43292;
    --accent-light: #f5d0e3;
    --accent-dark: #c4287d;
    --white: #ffffff;
    --black: #1a1a1a;
    --grey-50: #fafafa;
    --grey-100: #f5f5f5;
    --grey-200: #eeeeee;
    --grey-300: #e0e0e0;
    --grey-400: #bdbdbd;
    --grey-500: #9e9e9e;
    --grey-600: #757575;
    --grey-700: #616161;
    --priority-low: #4caf50;
    --priority-medium: #ff9800;
    --priority-high: #f44336;
    --priority-urgent: #9c27b0;
    --status-open: #2196f3;
    --status-progress: #ff9800;
    --status-awaiting: #9c27b0;
    --status-resolved: #4caf50;
    --status-closed: #757575;
    --type-support: #2196f3;
    --type-bug: #f44336;
    --type-project: #9c27b0;
    --type-referral: #009688;
    --radius: 16px;
    --radius-sm: 8px;
    --shadow: 0 2px 8px rgba(0,0,0,0.08);
    --shadow-lg: 0 8px 32px rgba(0,0,0,0.12);
    --chat-sent: #dcf8c6;
    --chat-received: #ffffff;
    --glass-bg: rgba(255, 255, 255, 0.75);
    --glass-border: rgba(255, 255, 255, 0.3);
    --glass-blur: blur(16px);
    --sidebar-width: 280px;
    --sidebar-collapsed: 92px;
}

body {
    font-family: 'Wix Madefor Text', -apple-system, BlinkMacSystemFont, sans-serif;
    background: linear-gradient(135deg, #fdf2f8 0%, #fce7f3 20%, #e2e8f0 40%, #cbd5e1 60%, #f1f5f9 80%, #fdf2f8 100%);
    background-size: 400% 400%;
    animation: gradientShift 15s ease infinite;
    color: var(--black);
    line-height: 1.5;
    height: 100vh;
    overflow: hidden;
}

@keyframes gradientShift {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}

.loading-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: var(--glass-bg);
    -webkit-backdrop-filter: var(--glass-blur);
    backdrop-filter: var(--glass-blur);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    transition: opacity 0.3s ease;
}
.loading-overlay.hidden { opacity: 0; pointer-events: none; }
.loader {
    width: 48px; height: 48px;
    border: 4px solid rgba(228, 50, 146, 0.2);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* APP LAYOUT */
.app { display: flex; height: 100vh; overflow: hidden; }

/* SIDEBAR */
.sidebar-wrapper { position: relative; flex-shrink: 0; overflow: visible; }
.sidebar {
    width: var(--sidebar-width);
    height: 100vh;
    background: var(--glass-bg);
    -webkit-backdrop-filter: blur(24px);
    backdrop-filter: blur(24px);
    border-right: 1px solid var(--glass-border);
    display: flex;
    flex-direction: column;
    transition: width 0.3s ease;
    position: relative;
}
.sidebar.collapsed { width: var(--sidebar-collapsed); border-right: none; }
.sidebar-content { flex: 1; overflow-y: auto; overflow-x: hidden; padding: 20px 16px; }
.sidebar.collapsed .sidebar-content { overflow: visible; padding: 20px 8px; }

.logo-section { display: flex; align-items: center; gap: 12px; margin-bottom: 24px; padding: 0 4px; }
.logo {
    width: 40px; height: 40px;
    background: var(--accent);
    border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
}
.logo img { width: 28px; height: 28px; }
.logo-text { display: flex; flex-direction: column; }
.logo-title { font-size: 16px; font-weight: 700; color: var(--black); white-space: nowrap; }
.logo-subtitle { font-size: 11px; color: var(--grey-600); white-space: nowrap; }
.sidebar.collapsed .logo-text { display: none; }
.sidebar.collapsed .logo-section { justify-content: center; margin-bottom: 12px; }

.contract-card {
    background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
    border-radius: var(--radius-sm);
    padding: 16px;
    margin-bottom: 20px;
    color: var(--white);
}
.contract-card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
.contract-name { font-size: 14px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.contract-actions-mini { display: flex; gap: 4px; }
.contract-action-mini {
    width: 28px; height: 28px;
    border-radius: 6px;
    background: rgba(255,255,255,0.2);
    border: none; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: background 0.2s;
}
.contract-action-mini:hover { background: rgba(255,255,255,0.35); }
.contract-action-mini svg { width: 16px; height: 16px; fill: var(--white); }
.contract-stats { display: flex; justify-content: space-between; gap: 8px; }
.contract-stat { flex: 1; background: rgba(255,255,255,0.2); border-radius: 6px; padding: 10px 8px; text-align: center; }
.contract-stat-value { font-size: 20px; font-weight: 700; }
.contract-stat-label { font-size: 10px; opacity: 0.9; }
.contract-progress { margin-top: 12px; }
.progress-track { height: 6px; background: rgba(255,255,255,0.25); border-radius: 3px; overflow: hidden; }
.progress-fill { height: 100%; background: #4caf50; border-radius: 3px; transition: width 0.4s ease; }
.progress-fill.warning { background: #ff9800; }
.progress-fill.danger { background: #f44336; }
.progress-text { font-size: 11px; margin-top: 6px; opacity: 0.9; text-align: center; }
.sidebar.collapsed .contract-card { padding: 10px; margin-bottom: 12px; }
.sidebar.collapsed .contract-card-header, .sidebar.collapsed .contract-name, .sidebar.collapsed .contract-progress { display: none; }
.sidebar.collapsed .contract-stats { flex-direction: column; gap: 6px; }
.sidebar.collapsed .contract-stat { padding: 8px 4px; }
.sidebar.collapsed .contract-stat-value { font-size: 16px; }
.sidebar.collapsed .contract-stat-label { font-size: 9px; }

.type-tabs { display: flex; flex-direction: column; gap: 4px; margin-bottom: 20px; }
.type-tab {
    display: flex; align-items: center; gap: 10px;
    padding: 10px 12px;
    border: none; background: transparent;
    border-radius: var(--radius-sm);
    cursor: pointer;
    font-size: 14px; font-weight: 500;
    color: var(--grey-700);
    transition: all 0.2s;
    font-family: inherit;
    text-align: left; width: 100%;
}
.type-tab:hover { background: rgba(255,255,255,0.5); }
.type-tab.active { background: var(--white); box-shadow: var(--shadow); }
.type-tab svg { width: 18px; height: 18px; fill: currentColor; flex-shrink: 0; }
.type-tab-text { flex: 1; white-space: nowrap; }
.type-tab-count { background: var(--grey-200); padding: 2px 8px; border-radius: 10px; font-size: 12px; font-weight: 600; }
.type-tab.active .type-tab-count { background: var(--grey-100); }
.type-tab.active[data-type="support"] { color: var(--type-support); }
.type-tab.active[data-type="bug"] { color: var(--type-bug); }
.type-tab.active[data-type="project"] { color: var(--type-project); }
.type-tab.active[data-type="referral"] { color: var(--type-referral); }
.sidebar.collapsed .type-tab { justify-content: center; padding: 10px; }
.sidebar.collapsed .type-tab-text, .sidebar.collapsed .type-tab-count { display: none; }

.quick-actions { display: flex; flex-direction: column; gap: 4px; }
.action-btn {
    display: flex; align-items: center; gap: 10px;
    padding: 10px 12px;
    border: none; background: transparent;
    border-radius: var(--radius-sm);
    cursor: pointer;
    font-size: 14px; color: var(--grey-700);
    transition: all 0.2s;
    font-family: inherit;
    text-align: left; width: 100%;
    position: relative;
}
.action-btn:hover { background: rgba(255,255,255,0.5); }
.action-btn svg { width: 18px; height: 18px; fill: var(--grey-600); flex-shrink: 0; }
.action-btn-text { white-space: nowrap; }
.action-btn.pacman-btn { background: rgba(255, 235, 59, 0.3); }
.action-btn.pacman-btn:hover { background: rgba(255, 235, 59, 0.5); }
.notification-badge {
    position: absolute; top: 6px; right: 6px;
    min-width: 18px; height: 18px;
    border-radius: 9px;
    background: #f44336;
    color: var(--white);
    font-size: 11px; font-weight: 600;
    display: flex; align-items: center; justify-content: center;
    padding: 0 5px;
}
.notification-badge.hidden { display: none; }
.sidebar.collapsed .action-btn { justify-content: center; padding: 10px; }
.sidebar.collapsed .action-btn-text { display: none; }
.sidebar.collapsed .notification-badge { top: -6px; right: -12px; }

.user-account {
    padding: 16px;
    background: rgba(255,255,255,0.5);
    border-top: 1px solid var(--glass-border);
    flex-shrink: 0;
}
.user-account-inner { display: flex; align-items: center; gap: 12px; }
.user-avatar {
    width: 40px; height: 40px;
    background: var(--accent);
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    color: var(--white);
    font-weight: 600; font-size: 16px;
    flex-shrink: 0;
}
.user-details { flex: 1; min-width: 0; }
.user-name { font-size: 14px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.user-email { font-size: 12px; color: var(--grey-600); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.sidebar.collapsed .user-account { background: transparent !important; border: none !important; padding: 12px 8px; }
.sidebar.collapsed .user-details { display: none; }
.sidebar.collapsed .user-account-inner { justify-content: center; }

.collapse-btn {
    position: absolute;
    right: -12px; top: 50%;
    transform: translateY(-50%);
    width: 12px; height: 36px;
    background: rgba(255, 255, 255, 0.75);
    border: none;
    border-radius: 0 4px 4px 0;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    z-index: 10;
    font-size: 10px; color: var(--grey-600);
}
.collapse-btn:hover { background: rgba(255, 255, 255, 0.9); }

/* MAIN CONTENT */
.main-content-wrapper { flex: 1; display: flex; flex-direction: column; min-width: 0; padding: 20px; overflow: hidden; }

.header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 16px 24px;
    background: var(--glass-bg);
    -webkit-backdrop-filter: var(--glass-blur);
    backdrop-filter: var(--glass-blur);
    border-radius: var(--radius);
    margin-bottom: 20px;
    flex-shrink: 0;
}
.header-left { display: flex; align-items: center; gap: 16px; }
.header-title-section h1 { font-size: 22px; font-weight: 700; color: var(--black); }
.live-indicator {
    display: inline-flex; align-items: center; gap: 6px;
    background: rgba(76, 175, 80, 0.15);
    color: #2e7d32;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 11px; font-weight: 600;
    margin-left: 12px;
}
.live-indicator::before {
    content: '';
    width: 8px; height: 8px;
    background: #4caf50;
    border-radius: 50%;
    animation: pulse 2s infinite;
}
@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

.header-center { display: flex; align-items: center; gap: 12px; }
.company-branding { display: flex; align-items: center; gap: 10px; }
.company-logo { max-height: 36px; max-width: 100px; object-fit: contain; }
.company-name-display { font-size: 14px; font-weight: 600; color: var(--accent); }
.header-right { display: flex; align-items: center; gap: 12px; }

.search-box { position: relative; width: 280px; }
.search-box input {
    width: 100%; height: 44px;
    padding: 0 16px 0 44px;
    border: 1px solid var(--glass-border);
    border-radius: 12px;
    background: rgba(255,255,255,0.6);
    font-size: 14px; font-family: inherit;
}
.search-box input:focus { outline: none; border-color: var(--accent); background: var(--white); }
.search-box svg { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); width: 18px; height: 18px; fill: var(--grey-500); }

.filter-select {
    padding: 8px 12px;
    border: 1px solid var(--glass-border);
    border-radius: var(--radius-sm);
    font-size: 13px;
    background: rgba(255,255,255,0.6);
    font-family: inherit;
    cursor: pointer;
}
.filter-select:focus { outline: none; border-color: var(--accent); }

.btn-new-ticket {
    height: 44px; padding: 0 20px;
    background: var(--accent);
    color: var(--white);
    border: none;
    border-radius: 12px;
    font-size: 14px; font-weight: 600;
    cursor: pointer;
    display: flex; align-items: center; gap: 8px;
    transition: all 0.2s;
    font-family: inherit;
}
.btn-new-ticket:hover { background: var(--accent-dark); transform: translateY(-2px); }
.btn-new-ticket svg { width: 18px; height: 18px; fill: currentColor; }

.content-area { flex: 1; display: flex; flex-direction: column; min-height: 0; overflow: hidden; }

.stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 20px; flex-shrink: 0; }
.stat-card {
    background: var(--glass-bg);
    -webkit-backdrop-filter: var(--glass-blur);
    backdrop-filter: var(--glass-blur);
    border-radius: var(--radius);
    padding: 20px;
    display: flex; align-items: center; gap: 16px;
}
.stat-icon {
    width: 48px; height: 48px;
    border-radius: 12px;
    display: flex; align-items: center; justify-content: center;
}
.stat-icon svg { width: 24px; height: 24px; }
.stat-icon.total { background: rgba(228, 50, 146, 0.15); }
.stat-icon.total svg { fill: var(--accent); }
.stat-icon.open { background: rgba(33, 150, 243, 0.15); }
.stat-icon.open svg { fill: var(--status-open); }
.stat-icon.progress { background: rgba(255, 152, 0, 0.15); }
.stat-icon.progress svg { fill: var(--status-progress); }
.stat-icon.resolved { background: rgba(76, 175, 80, 0.15); }
.stat-icon.resolved svg { fill: var(--status-resolved); }
.stat-info { flex: 1; }
.stat-value { font-size: 28px; font-weight: 700; color: var(--black); }
.stat-label { font-size: 13px; color: var(--grey-600); }

.status-tabs-row { display: grid; grid-template-columns: 1.5fr 2fr; gap: 20px; margin-bottom: 20px; flex-shrink: 0; }
.status-tabs {
    display: flex; gap: 8px;
    background: var(--glass-bg);
    -webkit-backdrop-filter: var(--glass-blur);
    backdrop-filter: var(--glass-blur);
    padding: 6px;
    border-radius: var(--radius);
}
.status-tab {
    flex: 1;
    padding: 10px 16px;
    border: none; background: transparent;
    border-radius: var(--radius-sm);
    font-size: 13px; font-weight: 500;
    color: var(--grey-600);
    cursor: pointer;
    transition: all 0.2s;
    font-family: inherit;
    white-space: nowrap;
}
.status-tab:hover { background: rgba(255,255,255,0.5); color: var(--black); }
.status-tab.active { background: var(--white); color: var(--accent); box-shadow: var(--shadow); }

.main-grid { display: grid; grid-template-columns: 1.5fr 2fr; gap: 20px; flex: 1; min-height: 0; }

.ticket-list-panel, .ticket-detail-panel {
    background: var(--glass-bg);
    -webkit-backdrop-filter: var(--glass-blur);
    backdrop-filter: var(--glass-blur);
    border-radius: var(--radius);
    display: flex; flex-direction: column;
    min-height: 0; overflow: hidden;
}
.panel-header {
    padding: 20px;
    border-bottom: 1px solid var(--glass-border);
    display: flex; justify-content: space-between; align-items: center;
    flex-shrink: 0;
}
.panel-title { font-size: 16px; font-weight: 600; color: var(--black); }

.ticket-list { flex: 1; overflow-y: auto; min-height: 0; }
.ticket-item {
    padding: 16px 20px;
    border-bottom: 1px solid rgba(0,0,0,0.05);
    cursor: pointer;
    transition: background 0.2s;
}
.ticket-item:hover { background: rgba(255,255,255,0.5); }
.ticket-item.active { background: rgba(228, 50, 146, 0.1); border-left: 3px solid var(--accent); }
.ticket-item-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
.ticket-number-block { display: flex; flex-direction: column; gap: 2px; }
.ticket-number { font-weight: 600; color: var(--accent); font-size: 14px; }
.ticket-datetime { font-size: 11px; color: var(--grey-500); }
.ticket-status { padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; }
.ticket-status.open { background: rgba(33, 150, 243, 0.15); color: var(--status-open); }
.ticket-status.in-progress { background: rgba(255, 152, 0, 0.15); color: var(--status-progress); }
.ticket-status.awaiting-response { background: rgba(156, 39, 176, 0.15); color: var(--status-awaiting); }
.ticket-status.resolved { background: rgba(76, 175, 80, 0.15); color: var(--status-resolved); }
.ticket-status.closed { background: var(--grey-200); color: var(--status-closed); }
.ticket-subject { font-weight: 500; font-size: 14px; color: var(--black); margin-bottom: 4px; }
.ticket-meta { font-size: 12px; color: var(--grey-600); display: flex; gap: 12px; align-items: center; }
.ticket-priority { display: inline-flex; align-items: center; gap: 4px; }
.priority-dot { width: 8px; height: 8px; border-radius: 50%; }
.priority-dot.low { background: var(--priority-low); }
.priority-dot.medium { background: var(--priority-medium); }
.priority-dot.high { background: var(--priority-high); }
.priority-dot.urgent { background: var(--priority-urgent); }
.ticket-type-badge { padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: 600; }
.ticket-type-badge.type-support { background: rgba(33, 150, 243, 0.15); color: var(--type-support); }
.ticket-type-badge.type-bug { background: rgba(244, 67, 54, 0.15); color: var(--type-bug); }
.ticket-type-badge.type-project { background: rgba(156, 39, 176, 0.15); color: var(--type-project); }
.ticket-type-badge.type-referral { background: rgba(0, 150, 136, 0.15); color: var(--type-referral); }
.ticket-locked-badge { display: inline-flex; align-items: center; justify-content: center; margin-left: 8px; padding: 4px; background: var(--grey-200); border-radius: 50%; }
.ticket-locked-badge svg { width: 14px; height: 14px; fill: var(--grey-600); }

.ticket-detail-content { flex: 1; overflow-y: auto; padding: 24px; min-height: 0; }
.detail-header { margin-bottom: 24px; }
.detail-title { font-size: 20px; font-weight: 700; margin-bottom: 8px; }
.detail-meta { display: flex; gap: 16px; flex-wrap: wrap; font-size: 13px; color: var(--grey-600); }
.detail-meta-item { display: flex; align-items: center; gap: 6px; }
.detail-meta-item svg { width: 16px; height: 16px; fill: var(--grey-500); }
.detail-section { margin-bottom: 24px; }
.detail-section-title { font-size: 12px; font-weight: 600; color: var(--grey-700); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
.detail-description { background: rgba(255,255,255,0.5); padding: 16px; border-radius: var(--radius-sm); font-size: 14px; line-height: 1.6; white-space: pre-wrap; }
.detail-info-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
.detail-info-item { background: rgba(255,255,255,0.5); padding: 12px 16px; border-radius: var(--radius-sm); }
.detail-info-label { font-size: 11px; color: var(--grey-600); margin-bottom: 4px; }
.detail-info-value { font-weight: 500; font-size: 14px; }

.empty-state { text-align: center; padding: 60px 20px; color: var(--grey-600); }
.empty-state svg { width: 64px; height: 64px; fill: var(--grey-300); margin-bottom: 16px; }
.empty-state h3 { font-size: 16px; margin-bottom: 8px; color: var(--black); }
.empty-state p { font-size: 14px; }

/* Notes/Chat section */
.notes-section { margin-top: 24px; }
.notes-container {
    background: rgba(229, 221, 213, 0.5);
    border-radius: var(--radius);
    padding: 16px;
    min-height: 200px; max-height: 350px;
    overflow-y: auto;
    display: flex; flex-direction: column; gap: 8px;
}
.note-bubble { max-width: 85%; padding: 10px 14px; border-radius: 12px; position: relative; word-wrap: break-word; }
.note-bubble.sent { background: var(--chat-sent); align-self: flex-end; border-bottom-right-radius: 4px; }
.note-bubble.received { background: var(--white); align-self: flex-start; border-bottom-left-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
.note-author { font-size: 12px; font-weight: 600; color: var(--accent); margin-bottom: 4px; }
.note-content { font-size: 14px; line-height: 1.4; white-space: pre-wrap; }
.note-time { font-size: 11px; color: var(--grey-500); text-align: right; margin-top: 4px; }
.note-attachment { margin-top: 8px; }
.note-attachment img { max-width: 200px; max-height: 200px; border-radius: var(--radius-sm); cursor: pointer; }
.note-input-container { display: flex; gap: 8px; margin-top: 12px; align-items: flex-end; }
.note-input-wrapper { flex: 1; display: flex; align-items: flex-end; gap: 8px; background: var(--white); border-radius: 24px; padding: 8px 12px; box-shadow: var(--shadow); }
.note-action-btn { width: 36px; height: 36px; border: none; background: transparent; cursor: pointer; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: background 0.2s; }
.note-action-btn:hover { background: var(--grey-100); }
.note-action-btn svg { width: 20px; height: 20px; fill: var(--grey-600); }
.note-textarea { flex: 1; border: none; resize: none; font-size: 14px; font-family: inherit; line-height: 1.4; max-height: 100px; min-height: 24px; padding: 6px 0; }
.note-textarea:focus { outline: none; }
.note-send-btn { width: 44px; height: 44px; border-radius: 50%; background: var(--accent); border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; flex-shrink: 0; }
.note-send-btn:hover { background: var(--accent-dark); transform: scale(1.05); }
.note-send-btn svg { width: 20px; height: 20px; fill: var(--white); }

/* Buttons */
.btn { padding: 10px 20px; border-radius: var(--radius-sm); font-weight: 500; font-size: 14px; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; border: none; font-family: inherit; }
.btn svg { width: 18px; height: 18px; fill: currentColor; }
.btn-primary { background: var(--accent); color: var(--white); }
.btn-primary:hover { background: var(--accent-dark); }
.btn-secondary { background: rgba(255,255,255,0.6); color: var(--black); }
.btn-secondary:hover { background: rgba(255,255,255,0.9); }
.btn-danger { background: #f44336; color: var(--white); }
.btn-danger:hover { background: #d32f2f; }

.status-actions { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 16px; }
.status-btn { padding: 8px 16px; border-radius: var(--radius-sm); font-size: 13px; font-weight: 500; cursor: pointer; border: 1px solid var(--grey-300); background: var(--white); transition: all 0.2s; font-family: inherit; }
.status-btn:hover { border-color: var(--accent); }
.status-btn.active { background: var(--accent); color: var(--white); border-color: var(--accent); }

/* Modals */
.modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); -webkit-backdrop-filter: blur(4px); backdrop-filter: blur(4px); display: none; align-items: flex-start; padding: 40px 20px; justify-content: center; z-index: 1000; overflow-y: auto; }
.modal-overlay.active { display: flex; }
.modal { background: var(--white); border-radius: var(--radius); width: 100%; max-width: 600px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; box-shadow: var(--shadow-lg); }
.modal-header { padding: 20px 24px; border-bottom: 1px solid var(--grey-200); display: flex; justify-content: space-between; align-items: center; }
.modal-title { font-size: 18px; font-weight: 600; }
.modal-close { width: 36px; height: 36px; border: none; background: transparent; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s; }
.modal-close:hover { background: var(--grey-100); }
.modal-close svg { width: 24px; height: 24px; fill: var(--grey-600); }
.modal-body { padding: 24px; overflow-y: auto; flex: 1; }
.modal-footer { padding: 16px 24px; border-top: 1px solid var(--grey-200); display: flex; justify-content: flex-end; gap: 12px; }

/* Form elements */
.form-group { margin-bottom: 20px; }
.form-label { display: block; font-weight: 500; margin-bottom: 8px; font-size: 14px; }
.required { color: #f44336; }
.form-input, .form-textarea, .form-select { width: 100%; padding: 12px 16px; border: 1px solid var(--grey-300); border-radius: var(--radius-sm); font-size: 14px; font-family: inherit; transition: border-color 0.2s; }
.form-input:focus, .form-textarea:focus, .form-select:focus { outline: none; border-color: var(--accent); }
.form-textarea { resize: vertical; min-height: 120px; }
.field-error { color: #f44336; font-size: 12px; margin-top: 4px; display: none; }
.form-input.invalid, .form-textarea.invalid { border-color: #f44336; background: rgba(244, 67, 54, 0.05); }

.ticket-type-selector { display: flex; gap: 12px; margin-bottom: 24px; }
.type-option { flex: 1; padding: 16px; border: 2px solid var(--grey-200); border-radius: var(--radius); cursor: pointer; text-align: center; transition: all 0.2s; }
.type-option:hover { border-color: var(--grey-400); }
.type-option.selected { border-color: var(--accent); background: var(--accent-light); }
.type-option svg { width: 32px; height: 32px; margin-bottom: 8px; }
.type-option[data-type="support"] svg { fill: var(--type-support); }
.type-option[data-type="bug"] svg { fill: var(--type-bug); }
.type-option[data-type="project"] svg { fill: var(--type-project); }
.type-option[data-type="referral"] svg { fill: var(--type-referral); }
.type-option-title { font-weight: 600; font-size: 14px; margin-bottom: 4px; }
.type-option-desc { font-size: 12px; color: var(--grey-600); }

.category-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
.category-card { padding: 16px; border: 2px solid var(--grey-200); border-radius: var(--radius-sm); cursor: pointer; text-align: center; transition: all 0.2s; }
.category-card:hover { border-color: var(--accent); background: var(--grey-50); }
.category-card.selected { border-color: var(--accent); background: var(--accent-light); }
.category-card svg { width: 28px; height: 28px; fill: var(--grey-600); margin-bottom: 8px; }
.category-card.selected svg { fill: var(--accent); }
.category-card-title { font-size: 12px; font-weight: 500; }

.priority-selector, .impact-selector { display: flex; gap: 8px; }
.priority-option, .impact-option { flex: 1; padding: 12px; border: 2px solid var(--grey-200); border-radius: var(--radius-sm); cursor: pointer; text-align: center; font-size: 13px; font-weight: 500; transition: all 0.2s; }
.priority-option:hover, .impact-option:hover { border-color: var(--grey-400); }
.priority-option.selected, .impact-option.selected { color: var(--white); }
.priority-option.selected.low { background: var(--priority-low); border-color: var(--priority-low); }
.priority-option.selected.medium { background: var(--priority-medium); border-color: var(--priority-medium); }
.priority-option.selected.high { background: var(--priority-high); border-color: var(--priority-high); }
.priority-option.selected.urgent { background: var(--priority-urgent); border-color: var(--priority-urgent); }
.impact-option.selected.none { background: var(--grey-500); border-color: var(--grey-500); }
.impact-option.selected.minor { background: var(--priority-low); border-color: var(--priority-low); }
.impact-option.selected.moderate { background: var(--priority-medium); border-color: var(--priority-medium); }
.impact-option.selected.major { background: var(--priority-high); border-color: var(--priority-high); }
.impact-option.selected.critical { background: var(--priority-urgent); border-color: var(--priority-urgent); }

/* Notification popup */
.notification-wrapper { position: relative; }
.notification-popup { position: absolute; top: calc(100% + 8px); right: 0; width: 380px; max-height: 400px; background: var(--white); border-radius: var(--radius); box-shadow: var(--shadow-lg); z-index: 1000; display: none; flex-direction: column; border: 1px solid var(--grey-200); }
.notification-popup.active { display: flex; }
.notification-popup-header { display: flex; justify-content: space-between; align-items: center; padding: 16px; border-bottom: 1px solid var(--grey-200); background: var(--grey-50); border-radius: var(--radius) var(--radius) 0 0; }
.notification-popup-header h3 { font-size: 16px; font-weight: 600; margin: 0; }
.notification-popup-actions { display: flex; align-items: center; gap: 8px; }
.notification-clear-btn { padding: 6px 12px; background: transparent; border: 1px solid var(--grey-300); border-radius: var(--radius-sm); font-size: 12px; cursor: pointer; color: var(--grey-600); font-family: inherit; }
.notification-clear-btn:hover { background: var(--grey-100); }
.notification-close-btn { width: 28px; height: 28px; border: none; background: transparent; cursor: pointer; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
.notification-close-btn:hover { background: var(--grey-200); }
.notification-close-btn svg { width: 18px; height: 18px; fill: var(--grey-600); }
.notification-list { overflow-y: auto; max-height: 340px; }
.notification-item { padding: 12px 16px; border-bottom: 1px solid var(--grey-100); cursor: pointer; transition: background 0.2s; }
.notification-item:hover { background: var(--accent-light); }
.notification-item:last-child { border-bottom: none; }
.notification-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
.notification-ticket { font-weight: 600; color: var(--accent); font-size: 13px; }
.notification-time { font-size: 11px; color: var(--grey-500); }
.notification-subject { font-weight: 500; font-size: 14px; margin-bottom: 4px; color: var(--black); }
.notification-message { font-size: 13px; color: var(--grey-600); line-height: 1.4; }
.notification-message strong { color: var(--grey-700); }
.notification-empty { padding: 40px 20px; text-align: center; color: var(--grey-500); font-size: 14px; }
@keyframes bellRing { 0%, 100% { transform: rotate(0); } 10%, 30%, 50%, 70%, 90% { transform: rotate(10deg); } 20%, 40%, 60%, 80% { transform: rotate(-10deg); } }
.bell-ringing svg { animation: bellRing 0.5s ease; }

/* Account dropdown */
.account-wrapper { position: relative; }
.account-dropdown { display: none; position: absolute; top: calc(100% + 8px); right: 0; background: var(--white); border-radius: var(--radius-sm); box-shadow: var(--shadow-lg); min-width: 180px; z-index: 200; overflow: hidden; }
.account-dropdown.visible { display: block; }
.account-dropdown-header { padding: 12px 16px; font-size: 13px; font-weight: 600; color: var(--grey-600); border-bottom: 1px solid var(--grey-200); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.account-dropdown-item { display: flex; align-items: center; gap: 8px; width: 100%; padding: 10px 16px; border: none; background: none; font-size: 14px; color: var(--grey-800); cursor: pointer; transition: background 0.15s; font-family: inherit; }
.account-dropdown-item:hover { background: var(--grey-100); }
.account-dropdown-item svg { width: 18px; height: 18px; fill: var(--grey-600); }

/* Rules popup */
.rules-popup-overlay, .task-history-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); -webkit-backdrop-filter: blur(4px); backdrop-filter: blur(4px); display: none; align-items: flex-start; padding: 40px 20px; justify-content: center; z-index: 1000; overflow-y: auto; }
.rules-popup-overlay.active, .task-history-overlay.active { display: flex; }
.rules-popup-content, .task-history-content { background: var(--white); border-radius: var(--radius); width: 100%; max-width: 520px; max-height: 85vh; overflow: hidden; display: flex; flex-direction: column; box-shadow: var(--shadow-lg); }
.task-history-content { max-width: 700px; }
.rules-popup-header, .task-history-header { padding: 20px 24px; background: var(--accent); color: var(--white); display: flex; justify-content: space-between; align-items: center; }
.rules-popup-header h3, .task-history-header h3 { font-size: 18px; font-weight: 600; margin: 0; }
.rules-popup-close, .task-history-close { background: transparent; border: none; color: var(--white); cursor: pointer; padding: 4px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
.rules-popup-close:hover, .task-history-close:hover { background: rgba(255,255,255,0.2); }
.rules-popup-close svg, .task-history-close svg { width: 24px; height: 24px; fill: currentColor; }
.rules-popup-body { padding: 24px; overflow-y: auto; }
.rules-list { list-style: none; padding: 0; margin: 0; }
.rules-list li { padding: 12px 16px; border-bottom: 1px solid var(--grey-100); font-size: 14px; line-height: 1.5; display: flex; align-items: flex-start; gap: 10px; }
.rules-list li:last-child { border-bottom: none; }
.rules-list li svg { width: 18px; height: 18px; fill: var(--accent); flex-shrink: 0; margin-top: 2px; }
.rules-highlight { background: var(--accent-light); border: 1px solid var(--accent); border-radius: var(--radius-sm); padding: 16px; margin-bottom: 16px; text-align: center; }
.rules-highlight-number { font-size: 28px; font-weight: 700; color: var(--accent); }
.rules-highlight-label { font-size: 13px; color: var(--grey-600); margin-top: 4px; }
.rules-highlight-row { display: flex; gap: 16px; margin-bottom: 16px; }
.rules-highlight-row .rules-highlight { flex: 1; margin-bottom: 0; }

/* Task history */
.task-history-body { padding: 24px; overflow-y: auto; flex: 1; }
.task-history-table { width: 100%; border-collapse: collapse; font-size: 13px; }
.task-history-table th { text-align: left; padding: 10px 12px; background: var(--grey-50); border-bottom: 2px solid var(--grey-200); font-weight: 600; font-size: 12px; text-transform: uppercase; letter-spacing: 0.3px; color: var(--grey-700); white-space: nowrap; }
.task-history-table td { padding: 10px 12px; border-bottom: 1px solid var(--grey-100); vertical-align: top; }
.task-history-table tr:hover td { background: var(--grey-50); }
.task-history-type-badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; }
.task-history-type-badge.PROJECT { background: #f3e5f5; color: var(--type-project); }
.task-history-type-badge.REFERRAL { background: #e0f2f1; color: var(--type-referral); }
.task-history-type-badge.FEEDBACK { background: #e3f2fd; color: var(--type-support); }
.task-history-type-badge.SUPPORT { background: #e3f2fd; color: var(--type-support); }
.task-history-type-badge.BUG { background: #fce4ec; color: var(--type-bug); }
.task-history-type-badge.UNUSED { background: #fff3e0; color: #e65100; }
.task-history-type-badge.OVERUSE { background: #fce4ec; color: #c62828; }
.task-history-type-badge.RENEWAL { background: #e8f5e9; color: #2e7d32; }
.task-history-empty { text-align: center; padding: 40px 20px; color: var(--grey-500); font-size: 14px; }
.task-history-summary { display: flex; gap: 16px; margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid var(--grey-200); }
.task-history-stat { flex: 1; text-align: center; padding: 12px; background: var(--grey-50); border-radius: var(--radius-sm); }
.task-history-stat-value { font-size: 22px; font-weight: 700; color: var(--accent); }
.task-history-stat-label { font-size: 11px; color: var(--grey-600); margin-top: 2px; }

/* Image modal */
.image-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; z-index: 1002; cursor: pointer; }
.image-modal.active { display: flex; }
.image-modal img { max-width: 90%; max-height: 90%; object-fit: contain; }

/* Toast */
.toast { position: fixed; bottom: 24px; right: 24px; background: var(--black); color: var(--white); padding: 16px 24px; border-radius: var(--radius); box-shadow: var(--shadow-lg); display: none; align-items: center; gap: 12px; z-index: 1001; animation: slideIn 0.3s ease; }
.toast.show { display: flex; }
.toast.success { background: #4caf50; }
.toast.error { background: #f44336; }
@keyframes slideIn { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

/* Status notes section */
.status-notes-section { background: rgba(232, 245, 233, 0.5); border: 1px solid rgba(165, 214, 167, 0.5); border-radius: var(--radius); padding: 16px; margin-top: 16px; }
.status-notes-section .detail-section-title { color: #2e7d32; }
.status-notes-list { max-height: 200px; overflow-y: auto; }
.status-note-item { background: var(--white); padding: 10px 12px; border-radius: var(--radius-sm); margin-bottom: 8px; border-left: 3px solid #4caf50; }
.status-note-item:last-child { margin-bottom: 0; }
.status-note-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
.status-note-date { font-size: 11px; color: var(--grey-500); }
.status-note-delete { width: 24px; height: 24px; border: none; background: transparent; cursor: pointer; border-radius: 4px; display: flex; align-items: center; justify-content: center; opacity: 0.5; transition: all 0.2s; }
.status-note-delete:hover { opacity: 1; background: #ffebee; }
.status-note-delete svg { width: 16px; height: 16px; fill: #d32f2f; }
.status-note-content { font-size: 14px; line-height: 1.5; color: var(--black); white-space: pre-wrap; }
.status-notes-list .no-notes { padding: 20px; text-align: center; color: var(--grey-500); font-style: italic; background: var(--white); border-radius: var(--radius-sm); }
.internal-notes-input-wrapper { display: flex; flex-direction: column; gap: 8px; margin-top: 12px; }
.internal-notes-textarea { width: 100%; min-height: 80px; padding: 12px; border: 1px solid var(--grey-300); border-radius: var(--radius-sm); font-size: 14px; font-family: inherit; resize: vertical; }
.internal-notes-textarea:focus { outline: none; border-color: #2e7d32; }
.internal-notes-input-wrapper .btn { align-self: flex-end; }

/* Profile setup banner */
.profile-setup-banner { background: var(--accent-light); border: 2px solid var(--accent); border-radius: var(--radius); padding: 20px; margin-bottom: 20px; }
.profile-setup-content { display: flex; align-items: center; gap: 16px; flex-wrap: wrap; }
.profile-setup-icon { width: 48px; height: 48px; background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
.profile-setup-icon svg { width: 24px; height: 24px; fill: var(--white); }
.profile-setup-text { flex: 1; min-width: 200px; }
.profile-setup-text strong { display: block; font-size: 16px; color: var(--accent-dark); margin-bottom: 4px; }
.profile-setup-text span { font-size: 14px; color: var(--grey-700); }
.profile-setup-form { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
.profile-input { padding: 10px 14px; border: 1px solid var(--grey-300); border-radius: var(--radius-sm); font-size: 14px; min-width: 150px; font-family: inherit; }
.profile-input:focus { outline: none; border-color: var(--accent); }

/* Access denied */
.access-denied { text-align: center; padding: 60px 20px; }
.access-denied svg { width: 80px; height: 80px; fill: var(--grey-400); margin-bottom: 24px; }
.access-denied h2 { font-size: 24px; margin-bottom: 12px; color: var(--black); }
.access-denied p { font-size: 16px; color: var(--grey-600); max-width: 400px; margin: 0 auto; }

/* Project value section */
.project-value-section { margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--grey-200); display: none; }
.project-value-section.visible { display: block; }
.project-value-label { font-weight: 600; font-size: 13px; margin-bottom: 8px; }
.project-value-input-wrapper { display: flex; align-items: center; gap: 8px; }
.project-value-prefix { font-size: 18px; font-weight: 600; color: var(--grey-600); }
.project-value-input { flex: 1; padding: 10px 14px; border: 1px solid var(--grey-300); border-radius: var(--radius-sm); font-size: 16px; font-weight: 600; font-family: inherit; }
.project-value-input:focus { outline: none; border-color: var(--accent); }
.project-value-save-btn { padding: 10px 16px; background: var(--type-project); color: var(--white); border: none; border-radius: var(--radius-sm); cursor: pointer; font-weight: 500; font-family: inherit; }
.project-value-info { margin-top: 8px; font-size: 12px; color: var(--grey-600); }
.project-value-display { font-size: 12px; color: var(--type-project); font-weight: 600; margin-top: 4px; }
.po-checkbox-wrapper { display: flex; align-items: center; gap: 8px; padding: 10px 0; cursor: pointer; user-select: none; }
.po-checkbox { width: 18px; height: 18px; accent-color: var(--accent); cursor: pointer; }
.po-checkbox-text { font-size: 13px; font-weight: 500; color: var(--grey-800); }
.po-status-badge { display: inline-flex; align-items: center; gap: 4px; padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; }
.po-status-badge.received { background: #e8f5e9; color: #2e7d32; }
.po-status-badge.pending { background: #fff3e0; color: #e65100; }
.project-value-save-full { width: 100%; margin-top: 4px; padding: 8px 16px; position: relative; }
.project-value-save-full.loading { pointer-events: none; opacity: 0.7; color: transparent; }
.project-value-save-full.loading::after { content: ''; position: absolute; top: 50%; left: 50%; width: 16px; height: 16px; margin: -8px 0 0 -8px; border: 2px solid rgba(255,255,255,0.3); border-top-color: #fff; border-radius: 50%; animation: spin 0.6s linear infinite; }

/* No tasks warning */
.no-tasks-warning { background: #fff3e0; border: 1px solid #ffb74d; border-radius: var(--radius-sm); padding: 12px 16px; margin: 12px 0; display: flex; align-items: center; gap: 8px; font-size: 13px; color: #e65100; }
.no-tasks-warning svg { width: 20px; height: 20px; fill: #e65100; flex-shrink: 0; }

/* Ticket locked banner */
.ticket-locked-banner { display: flex; align-items: center; justify-content: center; gap: 8px; padding: 12px 16px; background: var(--grey-100); border: 1px solid var(--grey-300); border-radius: var(--radius); color: var(--grey-600); font-size: 13px; margin-top: 12px; }
.ticket-locked-banner svg { width: 18px; height: 18px; fill: var(--grey-500); }

/* Button loading state */
.btn-loader { width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-top-color: #fff; border-radius: 50%; animation: spin 0.8s linear infinite; display: inline-block; }
.btn-primary.loading { pointer-events: none; opacity: 0.7; }
.btn-primary.loading .btn-text { display: none; }
.btn-primary.loading .btn-loader { display: inline-block !important; }

/* Admin type section */
.admin-type-section { margin-top: 16px; padding: 16px; background: rgba(255,255,255,0.5); border-radius: var(--radius); border: 1px solid var(--glass-border); display: none; }
.admin-type-section.visible { display: block; }
.admin-type-section h4 { font-size: 13px; font-weight: 600; margin-bottom: 12px; color: var(--grey-700); }
.admin-type-selector { display: flex; gap: 8px; }
.admin-type-btn { padding: 8px 16px; border: 1px solid var(--grey-300); border-radius: var(--radius-sm); background: var(--white); cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.2s; font-family: inherit; }
.admin-type-btn:hover { background: var(--grey-100); }
.admin-type-btn.active { color: var(--white); }
.admin-type-btn.active[data-type="support"] { background: var(--type-support); border-color: var(--type-support); }
.admin-type-btn.active[data-type="bug"] { background: var(--type-bug); border-color: var(--type-bug); }
.admin-type-btn.active[data-type="project"] { background: var(--type-project); border-color: var(--type-project); }

/* Mobile */
.mobile-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); -webkit-backdrop-filter: blur(4px); backdrop-filter: blur(4px); z-index: 998; }
.mobile-overlay.active { display: block; }
.mobile-close-btn { position: fixed; top: 12px; right: 12px; width: 40px; height: 40px; background: var(--white); border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow-lg); z-index: 1000; }
.mobile-close-btn svg { width: 24px; height: 24px; fill: var(--grey-700); }
.mobile-menu-btn { display: none; width: 40px; height: 40px; background: rgba(255,255,255,0.6); border: none; border-radius: 10px; cursor: pointer; align-items: center; justify-content: center; }
.mobile-menu-btn svg { width: 24px; height: 24px; fill: var(--grey-700); }
.mobile-back-btn { display: none; padding: 12px 20px; background: var(--glass-bg); border: none; border-bottom: 1px solid var(--glass-border); cursor: pointer; font-size: 14px; color: var(--accent); font-weight: 500; align-items: center; gap: 8px; font-family: inherit; width: 100%; }
.mobile-back-btn svg { width: 18px; height: 18px; fill: currentColor; }

/* Pending attachment */
.pending-attachment { display: flex; align-items: center; gap: 8px; padding: 8px; background: var(--grey-100); border-radius: var(--radius-sm); margin-bottom: 8px; }
.pending-attachment-preview { width: 40px; height: 40px; object-fit: cover; border-radius: var(--radius-sm); }
.pending-attachment-icon { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: var(--grey-200); border-radius: var(--radius-sm); }
.pending-attachment-icon svg { width: 24px; height: 24px; fill: var(--grey-600); }
.pending-attachment-info { flex: 1; }
.pending-attachment-name { font-size: 13px; font-weight: 500; }
.pending-attachment-type { font-size: 11px; color: var(--grey-600); }
.pending-attachment-remove { width: 24px; height: 24px; border: none; background: var(--grey-300); border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }
.pending-attachment-remove svg { width: 14px; height: 14px; fill: var(--grey-700); }

/* Opportunity badge */
.opportunity-badge { display: inline-flex; align-items: center; gap: 5px; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; white-space: nowrap; }
.opportunity-badge-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }

/* Feedback button */
.feedback-btn { display: flex; align-items: center; gap: 5px; background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3); color: #fff; padding: 6px 12px; border-radius: var(--radius-sm); cursor: pointer; font-size: 12px; font-weight: 600; transition: background 0.2s; white-space: nowrap; font-family: inherit; }
.feedback-btn:hover { background: rgba(255,255,255,0.25); }
.feedback-btn svg { width: 16px; height: 16px; fill: currentColor; }

/* RESPONSIVE */
@media (max-width: 1024px) {
    :root { --sidebar-width: 240px; --sidebar-collapsed: 72px; }
    .stats-row { gap: 12px; }
    .stat-card { padding: 16px; gap: 12px; }
    .stat-icon { width: 40px; height: 40px; }
    .stat-value { font-size: 24px; }
    .search-box { width: 200px; }
}

@media (max-width: 768px) {
    .mobile-menu-btn { display: flex; }
    .collapse-btn { display: none; }
    .sidebar-wrapper { position: fixed; left: -300px; top: 0; z-index: 999; transition: left 0.3s ease; }
    .sidebar-wrapper.mobile-open { left: 0; }
    .sidebar { width: 280px !important; height: 100vh; }
    .sidebar.collapsed .logo-text, .sidebar.collapsed .type-tab-text, .sidebar.collapsed .type-tab-count, .sidebar.collapsed .action-btn-text, .sidebar.collapsed .user-details, .sidebar.collapsed .contract-name, .sidebar.collapsed .contract-progress { display: block; }
    .sidebar.collapsed .type-tab, .sidebar.collapsed .action-btn { justify-content: flex-start; padding: 10px 12px; }
    .sidebar.collapsed .notification-badge { position: absolute; top: 6px; right: 6px; }
    .main-content-wrapper { padding: 12px; }
    .header { flex-wrap: wrap; gap: 12px; padding: 12px 16px; }
    .search-box { display: none; }
    .btn-new-ticket { width: 44px; padding: 0; border-radius: 50%; }
    .btn-new-ticket span { display: none; }
    .stats-row { grid-template-columns: repeat(2, 1fr); gap: 12px; }
    .status-tabs-row { grid-template-columns: 1fr; gap: 12px; }
    .status-tabs { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .status-tabs::-webkit-scrollbar { display: none; }
    .main-grid { grid-template-columns: 1fr; }
    .ticket-list-panel { display: flex; }
    .ticket-detail-panel { display: none; }
    .ticket-list-panel.hidden-mobile { display: none; }
    .ticket-detail-panel.active-mobile { display: flex; }
    .mobile-back-btn { display: flex; }
}

@media (max-width: 480px) {
    .header h1 { font-size: 18px; }
    .header-action-btn, .btn-new-ticket { width: 36px; height: 36px; }
    .stats-row { gap: 8px; }
    .stat-card { padding: 12px; gap: 8px; }
    .stat-icon { width: 36px; height: 36px; }
    .stat-icon svg { width: 18px; height: 18px; }
    .stat-value { font-size: 20px; }
    .stat-label { font-size: 11px; }
    .ticket-meta .ticket-priority { display: none; }
}

/* LEGACY COMPATIBILITY */
.container { display: contents; }
.contract-banner { display: none !important; }
.stats-bar { display: none; }
.ticket-type-tabs { display: none; }
.tabs { display: none; }
#mainContent { display: contents; }

    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay"><div class="loader"></div></div>
    <audio id="notificationSound" preload="auto"><source src="data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA//tQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAABhgC7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7//////////////////////////////////////////////////////////////////8AAAAATGF2YzU4LjEzAAAAAAAAAAAAAAAAJAAAAAAAAAAAAYYNjnFZAAAAAAAAAAAAAAAAAAAA" type="audio/mp3"></audio>
    <div class="mobile-overlay" id="mobileOverlay"><button class="mobile-close-btn" onclick="closeMobileMenu()"><svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button></div>

    <div class="app">
        <!-- Sidebar -->
        <div class="sidebar-wrapper" id="sidebarWrapper">
            <div class="sidebar" id="sidebar">
                <div class="sidebar-content">
                    <div class="logo-section">
                        <div class="logo"><img src="https://static.wixstatic.com/media/65ccc7_382b4222d3644830a86f3e629bfcfdcb~mv2.png" alt="Logo"></div>
                        <div class="logo-text"><div class="logo-title">Project Support Desk</div><div class="logo-subtitle">Tiny Panda Help Center</div></div>
                    </div>
                    <div class="contract-card" id="contractCard" style="display: none;">
                        <div class="contract-card-header">
                            <div class="contract-name" id="contractName">-</div>
                            <div class="contract-actions-mini">
                                <button class="contract-action-mini" id="rulesBtn" title="Rules"><svg viewBox="0 0 24 24"><path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm2 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg></button>
                                <button class="contract-action-mini" id="taskHistoryBtn" title="History"><svg viewBox="0 0 24 24"><path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/></svg></button>
                            </div>
                        </div>
                        <div class="contract-stats">
                            <div class="contract-stat"><div class="contract-stat-value" id="baseTasks">0</div><div class="contract-stat-label">Contracted</div></div>
                            <div class="contract-stat"><div class="contract-stat-value" id="adjustedTasks">0</div><div class="contract-stat-label">Available</div></div>
                        </div>
                        <div class="contract-progress" id="contractProgress"><div class="progress-track"><div class="progress-fill" id="monthlyProgressFill" style="width: 0%"></div></div><div class="progress-text"><span id="usedThisMonth">0</span> of <span id="monthlyLimit">0</span> used this month</div></div>
                    </div>
                    <div class="type-tabs" id="ticketTypeTabs">
                        <button class="type-tab active" data-type="all"><svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg><span class="type-tab-text">All Tickets</span><span class="type-tab-count" id="allTypeCount">0</span></button>
                        <button class="type-tab" data-type="support"><svg viewBox="0 0 24 24"><path d="M21 12.22C21 6.73 16.74 3 12 3c-4.69 0-9 3.65-9 9.28-.6.34-1 .98-1 1.72v2c0 1.1.9 2 2 2h1v-6.1c0-3.87 3.13-7 7-7s7 3.13 7 7V19h-8v2h8c1.1 0 2-.9 2-2v-1.22c.59-.31 1-.92 1-1.64v-2.3c0-.7-.41-1.31-1-1.62z"/></svg><span class="type-tab-text">Support</span><span class="type-tab-count" id="supportTypeCount">0</span></button>
                        <button class="type-tab" data-type="bug"><svg viewBox="0 0 24 24"><path d="M20 8h-2.81c-.45-.78-1.07-1.45-1.82-1.96L17 4.41 15.59 3l-2.17 2.17C12.96 5.06 12.49 5 12 5c-.49 0-.96.06-1.41.17L8.41 3 7 4.41l1.62 1.63C7.88 6.55 7.26 7.22 6.81 8H4v2h2.09c-.05.33-.09.66-.09 1v1H4v2h2v1c0 .34.04.67.09 1H4v2h2.81c1.04 1.79 2.97 3 5.19 3s4.15-1.21 5.19-3H20v-2h-2.09c.05-.33.09-.66.09-1v-1h2v-2h-2v-1c0-.34-.04-.67-.09-1H20V8zm-6 8h-4v-2h4v2zm0-4h-4v-2h4v2z"/></svg><span class="type-tab-text">Bugs</span><span class="type-tab-count" id="bugTypeCount">0</span></button>
                        <button class="type-tab" data-type="project"><svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-4 14h-2v-4H7V9h6V5h2v4h4v4h-4v4z"/></svg><span class="type-tab-text">Projects</span><span class="type-tab-count" id="projectTypeCount">0</span></button>
                        <button class="type-tab" data-type="referral"><svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg><span class="type-tab-text">Referrals</span><span class="type-tab-count" id="referralTypeCount">0</span></button>
                    </div>
                    <div class="quick-actions">
                        <button class="action-btn pacman-btn" id="pacmanBtn" title="Pacman"><img src="https://static.wixstatic.com/media/65ccc7_f7189439f1ce4ab89484375fc3c37273~mv2.png" alt="Pacman" style="width: 20px; height: 20px;"><span class="action-btn-text">Pacman</span></button>
                        <button class="action-btn" id="projectBtn" title="Project"><svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg><span class="action-btn-text">Project</span></button>
                        <button class="action-btn" id="brandingBtn" title="Branding Guide"><svg viewBox="0 0 24 24"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9c.83 0 1.5-.67 1.5-1.5 0-.39-.15-.74-.39-1.01-.23-.26-.38-.61-.38-.99 0-.83.67-1.5 1.5-1.5H16c2.76 0 5-2.24 5-5 0-4.42-4.03-8-9-8zm-5.5 9c-.83 0-1.5-.67-1.5-1.5S5.67 9 6.5 9 8 9.67 8 10.5 7.33 12 6.5 12zm3-4C8.67 8 8 7.33 8 6.5S8.67 5 9.5 5s1.5.67 1.5 1.5S10.33 8 9.5 8zm5 0c-.83 0-1.5-.67-1.5-1.5S13.67 5 14.5 5s1.5.67 1.5 1.5S15.33 8 14.5 8zm3 4c-.83 0-1.5-.67-1.5-1.5S16.67 9 17.5 9s1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/></svg><span class="action-btn-text">Branding</span></button>
                        <button class="action-btn" id="feedbackBtn" title="Feedback"><svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-7 12h-2v-2h2v2zm0-4h-2V6h2v4z"/></svg><span class="action-btn-text">Feedback</span></button>
                        <div class="notification-wrapper">
                            <button class="action-btn" id="notificationBtn" title="Notifications"><svg viewBox="0 0 24 24"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.89 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/></svg><span class="action-btn-text">Notifications</span><span class="notification-badge hidden" id="notificationBadge">0</span></button>
                            <div class="notification-popup" id="notificationPopup"><div class="notification-popup-header"><h3>Notifications</h3><div class="notification-popup-actions"><button class="notification-clear-btn" id="clearAllNotifications">Clear All</button><button class="notification-close-btn" id="closeNotificationPopup"><svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button></div></div><div class="notification-list" id="notificationList"><div class="notification-empty">No new notifications</div></div></div>
                        </div>
                    </div>
                </div>
                <div class="user-account">
                    <div class="user-account-inner">
                        <div class="user-avatar" id="userAvatar">?</div>
                        <div class="user-details"><div class="user-name" id="userName">Loading...</div><div class="user-email" id="userEmail"></div></div>
                        <div class="account-wrapper">
                            <button class="header-action-btn account-btn" id="accountBtn" title="Account" style="width: 32px; height: 32px; background: transparent;"><svg viewBox="0 0 24 24" style="width: 16px; height: 16px;"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg></button>
                            <div class="account-dropdown" id="accountDropdown"><div class="account-dropdown-header" id="accountUserName">Account</div><button class="account-dropdown-item" id="logoutBtn"><svg viewBox="0 0 24 24"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></svg>Logout</button></div>
                        </div>
                    </div>
                </div>
            </div>
            <button class="collapse-btn" id="collapseBtn" onclick="toggleSidebar()"></button>
        </div>

        <!-- Main Content -->
        <div class="main-content-wrapper">
            <header class="header">
                <div class="header-left">
                    <button class="mobile-menu-btn" onclick="toggleMobileMenu()"><svg viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></button>
                    <div class="header-title-section"><h1>Tickets <span class="live-indicator" id="liveIndicator" style="display: none;">Live</span></h1></div>
                </div>
                <div class="header-center" id="headerCenter" style="display: none;"><div class="company-branding"><img class="company-logo" id="companyLogo" src="" alt="Company Logo" style="display: none;"><span class="company-name-display" id="companyName"></span></div></div>
                <div class="header-right">
                    <div class="search-box"><svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg><input type="text" id="searchInput" placeholder="Search tickets..."></div>
                    <select class="filter-select" id="priorityFilter" style="height: 44px;"><option value="">All Priorities</option><option value="low">Low</option><option value="medium">Medium</option><option value="high">High</option><option value="urgent">Urgent</option></select>
                    <select class="filter-select" id="userFilter" style="display: none; height: 44px;"><option value="">All Users</option></select>
                    <select class="filter-select" id="companyFilter" style="display: none; height: 44px;"><option value="">All Companies</option></select>
                    <button class="btn-new-ticket" id="newTicketBtn"><svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg><span>New Ticket</span></button>
                </div>
            </header>

            <div class="profile-setup-banner" id="profileSetupBanner" style="display: none;"><div class="profile-setup-content"><div class="profile-setup-icon"><svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg></div><div class="profile-setup-text"><strong>Complete your profile</strong><span>Please enter your name and company to continue</span></div><div class="profile-setup-form"><input type="text" id="profileNameInput" placeholder="Your Name" class="profile-input"><input type="text" id="profileCompanyInput" placeholder="Company Name" class="profile-input"><button class="btn btn-primary" id="saveProfileBtn">Save Profile</button></div></div></div>
            <div class="access-denied" id="accessDenied" style="display: none;"><svg viewBox="0 0 24 24"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/></svg><h2>Access Denied</h2><p id="accessDeniedMessage">Your email is not registered in the system. Please contact the administrator.</p></div>

            <div class="content-area">
                <div class="stats-row" id="statsBar">
                    <div class="stat-card"><div class="stat-icon total"><svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg></div><div class="stat-info"><div class="stat-value" id="totalTickets">0</div><div class="stat-label">Total Tickets</div></div></div>
                    <div class="stat-card"><div class="stat-icon open"><svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 3c1.93 0 3.5 1.57 3.5 3.5S13.93 13 12 13s-3.5-1.57-3.5-3.5S10.07 6 12 6zm7 13H5v-.23c0-.62.28-1.2.76-1.58C7.47 15.82 9.64 15 12 15s4.53.82 6.24 2.19c.48.38.76.97.76 1.58V19z"/></svg></div><div class="stat-info"><div class="stat-value" id="openTickets">0</div><div class="stat-label">Open</div></div></div>
                    <div class="stat-card"><div class="stat-icon progress"><svg viewBox="0 0 24 24"><path d="M13 2.05v2.02c3.95.49 7 3.85 7 7.93 0 3.21-1.92 6-4.72 7.28L13 17v5h5l-1.22-1.22C19.91 19.07 22 15.76 22 12c0-5.18-3.95-9.45-9-9.95zM11 2.05C5.95 2.55 2 6.81 2 12c0 3.76 2.09 7.07 5.22 8.78L6 22h5v-5l-2.28 2.28C6.92 18 5 15.21 5 12c0-4.08 3.05-7.44 7-7.93V2.05z"/></svg></div><div class="stat-info"><div class="stat-value" id="inProgressTickets">0</div><div class="stat-label">In Progress</div></div></div>
                    <div class="stat-card"><div class="stat-icon resolved"><svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg></div><div class="stat-info"><div class="stat-value" id="resolvedTickets">0</div><div class="stat-label">Resolved</div></div></div>
                </div>

                <div class="status-tabs-row"><div class="status-tabs" id="statusTabs"><button class="status-tab active" data-tab="all">All</button><button class="status-tab" data-tab="open">Open</button><button class="status-tab" data-tab="in-progress">In Progress</button><button class="status-tab" data-tab="resolved">Resolved</button></div><div></div></div>

                <div class="main-grid" id="mainContent">
                    <div class="ticket-list-panel" id="ticketListPanel">
                        <div class="panel-header"><h2 class="panel-title" id="ticketPanelTitle">Your Tickets</h2></div>
                        <div class="ticket-list" id="ticketList"><div class="empty-state"><svg viewBox="0 0 24 24"><path d="M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm-1 12H5c-.55 0-1-.45-1-1V9c0-.55.45-1 1-1h14c.55 0 1 .45 1 1v8c0 .55-.45 1-1 1z"/></svg><h3>No tickets yet</h3><p>Create your first ticket to get started</p></div></div>
                    </div>
                    <button class="mobile-back-btn" id="backBtn" onclick="hideMobileDetail()"><svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>Back to Tickets</button>
                    <div class="ticket-detail-panel" id="ticketDetailPanel">
                        <div class="empty-state" id="noTicketSelected"><svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-7 12h-2v-2h2v2zm0-4h-2V6h2v4z"/></svg><h3>Select a ticket</h3><p>Choose a ticket from the list to view details</p></div>
                        <div class="ticket-detail-content" id="ticketDetailContent" style="display: none;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden legacy elements for JS compatibility -->
    <div class="contract-banner" id="contractBanner" style="display: none;"></div>
    <div id="contractMonthly" style="display: none;"></div>
    <div class="tabs" style="display: none;"></div>
    <div class="user-info" id="userInfo" style="display: none;"></div>

    <!-- New Ticket Modal -->
    <div class="modal-overlay" id="newTicketModal">
        <div class="modal">
            <div class="modal-header"><h2 class="modal-title">Create New Ticket</h2><button class="modal-close" id="closeModal"><svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button></div>
            <div class="modal-body">
                <form id="ticketForm">
                    <div class="form-group"><label class="form-label">Ticket Type</label><div class="ticket-type-selector" id="ticketTypeSelector"><div class="type-option selected" data-type="support"><svg viewBox="0 0 24 24"><path d="M21 12.22C21 6.73 16.74 3 12 3c-4.69 0-9 3.65-9 9.28-.6.34-1 .98-1 1.72v2c0 1.1.9 2 2 2h1v-6.1c0-3.87 3.13-7 7-7s7 3.13 7 7V19h-8v2h8c1.1 0 2-.9 2-2v-1.22c.59-.31 1-.92 1-1.64v-2.3c0-.7-.41-1.31-1-1.62z"/></svg><div class="type-option-title">Support</div><div class="type-option-desc">General help</div></div><div class="type-option" data-type="bug"><svg viewBox="0 0 24 24"><path d="M20 8h-2.81c-.45-.78-1.07-1.45-1.82-1.96L17 4.41 15.59 3l-2.17 2.17C12.96 5.06 12.49 5 12 5c-.49 0-.96.06-1.41.17L8.41 3 7 4.41l1.62 1.63C7.88 6.55 7.26 7.22 6.81 8H4v2h2.09c-.05.33-.09.66-.09 1v1H4v2h2v1c0 .34.04.67.09 1H4v2h2.81c1.04 1.79 2.97 3 5.19 3s4.15-1.21 5.19-3H20v-2h-2.09c.05-.33.09-.66.09-1v-1h2v-2h-2v-1c0-.34-.04-.67-.09-1H20V8zm-6 8h-4v-2h4v2zm0-4h-4v-2h4v2z"/></svg><div class="type-option-title">Bug Report</div><div class="type-option-desc">Something broken</div></div><div class="type-option" data-type="project"><svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-4 14h-2v-4H7V9h6V5h2v4h4v4h-4v4z"/></svg><div class="type-option-title">Project</div><div class="type-option-desc">New feature/build</div></div><div class="type-option" data-type="referral"><svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg><div class="type-option-title">Referral</div><div class="type-option-desc">Refer a company</div></div></div></div>
                    <div id="referralFieldsGroup" style="display: none;"><div class="form-group"><label class="form-label">Company Name <span class="required">*</span></label><input type="text" id="referralCompanyName" class="form-input" placeholder="Company name"><div class="field-error" id="referralCompanyError">Company name is required</div></div><div class="form-group"><label class="form-label">Contact Email <span class="required">*</span></label><input type="email" id="referralEmailAddress" class="form-input" placeholder="contact@company.com"><div class="field-error" id="referralEmailError">Valid email is required</div></div><div class="form-group"><label class="form-label">Phone Number</label><input type="text" id="referralPhoneNumber" class="form-input" placeholder="+44 123 456 7890"></div><div class="form-group"><label class="form-label">Additional Comments</label><textarea id="referralCommentText" class="form-textarea" style="min-height: 80px;" placeholder="Any additional information..."></textarea></div></div>
                    <div class="form-group" id="categoryFormGroup"><label class="form-label">Category</label><div class="category-grid" id="categoryGrid"><div class="category-card" data-category="general"><svg viewBox="0 0 24 24"><path d="M11 18h2v-2h-2v2zm1-16C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-14c-2.21 0-4 1.79-4 4h2c0-1.1.9-2 2-2s2 .9 2 2c0 2-3 1.75-3 5h2c0-2.25 3-2.5 3-5 0-2.21-1.79-4-4-4z"/></svg><div class="category-card-title">General Help</div></div><div class="category-card" data-category="billing"><svg viewBox="0 0 24 24"><path d="M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 14H4v-6h16v6zm0-10H4V6h16v2z"/></svg><div class="category-card-title">Plans & Billing</div></div><div class="category-card" data-category="payments"><svg viewBox="0 0 24 24"><path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"/></svg><div class="category-card-title">Payments</div></div><div class="category-card" data-category="marketing"><svg viewBox="0 0 24 24"><path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"/></svg><div class="category-card-title">Marketing & SEO</div></div><div class="category-card" data-category="stores"><svg viewBox="0 0 24 24"><path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/></svg><div class="category-card-title">Wix Stores</div></div><div class="category-card" data-category="memberships"><svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg><div class="category-card-title">Memberships & Events</div></div><div class="category-card" data-category="velo"><svg viewBox="0 0 24 24"><path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0l4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"/></svg><div class="category-card-title">Velo & CMS</div></div><div class="category-card" data-category="content"><svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg><div class="category-card-title">Content / Design</div></div></div></div>
                    <div class="form-group" id="subjectFormGroup"><label class="form-label">Subject <span class="required">*</span></label><input type="text" id="ticketSubject" class="form-input" placeholder="Brief description of your issue"><div class="field-error" id="subjectError">Subject is required (min 5 characters)</div></div>
                    <div class="form-group" id="descriptionFormGroup"><label class="form-label">Description <span class="required">*</span></label><textarea id="ticketDescription" class="form-textarea" placeholder="Please provide as much detail as possible..."></textarea><div class="field-error" id="descriptionError">Description is required (min 10 characters)</div></div>
                    <div class="form-group" id="priorityFormGroup"><label class="form-label">Priority</label><div class="priority-selector" id="prioritySelector"><div class="priority-option low" data-priority="low">Low</div><div class="priority-option medium selected" data-priority="medium">Medium</div><div class="priority-option high" data-priority="high">High</div><div class="priority-option urgent" data-priority="urgent">Urgent</div></div></div>
                    <div class="form-group" id="impactFormGroup"><label class="form-label">Business Impact</label><div class="impact-selector" id="impactSelector"><div class="impact-option none" data-impact="none">None</div><div class="impact-option minor" data-impact="minor">Minor</div><div class="impact-option moderate selected" data-impact="moderate">Moderate</div><div class="impact-option major" data-impact="major">Major</div><div class="impact-option critical" data-impact="critical">Critical</div></div></div>
                </form>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" id="cancelTicket">Cancel</button><button class="btn btn-primary" id="submitTicket"><span class="btn-text">Create Ticket</span><span class="btn-loader" style="display: none;"></span></button></div>
        </div>
    </div>

    <!-- Rules Popup -->
    <div class="rules-popup-overlay" id="rulesPopup"><div class="rules-popup-content"><div class="rules-popup-header"><h3>Contract Rules</h3><button class="rules-popup-close" id="closeRulesPopup"><svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button></div><div class="rules-popup-body" id="rulesPopupBody"></div></div></div>

    <!-- Task History Popup -->
    <div class="task-history-overlay" id="taskHistoryPopup"><div class="task-history-content"><div class="task-history-header"><h3>Task History</h3><button class="task-history-close" id="closeTaskHistoryPopup"><svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button></div><div class="task-history-body" id="taskHistoryPopupBody"><div style="text-align:center;padding:40px;color:var(--grey-500);">Loading task history...</div></div></div></div>

    <!-- Image Modal -->
    <div class="image-modal" id="imageModal"><img src="" alt="Full size image" id="imageModalImg"></div>

    <!-- Toast -->
    <div class="toast" id="toast"><span id="toastMessage"></span></div>

    <script>
    function toggleSidebar() { var s = document.getElementById('sidebar'), b = document.getElementById('collapseBtn'); s.classList.toggle('collapsed'); b.textContent = s.classList.contains('collapsed') ? '' : ''; }
    function toggleMobileMenu() { document.getElementById('sidebarWrapper').classList.add('mobile-open'); document.getElementById('mobileOverlay').classList.add('active'); }
    function closeMobileMenu() { document.getElementById('sidebarWrapper').classList.remove('mobile-open'); document.getElementById('mobileOverlay').classList.remove('active'); }
    function showMobileDetail() { if (window.innerWidth <= 768) { document.getElementById('ticketListPanel').classList.add('hidden-mobile'); document.getElementById('ticketDetailPanel').classList.add('active-mobile'); } }
    function hideMobileDetail() { document.getElementById('ticketListPanel').classList.remove('hidden-mobile'); document.getElementById('ticketDetailPanel').classList.remove('active-mobile'); }
    // Sync: when JS adds 'active' class to ticket detail panel, trigger mobile view
    new MutationObserver(function(mutations) { mutations.forEach(function(m) { if (m.attributeName === 'class') { var p = document.getElementById('ticketDetailPanel'); if (p && p.classList.contains('active')) showMobileDetail(); } }); }).observe(document.getElementById('ticketDetailPanel'), { attributes: true });
    function showContractCard() { document.getElementById('contractCard').style.display = 'block'; }
    // Sync: when JS adds 'visible' class to legacy contractBanner, also show sidebar contractCard
    new MutationObserver(function(mutations) { mutations.forEach(function(m) { if (m.attributeName === 'class') { var b = document.getElementById('contractBanner'); if (b && b.classList.contains('visible')) showContractCard(); } }); }).observe(document.getElementById('contractBanner'), { attributes: true });
    window.addEventListener('resize', function() { if (window.innerWidth > 768) { document.getElementById('ticketListPanel').classList.remove('hidden-mobile'); document.getElementById('ticketDetailPanel').classList.remove('active-mobile'); document.getElementById('sidebarWrapper').classList.remove('mobile-open'); document.getElementById('mobileOverlay').classList.remove('active'); } });
    </script>

    <!-- JavaScript -->
    <script>
// ==========================================
// HELPDESK UI SCRIPTS - helpdesk-scripts.js
// ==========================================

// ==========================================
// STATE MANAGEMENT
// ==========================================
const state = {
    user: null,
    profile: null,
    isAdmin: false,
    domain: null,
    tickets: [],
    users: [],
    companies: [],
    selectedTicket: null,
    selectedCategory: null,
    selectedPriority: 'medium',
    selectedImpact: 'moderate',
    selectedTicketType: 'support',
    currentStatusFilter: 'all',
    currentTypeFilter: 'all',
    searchQuery: '',
    priorityFilter: '',
    userFilter: '',
    companyFilter: '',
    pendingAttachment: null,
    contract: null,
    referrals: [],
    referralCount: 0,
    taskHistory: [],
    notificationCount: 0,
    unreadNotes: {},
    notifications: []
};

// ==========================================
// INITIALIZATION
// ==========================================
document.addEventListener('DOMContentLoaded', () => {
    window.parent.postMessage({ action: 'ready' }, '*');
    initEventListeners();
});

window.addEventListener('message', (event) => {
    const data = event.data;
    if (!data || !data.action) return;

    switch (data.action) {
        case 'setUser': handleSetUser(data); break;
        case 'setTickets': handleSetTickets(data); break;
        case 'accessDenied': showAccessDenied(data.message); break;
        case 'error': 
            showToast(data.message, 'error'); 
            document.getElementById('submitTicket').classList.remove('loading');
            break;
        case 'ticketCreated': handleTicketCreated(data); break;
        case 'noteAdded': handleNoteAdded(data); break;
        case 'statusUpdated': handleStatusUpdated(data); break;
        case 'ticketDeleted': handleTicketDeleted(data); break;
        case 'profileSaved': handleProfileSaved(data); break;
        case 'fileUploaded': handleFileUploaded(data); break;
        case 'uploadCancelled': state.pendingAttachment = null; updatePendingAttachmentUI(); break;
        case 'uploadError': showToast(data.message || 'Upload failed', 'error'); break;
        case 'showLiveIndicator': if (data.show) document.getElementById('liveIndicator').style.display = 'inline-flex'; break;
        case 'setContractInfo': handleContractInfo(data.contract); break;
        case 'setReferrals': handleSetReferrals(data); break;
        case 'setTaskHistory': handleSetTaskHistory(data); break;
        case 'referralAdded': showToast('Referral submitted! +' + data.tasksAdded + ' tasks added', 'success'); break;
        case 'ticketTypeUpdated': handleTicketTypeUpdated(data); break;
        case 'projectValueUpdated': handleProjectValueUpdated(data); break;
        case 'internalNotesUpdated': handleInternalNotesUpdated(data); break;
        case 'statusNoteDeleted': handleStatusNoteDeleted(data); break;
        case 'realtimeNoteAdded': handleRealtimeNoteAdded(data); break;
        case 'realtimeStatusUpdated': handleRealtimeStatusUpdated(data); break;
        case 'realtimeTicketCreated': handleRealtimeTicketCreated(data); break;
        case 'realtimeTicketDeleted': handleRealtimeTicketDeleted(data); break;
    }
});

// ==========================================
// HANDLERS
// ==========================================
function handleSetUser(data) {
    state.user = data.user;
    state.isAdmin = data.isAdmin;
    state.profile = data.profile;
    state.domain = data.domain;

    document.getElementById('loadingOverlay').classList.add('hidden');
    document.getElementById('userName').textContent = data.user.name || data.user.email;
    document.getElementById('userEmail').textContent = data.user.email;
    document.getElementById('userAvatar').textContent = (data.user.name || data.user.email).charAt(0).toUpperCase();
    document.getElementById('accountUserName').textContent = data.user.name || data.user.email;

    if (data.profile && data.profile.companyName) {
        document.getElementById('companyName').textContent = data.profile.companyName;
        document.getElementById('headerCenter').style.display = 'block';
        if (data.profile.image) {
            document.getElementById('companyLogo').src = data.profile.image;
            document.getElementById('companyLogo').style.display = 'block';
        }
    }

    if (!data.hasProfile && !data.isAdmin) {
        document.getElementById('profileSetupBanner').style.display = 'block';
    }

    if (data.isAdmin) {
        document.getElementById('userFilter').style.display = 'block';
        document.getElementById('companyFilter').style.display = 'block';
        document.getElementById('ticketPanelTitle').textContent = 'All Tickets';
    }
}

function handleSetTickets(data) {
    state.tickets = data.tickets || [];
    state.users = data.users || [];
    state.companies = data.companies || [];
    renderTickets();
    updateStats();
    updateTypeCounts();
    populateFilters();
}

function handleContractInfo(contract) {
    state.contract = contract;
    const banner = document.getElementById('contractBanner');
    if (contract) {
        document.getElementById('contractName').textContent = contract.contractName || '-';
        document.getElementById('baseTasks').textContent = contract.baseTasks || 0;
        document.getElementById('adjustedTasks').textContent = contract.adjustedTasks || 0;
        
        // Monthly usage display
        var tasksPerMonth = contract.tasksPerMonth || 0;
        var usedThisMonth = contract.usedThisMonth || 0;
        document.getElementById('usedThisMonth').textContent = usedThisMonth;
        document.getElementById('monthlyLimit').textContent = tasksPerMonth;
        
        var pct = tasksPerMonth > 0 ? Math.min((usedThisMonth / tasksPerMonth) * 100, 100) : 0;
        var fill = document.getElementById('monthlyProgressFill');
        fill.style.width = pct + '%';
        fill.className = 'monthly-progress-fill';
        if (pct >= 100) fill.classList.add('danger');
        else if (pct >= 80) fill.classList.add('warning');
        
        // Show/hide monthly bar
        document.getElementById('contractMonthly').style.display = tasksPerMonth > 0 ? 'flex' : 'none';
        
        banner.classList.add('visible');
        
        // Check if no tasks remaining  show warning if present
        var warningEl = document.getElementById('noTasksWarning');
        if (warningEl) {
            warningEl.style.display = (contract.adjustedTasks <= 0) ? 'flex' : 'none';
        }
    } else {
        banner.classList.remove('visible');
    }
}

function handleSetReferrals(data) {
    state.referrals = data.referrals || [];
    state.referralCount = data.count || 0;
}

function handleSetTaskHistory(data) {
    state.taskHistory = data.taskHistory || [];
    renderTaskHistory();
}

function handleTicketCreated(data) {
    document.getElementById('submitTicket').classList.remove('loading');
    state.tickets.unshift(data.ticket);
    renderTickets();
    updateStats();
    updateTypeCounts();
    closeModal();
    showToast('Ticket created successfully!', 'success');
    selectTicket(data.ticket._id);
}

function handleNoteAdded(data) {
    const ticket = state.tickets.find(t => t._id === data.ticketId);
    if (ticket) {
        if (!ticket.notes) ticket.notes = [];
        ticket.notes.push(data.note);
        if (state.selectedTicket && state.selectedTicket._id === data.ticketId) {
            state.selectedTicket = ticket;
            renderTicketDetail(ticket);
        }
    }
}

function handleStatusUpdated(data) {
    const ticket = state.tickets.find(t => t._id === data.ticketId);
    if (ticket) {
        ticket.status = data.status;
        renderTickets();
        updateStats();
        if (state.selectedTicket && state.selectedTicket._id === data.ticketId) {
            state.selectedTicket = ticket;
            renderTicketDetail(ticket);
        }
    }
}

function handleTicketDeleted(data) {
    state.tickets = state.tickets.filter(t => t._id !== data.ticketId);
    renderTickets();
    updateStats();
    updateTypeCounts();
    if (state.selectedTicket && state.selectedTicket._id === data.ticketId) {
        state.selectedTicket = null;
        document.getElementById('ticketDetailContent').style.display = 'none';
        document.getElementById('noTicketSelected').style.display = 'block';
    }
    showToast('Ticket deleted', 'success');
}

function handleProfileSaved(data) {
    state.profile = data.profile;
    document.getElementById('profileSetupBanner').style.display = 'none';
    if (data.profile.companyName) {
        document.getElementById('companyName').textContent = data.profile.companyName;
        document.getElementById('headerCenter').style.display = 'block';
    }
    showToast('Profile saved!', 'success');
}

function handleFileUploaded(data) {
    state.pendingAttachment = { url: data.url, type: data.fileType, filename: data.filename };
    updatePendingAttachmentUI();
}

function handleTicketTypeUpdated(data) {
    const ticket = state.tickets.find(t => t._id === data.ticketId);
    if (ticket) {
        ticket.ticketType = data.ticketType;
        renderTickets();
        updateTypeCounts();
        if (state.selectedTicket && state.selectedTicket._id === data.ticketId) {
            state.selectedTicket = ticket;
            renderTicketDetail(ticket);
        }
    }
    showToast('Ticket type updated', 'success');
}

function handleProjectValueUpdated(data) {
    const ticket = state.tickets.find(t => t._id === data.ticketId);
    if (ticket) {
        ticket.projectValue = data.projectValue;
        if (data.purchaseOrderReceived !== undefined) {
            ticket.purchaseOrderReceived = data.purchaseOrderReceived;
        }
        if (data.opportunityCategory !== undefined) {
            ticket.opportunityCategory = data.opportunityCategory;
            ticket.opportunityCategoryColour = data.opportunityCategoryColour || '';
        }
        renderTickets();
        if (state.selectedTicket && state.selectedTicket._id === data.ticketId) {
            state.selectedTicket = ticket;
            renderTicketDetail(ticket);
        }
    }
    showToast('Project value updated to ' + data.projectValue + (data.purchaseOrderReceived ? ' (PO received)' : ''), 'success');
}

function handleInternalNotesUpdated(data) {
    const ticket = state.tickets.find(t => t._id === data.ticketId);
    if (ticket) {
        ticket.internalNotes = data.internalNotes;
        if (state.selectedTicket && state.selectedTicket._id === data.ticketId) {
            state.selectedTicket = ticket;
            // Re-render the status notes list
            const notesList = document.getElementById('statusNotesList');
            if (notesList) {
                notesList.innerHTML = renderStatusNotes(data.internalNotes, state.isAdmin);
            }
        }
    }
    // Remove loader and clear input
    const saveBtn = document.getElementById('saveInternalNotes');
    if (saveBtn) saveBtn.classList.remove('loading');
    const input = document.getElementById('internalNotesInput');
    if (input) input.value = '';
    
    showToast('Status note saved', 'success');
}

function handleStatusNoteDeleted(data) {
    const ticket = state.tickets.find(t => t._id === data.ticketId);
    if (ticket) {
        ticket.internalNotes = data.internalNotes;
        if (state.selectedTicket && state.selectedTicket._id === data.ticketId) {
            state.selectedTicket = ticket;
            const notesList = document.getElementById('statusNotesList');
            if (notesList) {
                notesList.innerHTML = renderStatusNotes(data.internalNotes, state.isAdmin);
            }
        }
    }
    showToast('Status note deleted', 'success');
}

function handleRealtimeNoteAdded(data) {
    const ticket = state.tickets.find(t => t._id === data.ticketId);
    if (ticket) {
        if (!ticket.notes) ticket.notes = [];
        const noteExists = ticket.notes.some(n => n.id === data.note.id);
        if (!noteExists) {
            ticket.notes.push(data.note);
            if (state.selectedTicket && state.selectedTicket._id === data.ticketId) {
                state.selectedTicket = ticket;
                renderTicketDetail(ticket);
            } else {
                incrementNotifications(data.ticketId, data.note);
            }
        }
    }
}

function handleRealtimeStatusUpdated(data) {
    handleStatusUpdated(data);
}

function handleRealtimeTicketCreated(data) {
    if (data.ticket && !state.tickets.find(t => t._id === data.ticket._id)) {
        state.tickets.unshift(data.ticket);
        renderTickets();
        updateStats();
        updateTypeCounts();
    }
}

function handleRealtimeTicketDeleted(data) {
    handleTicketDeleted(data);
}

// ==========================================
// NOTIFICATIONS
// ==========================================
function incrementNotifications(ticketId, noteData) {
    if (!state.unreadNotes[ticketId]) state.unreadNotes[ticketId] = 0;
    state.unreadNotes[ticketId]++;
    
    // Find ticket info
    const ticket = state.tickets.find(t => t._id === ticketId);
    
    // Add to notifications array
    state.notifications.unshift({
        ticketId: ticketId,
        ticketNumber: ticket ? ticket.ticketNumber : 'Unknown',
        ticketSubject: ticket ? ticket.subject : 'Unknown Ticket',
        author: noteData ? noteData.author : 'Support Team',
        message: noteData ? (noteData.content || 'Sent an attachment') : 'New message',
        date: new Date().toISOString()
    });
    
    updateNotificationBadge();
    renderNotificationPopup();
    playNotificationSound();
    document.getElementById('notificationBtn').classList.add('bell-ringing');
    setTimeout(() => document.getElementById('notificationBtn').classList.remove('bell-ringing'), 500);
    
    // Fire event to widget
    window.parent.postMessage({ 
        action: 'notificationReceived', 
        ticketId: ticketId, 
        totalCount: state.notificationCount 
    }, '*');
}

function updateNotificationBadge() {
    const total = Object.values(state.unreadNotes).reduce((a, b) => a + b, 0);
    state.notificationCount = total;
    const badge = document.getElementById('notificationBadge');
    badge.textContent = total;
    badge.classList.toggle('hidden', total === 0);
}

function clearNotificationsForTicket(ticketId) {
    if (state.unreadNotes[ticketId]) {
        delete state.unreadNotes[ticketId];
        // Remove notifications for this ticket
        state.notifications = state.notifications.filter(n => n.ticketId !== ticketId);
        updateNotificationBadge();
        renderNotificationPopup();
    }
}

function toggleNotificationPopup(e) {
    e.preventDefault();
    e.stopPropagation();
    const popup = document.getElementById('notificationPopup');
    const wrapper = popup.parentElement;
    popup.classList.toggle('active');
    wrapper.classList.toggle('mobile-open', popup.classList.contains('active'));
    console.log('Notification popup toggled:', popup.classList.contains('active'));
}

function closeNotificationPopup() {
    document.getElementById('notificationPopup').classList.remove('active');
    document.querySelector('.notification-wrapper').classList.remove('mobile-open');
}

function renderNotificationPopup() {
    const container = document.getElementById('notificationList');
    if (!container) return;
    
    if (state.notifications.length === 0) {
        container.innerHTML = '<div class="notification-empty">No new notifications</div>';
        return;
    }
    
    container.innerHTML = state.notifications.map((notif, index) => 
        '<div class="notification-item" data-ticket-id="' + notif.ticketId + '" data-index="' + index + '">' +
            '<div class="notification-item-header">' +
                '<span class="notification-ticket">#' + formatTicketNumber(notif.ticketNumber) + '</span>' +
                '<span class="notification-time">' + formatFullDateTime(notif.date) + '</span>' +
            '</div>' +
            '<div class="notification-subject">' + notif.ticketSubject + '</div>' +
            '<div class="notification-message"><strong>' + notif.author + ':</strong> ' + truncateText(notif.message, 50) + '</div>' +
        '</div>'
    ).join('');
    
    // Add click handlers
    container.querySelectorAll('.notification-item').forEach(item => {
        item.addEventListener('click', () => {
            const ticketId = item.dataset.ticketId;
            selectTicket(ticketId);
            closeNotificationPopup();
        });
    });
}

function truncateText(text, maxLength) {
    if (!text) return '';
    if (text.length <= maxLength) return text;
    return text.substring(0, maxLength) + '...';
}

function clearAllNotifications() {
    state.notifications = [];
    state.unreadNotes = {};
    updateNotificationBadge();
    renderNotificationPopup();
}

function playNotificationSound() {
    try {
        const audio = document.getElementById('notificationSound');
        audio.currentTime = 0;
        audio.play().catch(() => {});
    } catch (e) { /* ignore */ }
}

// ==========================================
// RENDERING
// ==========================================
function renderTickets() {
    const container = document.getElementById('ticketList');
    let filtered = state.tickets.filter(ticket => {
        if (state.currentStatusFilter !== 'all' && ticket.status !== state.currentStatusFilter) return false;
        if (state.currentTypeFilter !== 'all' && (ticket.ticketType || 'support') !== state.currentTypeFilter) return false;
        if (state.searchQuery) {
            const q = state.searchQuery.toLowerCase();
            if (!ticket.subject.toLowerCase().includes(q) && 
                !ticket.ticketNumber.toLowerCase().includes(q) && 
                !(ticket.description || '').toLowerCase().includes(q)) return false;
        }
        if (state.priorityFilter && ticket.priority !== state.priorityFilter) return false;
        if (state.userFilter && ticket.userEmail !== state.userFilter) return false;
        if (state.companyFilter && ticket.domain !== state.companyFilter) return false;
        return true;
    });

    if (filtered.length === 0) {
        container.innerHTML = '<div class="empty-state"><svg viewBox="0 0 24 24"><path d="M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm-1 12H5c-.55 0-1-.45-1-1V9c0-.55.45-1 1-1h14c.55 0 1 .45 1 1v8c0 .55-.45 1-1 1z"/></svg><h3>No tickets found</h3><p>Try adjusting your filters</p></div>';
        return;
    }

    container.innerHTML = filtered.map(ticket => {
        const ticketType = ticket.ticketType || 'support';
        const typeLabel = ticketType.charAt(0).toUpperCase() + ticketType.slice(1);
        const unread = state.unreadNotes[ticket._id] || 0;
        return '<div class="ticket-item ' + (state.selectedTicket && state.selectedTicket._id === ticket._id ? 'active' : '') + '" data-id="' + ticket._id + '">' +
            '<div class="ticket-item-header">' +
                '<div class="ticket-number-block">' +
                    '<span class="ticket-number">#' + formatTicketNumber(ticket.ticketNumber) + (unread > 0 ? ' <span style="color:#f44336;font-weight:bold;">(' + unread + ' new)</span>' : '') + '</span>' +
                    '<span class="ticket-datetime">' + formatFullDateTime(ticket._createdDate) + '</span>' +
                '</div>' +
                '<span class="ticket-status ' + ticket.status + '">' + formatStatus(ticket.status) + '</span>' +
            '</div>' +
            '<div class="ticket-subject">' + ticket.subject + '<span class="ticket-type-badge type-' + ticketType + '">' + typeLabel + '</span></div>' +
            (ticketType === 'project' && ticket.projectValue ? '<div class="project-value-display">' + ticket.projectValue.toLocaleString() + '</div>' : '') +
            (ticketType === 'referral' && ticket.projectValue && state.isAdmin ? '<div class="project-value-display" style="color:var(--type-referral);">' + ticket.projectValue.toLocaleString() + '</div>' : '') +
            (ticketType === 'referral' && ticket.opportunityCategory && !state.isAdmin ? '<div class="project-value-display">' + renderOpportunityBadge(ticket) + '</div>' : '') +
            '<div class="ticket-meta">' +
                '<span class="ticket-priority"><span class="priority-dot ' + ticket.priority + '"></span> ' + ticket.priority + '</span>' +
                '<span>' + formatDate(ticket._createdDate) + '</span>' +
                (state.isAdmin ? '<span>' + (ticket.userName || ticket.userEmail) + '</span>' : '') +
            '</div>' +
        '</div>';
    }).join('');

    container.querySelectorAll('.ticket-item').forEach(item => {
        item.addEventListener('click', () => selectTicket(item.dataset.id));
    });
}

function renderTicketDetail(ticket) {
    const container = document.getElementById('ticketDetailContent');
    const ticketType = ticket.ticketType || 'support';
    const isLocked = (ticket.status === 'resolved' || ticket.status === 'closed') && !state.isAdmin;

    let adminTypeSection = '';
    if (state.isAdmin) {
        adminTypeSection = '<div class="admin-type-section visible">' +
            '<h4>Change Ticket Type</h4>' +
            '<div class="admin-type-selector">' +
                '<button class="admin-type-btn ' + (ticketType === 'support' ? 'active' : '') + '" data-type="support" onclick="changeTicketType(\'' + ticket._id + '\', \'support\')">Support</button>' +
                '<button class="admin-type-btn ' + (ticketType === 'bug' ? 'active' : '') + '" data-type="bug" onclick="changeTicketType(\'' + ticket._id + '\', \'bug\')">Bug</button>' +
                '<button class="admin-type-btn ' + (ticketType === 'project' ? 'active' : '') + '" data-type="project" onclick="changeTicketType(\'' + ticket._id + '\', \'project\')">Project</button>' +
                '<button class="admin-type-btn ' + (ticketType === 'referral' ? 'active' : '') + '" data-type="referral" onclick="changeTicketType(\'' + ticket._id + '\', \'referral\')">Referral</button>' +
            '</div>' +
            '<div class="project-value-section ' + (ticketType === 'project' || ticketType === 'referral' ? 'visible' : '') + '">' +
                '<div class="project-value-label">Project Value</div>' +
                '<div class="project-value-input-wrapper">' +
                    '<span class="project-value-prefix"></span>' +
                    '<input type="number" class="project-value-input" id="projectValueInput" value="' + (ticket.projectValue || 0) + '" min="0" step="100">' +
                '</div>' +
                '<label class="po-checkbox-wrapper">' +
                    '<input type="checkbox" class="po-checkbox" id="poReceivedCheckbox" ' + (ticket.purchaseOrderReceived ? 'checked' : '') + '>' +
                    '<span class="po-checkbox-text">Purchase Order Received</span>' +
                '</label>' +
                '<button class="project-value-save-btn project-value-save-full" onclick="saveProjectValue(\'' + ticket._id + '\')">Save</button>' +
                (ticketType === 'referral' ? '<div class="project-value-info">Every 1,000 = 1 extra task (capped at 5,000). Tasks allocated when PO received.</div>' : '<div class="project-value-info">Every 1,000 = 5 extra tasks. Tasks allocated when PO received.</div>') +
            '</div>' +
        '</div>';
    }

    container.innerHTML = '<button class="btn btn-secondary" onclick="closeDetail()" style="margin-bottom: 16px; display: none;" id="backBtn">' +
        '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>Back</button>' +
        '<div class="detail-header">' +
            '<h2 class="detail-title">' + ticket.subject + '</h2>' +
            '<div class="detail-meta">' +
                '<span class="detail-meta-item"><svg viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>' + formatDate(ticket._createdDate) + '</span>' +
                '<span class="detail-meta-item"><svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>' + (ticket.userName || ticket.userEmail) + '</span>' +
                '<span class="ticket-type-badge type-' + ticketType + '">' + ticketType.charAt(0).toUpperCase() + ticketType.slice(1) + '</span>' +
                (isLocked ? '<span class="ticket-locked-badge" title="This ticket is resolved and read-only"><svg viewBox="0 0 24 24"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/></svg></span>' : '') +
            '</div>' +
        '</div>' +
        '<div class="detail-section"><h3 class="detail-section-title">Description</h3><div class="detail-description">' + ticket.description + '</div></div>' +
        '<div class="detail-section"><h3 class="detail-section-title">Details</h3>' +
            '<div class="detail-info-grid">' +
                '<div class="detail-info-item"><div class="detail-info-label">Ticket Number</div><div class="detail-info-value">#' + formatTicketNumber(ticket.ticketNumber) + '</div></div>' +
                '<div class="detail-info-item"><div class="detail-info-label">Status</div><div class="detail-info-value"><span class="ticket-status ' + ticket.status + '">' + formatStatus(ticket.status) + '</span></div></div>' +
                '<div class="detail-info-item"><div class="detail-info-label">Priority</div><div class="detail-info-value"><span class="ticket-priority"><span class="priority-dot ' + ticket.priority + '"></span> ' + ticket.priority.charAt(0).toUpperCase() + ticket.priority.slice(1) + '</span></div></div>' +
                '<div class="detail-info-item"><div class="detail-info-label">Category</div><div class="detail-info-value">' + (ticket.customCategory || formatCategory(ticket.category)) + '</div></div>' +
                '<div class="detail-info-item"><div class="detail-info-label">Business Impact</div><div class="detail-info-value">' + ((ticket.businessImpact || 'moderate').charAt(0).toUpperCase() + (ticket.businessImpact || 'moderate').slice(1)) + '</div></div>' +
                (ticketType === 'project' && ticket.projectValue ? '<div class="detail-info-item"><div class="detail-info-label">Project Value</div><div class="detail-info-value" style="color:var(--type-project);font-weight:600;">' + ticket.projectValue.toLocaleString() + '</div></div>' : '') +
                (ticketType === 'referral' && ticket.projectValue && state.isAdmin ? '<div class="detail-info-item"><div class="detail-info-label">Project Value</div><div class="detail-info-value" style="color:var(--type-referral);font-weight:600;">' + ticket.projectValue.toLocaleString() + '</div></div>' : '') +
                (ticketType === 'referral' && ticket.opportunityCategory && !state.isAdmin ? '<div class="detail-info-item"><div class="detail-info-label">Opportunity</div><div class="detail-info-value">' + renderOpportunityBadge(ticket) + '</div></div>' : '') +
                ((ticketType === 'project' || ticketType === 'referral') && ticket.projectValue && state.isAdmin ? '<div class="detail-info-item"><div class="detail-info-label">PO Status</div><div class="detail-info-value"><span class="po-status-badge ' + (ticket.purchaseOrderReceived ? 'received' : 'pending') + '">' + (ticket.purchaseOrderReceived ? ' PO Received' : ' Awaiting PO') + '</span></div></div>' : '') +
                (ticketType === 'referral' && ticket.companyReferred ? '<div class="detail-info-item"><div class="detail-info-label">Company Referred</div><div class="detail-info-value">' + ticket.companyReferred + '</div></div>' : '') +
                (ticketType === 'referral' && ticket.referralEmail ? '<div class="detail-info-item"><div class="detail-info-label">Referral Contact</div><div class="detail-info-value">' + ticket.referralEmail + '</div></div>' : '') +
            '</div>' +
        '</div>' +
        (state.isAdmin ? '<div class="detail-section"><h3 class="detail-section-title">Update Status</h3>' +
            '<div class="status-actions">' +
                ['open', 'in-progress', 'awaiting-response', 'resolved', 'closed'].map(s => '<button class="status-btn ' + (ticket.status === s ? 'active' : '') + '" data-status="' + s + '">' + formatStatus(s) + '</button>').join('') +
            '</div>' + adminTypeSection + '</div>' +
            '<div class="detail-section"><button class="btn btn-danger" onclick="deleteTicket(\'' + ticket._id + '\')">' +
                '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>Delete Ticket</button></div>' : '') +
        '<div class="detail-section status-notes-section">' +
            '<h3 class="detail-section-title">Status Notes</h3>' +
            '<div class="status-notes-list" id="statusNotesList">' + renderStatusNotes(ticket.internalNotes, state.isAdmin) + '</div>' +
            (state.isAdmin ? '<div class="internal-notes-input-wrapper">' +
                '<textarea class="internal-notes-textarea" id="internalNotesInput" placeholder="Add a new status note..."></textarea>' +
                '<button class="btn btn-primary" id="saveInternalNotes" onclick="addStatusNote(\'' + ticket._id + '\')">' +
                    '<span class="btn-text">Add Note</span>' +
                    '<span class="btn-loader" style="display: none;"></span>' +
                '</button>' +
            '</div>' : '') +
        '</div>' +
        '<div class="notes-section"><h3 class="detail-section-title">Messages</h3>' +
            '<div class="notes-container" id="notesContainer">' + renderNotes(ticket.notes || []) + '</div>' +
            (isLocked ? '<div class="ticket-locked-banner"><svg viewBox="0 0 24 24"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/></svg><span>This ticket has been resolved</span></div>' :
            '<div id="pendingAttachmentContainer"></div>' +
            '<div class="note-input-container">' +
                '<div class="note-input-wrapper">' +
                    '<div class="note-input-actions">' +
                        '<button class="note-action-btn" id="attachBtn" title="Attach file">' +
                            '<svg viewBox="0 0 24 24"><path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5c0-1.38 1.12-2.5 2.5-2.5s2.5 1.12 2.5 2.5v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z"/></svg>' +
                        '</button>' +
                    '</div>' +
                    '<textarea class="note-textarea" id="noteInput" placeholder="Type a message..." rows="1"></textarea>' +
                '</div>' +
                '<button class="note-send-btn" id="sendNoteBtn">' +
                    '<svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>' +
                '</button>' +
            '</div>') +
        '</div>';

    container.style.display = 'block';
    document.getElementById('noTicketSelected').style.display = 'none';

    if (window.innerWidth <= 900) {
        document.getElementById('ticketDetailPanel').classList.add('active');
        document.getElementById('backBtn').style.display = 'inline-flex';
    }

    container.querySelectorAll('.status-btn').forEach(btn => {
        btn.addEventListener('click', () => updateStatus(ticket._id, btn.dataset.status));
    });

    const attachBtn = document.getElementById('attachBtn');
    const sendNoteBtn = document.getElementById('sendNoteBtn');
    const noteInput = document.getElementById('noteInput');
    
    if (attachBtn) {
        attachBtn.addEventListener('click', () => {
            window.parent.postMessage({ action: 'requestUpload' }, '*');
        });
    }

    if (sendNoteBtn) {
        sendNoteBtn.addEventListener('click', () => sendNote(ticket._id));
    }
    
    if (noteInput) {
        noteInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendNote(ticket._id);
            }
        });
    }

    updatePendingAttachmentUI();
    scrollNotesToBottom();
    initMediaPlayers();
}

function renderNotes(notes) {
    if (!notes || notes.length === 0) {
        return '<div style="text-align:center;color:var(--grey-500);padding:40px;">No messages yet</div>';
    }

    return notes.map(note => {
        const isSent = note.author === 'Support Team' ? state.isAdmin : !state.isAdmin;
        let attachmentHtml = '';

        if (note.attachment) {
            const att = note.attachment;
            // Detect actual type  fallback from URL if type is wrong
            var mediaType = att.type || 'document';
            if (att.url && att.url.indexOf('video.wixstatic.com') !== -1) mediaType = 'video';
            if (mediaType === 'image' && att.filename) {
                var ext = att.filename.split('.').pop().toLowerCase();
                if (['mp4','webm','mov','avi','mkv','m4v'].indexOf(ext) !== -1) mediaType = 'video';
                if (['mp3','wav','ogg','aac','m4a','flac','wma'].indexOf(ext) !== -1) mediaType = 'audio';
            }
            
            var pid = 'player-' + (note.id || Math.random().toString(36).slice(2));
            
            if (mediaType === 'image') {
                attachmentHtml = '<div class="note-attachment"><img src="' + att.url + '" alt="' + att.filename + '" onclick="openImageModal(\'' + att.url + '\')"></div>';
            } else if (mediaType === 'video') {
                attachmentHtml = '<div class="note-attachment"><div class="media-player video-player" id="' + pid + '">' +
                    '<div class="video-wrapper">' +
                        '<video preload="metadata" playsinline>' +
                            '<source src="' + att.url + '" type="video/mp4">' +
                        '</video>' +
                        '<div class="video-play-overlay" onclick="toggleMediaPlay(\'' + pid + '\')">' +
                            '<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>' +
                        '</div>' +
                    '</div>' +
                    '<div class="media-controls">' +
                        '<button class="media-btn play-btn" onclick="toggleMediaPlay(\'' + pid + '\')">' +
                            '<svg class="icon-play" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>' +
                            '<svg class="icon-pause" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>' +
                        '</button>' +
                        '<div class="media-progress" onclick="seekMedia(event, \'' + pid + '\')">' +
                            '<div class="media-progress-fill"></div>' +
                        '</div>' +
                        '<span class="media-time">0:00 / 0:00</span>' +
                        '<button class="media-btn fullscreen-btn" onclick="toggleFullscreen(\'' + pid + '\')">' +
                            '<svg viewBox="0 0 24 24"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg>' +
                        '</button>' +
                    '</div>' +
                    '<div class="media-filename">' + (att.filename || 'Video') + '</div>' +
                '</div></div>';
            } else if (mediaType === 'audio') {
                attachmentHtml = '<div class="note-attachment"><div class="media-player audio-player" id="' + pid + '" data-audio-url="' + att.url + '">' +
                    '<div class="media-controls">' +
                        '<button class="media-btn play-btn" onclick="toggleMediaPlay(\'' + pid + '\')">' +
                            '<svg class="icon-play" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>' +
                            '<svg class="icon-pause" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>' +
                        '</button>' +
                        '<div class="media-progress" onclick="seekMedia(event, \'' + pid + '\')">' +
                            '<div class="media-progress-fill"></div>' +
                        '</div>' +
                        '<span class="media-time">0:00 / 0:00</span>' +
                        '<button class="media-btn volume-btn" onclick="toggleMute(\'' + pid + '\')">' +
                            '<svg class="icon-vol-on" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>' +
                            '<svg class="icon-vol-off" viewBox="0 0 24 24"><path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/></svg>' +
                        '</button>' +
                    '</div>' +
                    '<div class="media-filename"><svg viewBox="0 0 24 24" style="width:14px;height:14px;fill:currentColor;"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55C7.79 13 6 14.79 6 17s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg> ' + (att.filename || 'Audio') + '</div>' +
                '</div></div>';
            } else {
                attachmentHtml = '<div class="note-attachment"><a href="' + att.url + '" target="_blank" class="note-attachment-doc"><svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg><span>' + att.filename + '</span></a></div>';
            }
        }

        return '<div class="note-bubble ' + (isSent ? 'sent' : 'received') + '">' +
            (!isSent ? '<div class="note-author">' + note.author + '</div>' : '') +
            (note.content ? '<div class="note-content">' + note.content + '</div>' : '') +
            attachmentHtml +
            '<div class="note-time">' + formatTime(note.date) + '</div>' +
        '</div>';
    }).join('');
}

function renderReferralList() {
    // Legacy - referrals now shown as ticket type
}

// ==========================================
// RULES POPUP
// ==========================================
function openRulesPopup() {
    const contract = state.contract;
    if (!contract) return;

    const maxTasksPerMonth = Math.round(contract.tasksPerMonth || Math.floor((contract.baseTasks || 0) / 12));
    const body = document.getElementById('rulesPopupBody');

    const hoursPerMonth = Math.round(maxTasksPerMonth * 2.4 * 10) / 10;

    body.innerHTML = '<div class="rules-highlight-row">' +
            '<div class="rules-highlight">' +
                '<div class="rules-highlight-number">' + maxTasksPerMonth + '</div>' +
                '<div class="rules-highlight-label">Max tasks per calendar month</div>' +
            '</div>' +
            '<div class="rules-highlight">' +
                '<div class="rules-highlight-number">' + hoursPerMonth + '</div>' +
                '<div class="rules-highlight-label">Max hours per calendar month</div>' +
            '</div>' +
        '</div>' +
        '<ul class="rules-list">' +
            '<li><svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>' +
                '<span>All tasks requested must fit within the <strong>' + hoursPerMonth + '-hour limit</strong>.</span></li>' +
            '<li><svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>' +
                '<span>Tasks or hours unused within a calendar month <strong>do not accumulate or roll over</strong> to the subsequent month.</span></li>' +
            '<li><svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>' +
                '<span>Average task duration: <strong>2.4 hours</strong></span></li>' +
            '<li><svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>' +
                '<span>Earn extra tasks by referring businesses  qualified referrals with a purchase order <strong>add bonus tasks</strong> based on project size.</span></li>' +
        '</ul>';

    document.getElementById('rulesPopup').classList.add('active');
}

function closeRulesPopup() {
    document.getElementById('rulesPopup').classList.remove('active');
}

// ==========================================
// TASK HISTORY POPUP
// ==========================================
function openTaskHistoryPopup() {
    document.getElementById('taskHistoryPopup').classList.add('active');
    document.getElementById('taskHistoryPopupBody').innerHTML = '<div style="text-align:center;padding:40px;color:var(--grey-500);">Loading task history...</div>';
    window.parent.postMessage({ action: 'getTaskHistory' }, '*');
}

function closeTaskHistoryPopup() {
    document.getElementById('taskHistoryPopup').classList.remove('active');
}

function renderTaskHistory() {
    const container = document.getElementById('taskHistoryPopupBody');
    const history = state.taskHistory;

    if (!history || history.length === 0) {
        container.innerHTML = '<div class="task-history-empty">No task history found</div>';
        return;
    }

    // Summary stats
    const totalTasks = history.length;
    const totalValue = history.reduce(function(sum, h) { return sum + (h.taskValue || 0); }, 0);
    const support = history.filter(function(h) { return h.taskType === 'SUPPORT'; }).length;
    const bugs = history.filter(function(h) { return h.taskType === 'BUG'; }).length;
    const projects = history.filter(function(h) { return h.taskType === 'PROJECT'; }).length;
    const referrals = history.filter(function(h) { return h.taskType === 'REFERRAL'; }).length;

    var html = '<div class="task-history-summary">' +
        '<div class="task-history-stat"><div class="task-history-stat-value">' + totalTasks + '</div><div class="task-history-stat-label">Total Entries</div></div>' +
        '<div class="task-history-stat"><div class="task-history-stat-value">' + totalValue.toFixed(1) + '</div><div class="task-history-stat-label">Net Task Value</div></div>' +
        '<div class="task-history-stat"><div class="task-history-stat-value">' + support + '</div><div class="task-history-stat-label">Support</div></div>' +
        '<div class="task-history-stat"><div class="task-history-stat-value">' + bugs + '</div><div class="task-history-stat-label">Bugs</div></div>' +
        '<div class="task-history-stat"><div class="task-history-stat-value">' + projects + '</div><div class="task-history-stat-label">Projects</div></div>' +
        '<div class="task-history-stat"><div class="task-history-stat-value">' + referrals + '</div><div class="task-history-stat-label">Referrals</div></div>' +
    '</div>';

    html += '<table class="task-history-table"><thead><tr>' +
        '<th>Date</th><th>Type</th><th>Ticket</th><th>Description</th><th>Task Value</th>' +
    '</tr></thead><tbody>';

    history.forEach(function(item) {
        var valueDisplay = item.taskValue || 0;
        var valueStyle = 'font-weight:600;text-align:center;';
        if (valueDisplay < 0) valueStyle += 'color:#c62828;';
        else if (valueDisplay > 0) valueStyle += 'color:#2e7d32;';
        
        html += '<tr>' +
            '<td>' + formatFullDateTime(item.taskCreatedDate) + '</td>' +
            '<td><span class="task-history-type-badge ' + (item.taskType || '') + '">' + (item.taskType || '-') + '</span></td>' +
            '<td>' + (item.ticketNumber ? '#' + formatTicketNumber(item.ticketNumber) : '-') + '</td>' +
            '<td>' + (item.description || '-') + '</td>' +
            '<td style="' + valueStyle + '">' + (valueDisplay > 0 ? '+' : '') + valueDisplay + '</td>' +
        '</tr>';
    });

    html += '</tbody></table>';
    container.innerHTML = html;
}

// ==========================================
// ACTIONS
// ==========================================
function selectTicket(id) {
    const ticket = state.tickets.find(t => t._id === id);
    if (ticket) {
        state.selectedTicket = ticket;
        clearNotificationsForTicket(id);
        renderTickets();
        renderTicketDetail(ticket);
        
        // Scroll the ticket into view in the list
        setTimeout(() => {
            const ticketElement = document.querySelector('.ticket-item[data-id="' + id + '"]');
            if (ticketElement) {
                ticketElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }, 50);
    }
}

function closeDetail() {
    document.getElementById('ticketDetailPanel').classList.remove('active');
}

function sendNote(ticketId) {
    const input = document.getElementById('noteInput');
    const content = input.value.trim();

    if (!content && !state.pendingAttachment) return;

    const noteData = { action: 'addNote', ticketId: ticketId, content: content, ticket: state.selectedTicket };
    if (state.pendingAttachment) {
        noteData.attachment = state.pendingAttachment;
    }

    window.parent.postMessage(noteData, '*');
    input.value = '';
    state.pendingAttachment = null;
    updatePendingAttachmentUI();
}

function updateStatus(ticketId, status) {
    window.parent.postMessage({ action: 'updateStatus', ticketId: ticketId, status: status }, '*');
}

function deleteTicket(ticketId) {
    if (confirm('Are you sure you want to delete this ticket?')) {
        window.parent.postMessage({ action: 'deleteTicket', ticketId: ticketId }, '*');
    }
}

function changeTicketType(ticketId, newType) {
    window.parent.postMessage({ action: 'updateTicketType', ticketId: ticketId, ticketType: newType }, '*');
}

function saveProjectValue(ticketId) {
    const input = document.getElementById('projectValueInput');
    const value = parseFloat(input.value) || 0;
    const poCheckbox = document.getElementById('poReceivedCheckbox');
    const purchaseOrderReceived = poCheckbox ? poCheckbox.checked : false;
    var saveBtn = document.querySelector('.project-value-save-full');
    if (saveBtn) saveBtn.classList.add('loading');
    window.parent.postMessage({ action: 'updateProjectValue', ticketId: ticketId, value: value, purchaseOrderReceived: purchaseOrderReceived }, '*');
}

function addStatusNote(ticketId) {
    const input = document.getElementById('internalNotesInput');
    const saveBtn = document.getElementById('saveInternalNotes');
    const content = input.value.trim();
    
    if (!content) {
        showToast('Please enter a note', 'error');
        return;
    }
    
    // Show loader
    saveBtn.classList.add('loading');
    
    window.parent.postMessage({ action: 'addStatusNote', ticketId: ticketId, content: content }, '*');
}

function deleteStatusNote(ticketId, noteId) {
    if (!confirm('Delete this status note?')) return;
    window.parent.postMessage({ action: 'deleteStatusNote', ticketId: ticketId, noteId: noteId }, '*');
}

function renderStatusNotes(notesData, isAdmin) {
    let notes = [];
    if (notesData) {
        try {
            notes = typeof notesData === 'string' ? JSON.parse(notesData) : notesData;
            if (!Array.isArray(notes)) notes = [];
        } catch (e) {
            notes = [];
        }
    }
    
    if (notes.length === 0) {
        return '<div class="no-notes">No status notes yet</div>';
    }
    
    return notes.map(note => 
        '<div class="status-note-item" data-note-id="' + note.id + '">' +
            '<div class="status-note-header">' +
                '<span class="status-note-date">' + formatFullDateTime(note.date) + '</span>' +
                (isAdmin ? '<button class="status-note-delete" onclick="deleteStatusNote(\'' + state.selectedTicket._id + '\', \'' + note.id + '\')" title="Delete note">' +
                    '<svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>' +
                '</button>' : '') +
            '</div>' +
            '<div class="status-note-content">' + note.content + '</div>' +
        '</div>'
    ).join('');
}

// ==========================================
// MODAL FUNCTIONS
// ==========================================
function openModal() {
    document.getElementById('newTicketModal').classList.add('active');
    resetForm();
    window.scrollTo(0, 0);
    window.parent.postMessage({ action: 'modalOpened', modal: 'newTicket' }, '*');
}

function closeModal() {
    document.getElementById('newTicketModal').classList.remove('active');
}

function closeNewTicketModal() {
    closeModal();
    // Clear validation states
    document.getElementById('ticketSubject').classList.remove('invalid');
    document.getElementById('ticketDescription').classList.remove('invalid');
    document.getElementById('subjectError').style.display = 'none';
    document.getElementById('descriptionError').style.display = 'none';
    document.getElementById('submitTicket').classList.remove('loading');
    // Clear referral validation
    var rc = document.getElementById('referralCompanyName');
    var re = document.getElementById('referralEmailAddress');
    if (rc) rc.classList.remove('invalid');
    if (re) re.classList.remove('invalid');
    var rce = document.getElementById('referralCompanyError');
    var ree = document.getElementById('referralEmailError');
    if (rce) rce.style.display = 'none';
    if (ree) ree.style.display = 'none';
}

function openReferralModal() {
    // Legacy - referrals now handled via new ticket form
    openModal();
    // Auto-select referral type
    setTimeout(function() {
        var referralOption = document.querySelector('.type-option[data-type="referral"]');
        if (referralOption) referralOption.click();
    }, 100);
}

function closeReferralModal() {
    // Legacy stub
}

function openImageModal(url) {
    document.getElementById('imageModalImg').src = url;
    document.getElementById('imageModal').classList.add('active');
    window.scrollTo(0, 0);
    window.parent.postMessage({ action: 'modalOpened', modal: 'image' }, '*');
}

function closeImageModal() {
    document.getElementById('imageModal').classList.remove('active');
}

// ==========================================
// CUSTOM MEDIA PLAYER CONTROLS
// ==========================================
var audioRegistry = {};

function getMediaElement(playerId) {
    var player = document.getElementById(playerId);
    if (!player) return null;
    // Check for video element in DOM
    var video = player.querySelector('video');
    if (video) return video;
    // Check audio registry
    if (audioRegistry[playerId]) return audioRegistry[playerId];
    return null;
}

function createAudioForPlayer(playerId, url) {
    if (audioRegistry[playerId]) return audioRegistry[playerId];
    var audio = new Audio();
    audio.crossOrigin = 'anonymous';
    audio.preload = 'auto';
    audio.src = url;
    audioRegistry[playerId] = audio;
    return audio;
}

function formatMediaTime(seconds) {
    if (isNaN(seconds) || !isFinite(seconds)) return '0:00';
    var m = Math.floor(seconds / 60);
    var s = Math.floor(seconds % 60);
    return m + ':' + (s < 10 ? '0' : '') + s;
}

function toggleMediaPlay(playerId) {
    var player = document.getElementById(playerId);
    if (!player) return;
    
    // Lazily create Audio object for audio players
    var audioUrl = player.getAttribute('data-audio-url');
    if (audioUrl && !audioRegistry[playerId]) {
        createAudioForPlayer(playerId, audioUrl);
        startProgressUpdate(playerId);
    }
    
    var media = getMediaElement(playerId);
    if (!media) return;
    
    if (media.paused) {
        // Pause all other players first
        document.querySelectorAll('.media-player').forEach(function(p) {
            if (p.id !== playerId) {
                var otherMedia = getMediaElement(p.id);
                if (otherMedia && !otherMedia.paused) {
                    otherMedia.pause();
                    p.classList.remove('playing');
                }
            }
        });
        startProgressUpdate(playerId);
        var playPromise = media.play();
        if (playPromise !== undefined) {
            playPromise.then(function() {
                player.classList.add('playing');
            }).catch(function(err) {
                console.error('Playback failed:', err);
                player.classList.remove('playing');
                // Try without crossOrigin
                if (audioUrl && media.crossOrigin) {
                    media.crossOrigin = null;
                    media.src = audioUrl;
                    media.load();
                    media.addEventListener('canplay', function retryPlay() {
                        media.removeEventListener('canplay', retryPlay);
                        media.play().then(function() {
                            player.classList.add('playing');
                        }).catch(function(e2) {
                            console.error('Retry also failed:', e2);
                            var timeEl = player.querySelector('.media-time');
                            if (timeEl) timeEl.textContent = 'Playback error';
                        });
                    });
                }
            });
        } else {
            player.classList.add('playing');
        }
    } else {
        media.pause();
        player.classList.remove('playing');
    }
}

function seekMedia(event, playerId) {
    var media = getMediaElement(playerId);
    if (!media || !media.duration) return;
    var bar = event.currentTarget;
    var rect = bar.getBoundingClientRect();
    var ratio = Math.max(0, Math.min(1, (event.clientX - rect.left) / rect.width));
    media.currentTime = ratio * media.duration;
    updateProgress(playerId);
}

function updateProgress(playerId) {
    var media = getMediaElement(playerId);
    var player = document.getElementById(playerId);
    if (!media || !player) return;
    
    var fill = player.querySelector('.media-progress-fill');
    var timeEl = player.querySelector('.media-time');
    
    if (fill && media.duration) {
        fill.style.width = ((media.currentTime / media.duration) * 100) + '%';
    }
    if (timeEl) {
        timeEl.textContent = formatMediaTime(media.currentTime) + ' / ' + formatMediaTime(media.duration);
    }
    
    // Hide video overlay when playing
    var overlay = player.querySelector('.video-play-overlay');
    if (overlay) {
        overlay.style.display = media.paused ? 'flex' : 'none';
    }
}

function startProgressUpdate(playerId) {
    var media = getMediaElement(playerId);
    if (!media) return;
    
    media.onended = function() {
        var player = document.getElementById(playerId);
        if (player) player.classList.remove('playing');
        var overlay = player ? player.querySelector('.video-play-overlay') : null;
        if (overlay) overlay.style.display = 'flex';
    };
    media.ontimeupdate = function() { updateProgress(playerId); };
    media.onloadedmetadata = function() { updateProgress(playerId); };
    media.onerror = function(e) {
        console.error('Media error for ' + playerId + ':', media.error);
        var player = document.getElementById(playerId);
        var timeEl = player ? player.querySelector('.media-time') : null;
        if (timeEl) timeEl.textContent = 'Error';
        if (player) player.classList.remove('playing');
    };
}

function toggleMute(playerId) {
    var media = getMediaElement(playerId);
    if (!media) return;
    media.muted = !media.muted;
    var player = document.getElementById(playerId);
    if (player) {
        if (media.muted) player.classList.add('muted');
        else player.classList.remove('muted');
    }
}

function toggleFullscreen(playerId) {
    var player = document.getElementById(playerId);
    if (!player) return;
    var video = player.querySelector('video');
    if (!video) return;
    if (video.requestFullscreen) video.requestFullscreen();
    else if (video.webkitRequestFullscreen) video.webkitRequestFullscreen();
    else if (video.webkitEnterFullscreen) video.webkitEnterFullscreen();
}

// Initialize any media players already in the DOM
function initMediaPlayers() {
    document.querySelectorAll('.media-player').forEach(function(player) {
        var media = player.querySelector('video') || player.querySelector('audio');
        if (media) startProgressUpdate(player.id);
    });
}


function resetForm() {
    document.getElementById('ticketForm').reset();
    state.selectedCategory = null;
    state.selectedPriority = 'medium';
    state.selectedImpact = 'moderate';
    state.selectedTicketType = 'support';

    document.querySelectorAll('.category-card').forEach(c => c.classList.remove('selected'));
    document.querySelectorAll('.priority-option').forEach(p => p.classList.remove('selected'));
    document.querySelectorAll('.impact-option').forEach(i => i.classList.remove('selected'));
    document.querySelectorAll('.type-option').forEach(t => t.classList.remove('selected'));

    document.querySelector('.priority-option.medium').classList.add('selected');
    document.querySelector('.impact-option.moderate').classList.add('selected');
    document.querySelector('.type-option[data-type="support"]').classList.add('selected');

    document.getElementById('categoryFormGroup').style.display = 'block';
    document.getElementById('referralFieldsGroup').style.display = 'none';
    document.getElementById('subjectFormGroup').style.display = 'block';
    document.getElementById('descriptionFormGroup').style.display = 'block';
    document.getElementById('priorityFormGroup').style.display = 'block';
    document.getElementById('impactFormGroup').style.display = 'block';
    
    // Clear validation states
    document.getElementById('ticketSubject').classList.remove('invalid');
    document.getElementById('ticketDescription').classList.remove('invalid');
    document.getElementById('subjectError').style.display = 'none';
    document.getElementById('descriptionError').style.display = 'none';
    document.getElementById('submitTicket').classList.remove('loading');
    
    // Clear referral validation
    var refCompany = document.getElementById('referralCompanyName');
    var refEmail = document.getElementById('referralEmailAddress');
    if (refCompany) { refCompany.classList.remove('invalid'); refCompany.value = ''; }
    if (refEmail) { refEmail.classList.remove('invalid'); refEmail.value = ''; }
    var refPhone = document.getElementById('referralPhoneNumber');
    var refComment = document.getElementById('referralCommentText');
    if (refPhone) refPhone.value = '';
    if (refComment) refComment.value = '';
    var refCompanyErr = document.getElementById('referralCompanyError');
    var refEmailErr = document.getElementById('referralEmailError');
    if (refCompanyErr) refCompanyErr.style.display = 'none';
    if (refEmailErr) refEmailErr.style.display = 'none';
}

function submitTicket() {
    const ticketType = state.selectedTicketType;
    const subject = document.getElementById('ticketSubject').value.trim();
    const description = document.getElementById('ticketDescription').value.trim();
    const subjectInput = document.getElementById('ticketSubject');
    const descriptionInput = document.getElementById('ticketDescription');
    const subjectError = document.getElementById('subjectError');
    const descriptionError = document.getElementById('descriptionError');
    const submitBtn = document.getElementById('submitTicket');
    
    // Clear previous validation states
    subjectInput.classList.remove('invalid');
    descriptionInput.classList.remove('invalid');
    subjectError.style.display = 'none';
    descriptionError.style.display = 'none';
    
    // Clear referral validation
    var refCompanyInput = document.getElementById('referralCompanyName');
    var refEmailInput = document.getElementById('referralEmailAddress');
    var refCompanyError = document.getElementById('referralCompanyError');
    var refEmailError = document.getElementById('referralEmailError');
    if (refCompanyInput) refCompanyInput.classList.remove('invalid');
    if (refEmailInput) refEmailInput.classList.remove('invalid');
    if (refCompanyError) refCompanyError.style.display = 'none';
    if (refEmailError) refEmailError.style.display = 'none';
    
    let hasError = false;
    
    if (ticketType !== 'referral') {
        if (subject.length < 5) {
            subjectInput.classList.add('invalid');
            subjectError.style.display = 'block';
            hasError = true;
        }
        if (description.length < 10) {
            descriptionInput.classList.add('invalid');
            descriptionError.style.display = 'block';
            hasError = true;
        }
    }
    
    // Referral-specific validation
    var referralData = {};
    if (ticketType === 'referral') {
        var companyReferred = refCompanyInput ? refCompanyInput.value.trim() : '';
        var emailAddress = refEmailInput ? refEmailInput.value.trim() : '';
        var phone = document.getElementById('referralPhoneNumber') ? document.getElementById('referralPhoneNumber').value.trim() : '';
        var comment = document.getElementById('referralCommentText') ? document.getElementById('referralCommentText').value.trim() : '';
        
        if (!companyReferred) {
            if (refCompanyInput) refCompanyInput.classList.add('invalid');
            if (refCompanyError) refCompanyError.style.display = 'block';
            hasError = true;
        }
        if (!emailAddress || !emailAddress.includes('@')) {
            if (refEmailInput) refEmailInput.classList.add('invalid');
            if (refEmailError) refEmailError.style.display = 'block';
            hasError = true;
        }
        
        referralData = {
            companyReferred: companyReferred,
            emailAddress: emailAddress,
            phone: phone,
            comment: comment
        };
    }
    
    if (hasError) {
        showToast('Please fill in the required fields', 'error');
        return;
    }
    
    // Check if user has available tasks for support tickets
    if (ticketType === 'support' && state.contract && state.contract.adjustedTasks <= 0) {
        showToast('You have used all your contracted tasks for this period. Please contact support.', 'error');
        return;
    }
    
    // Show loader
    submitBtn.classList.add('loading');

    var messageData = {
        action: 'createTicket',
        ticketType: ticketType,
        category: ticketType === 'support' ? (state.selectedCategory || 'general') : ticketType,
        customCategory: (document.getElementById('customCategory') ? document.getElementById('customCategory').value.trim() : ''),
        subject: ticketType === 'referral' ? 'Referral' : subject,
        description: ticketType === 'referral' ? '' : description,
        priority: ticketType === 'referral' ? 'medium' : state.selectedPriority,
        businessImpact: ticketType === 'referral' ? 'none' : state.selectedImpact
    };
    
    // Add referral fields if referral type
    if (ticketType === 'referral') {
        messageData.companyReferred = referralData.companyReferred;
        messageData.referralEmail = referralData.emailAddress;
        messageData.referralPhone = referralData.phone;
        messageData.referralComment = referralData.comment;
        messageData.subject = 'Referral: ' + referralData.companyReferred;
    }

    window.parent.postMessage(messageData, '*');
}

function submitReferral(e) {
    // Legacy - referrals now submitted through the new ticket form
    if (e) e.preventDefault();
}

// ==========================================
// UTILITIES
// ==========================================
function updateStats() {
    const total = state.tickets.length;
    const open = state.tickets.filter(t => t.status === 'open').length;
    const inProgress = state.tickets.filter(t => t.status === 'in-progress').length;
    const resolved = state.tickets.filter(t => t.status === 'resolved' || t.status === 'closed').length;

    document.getElementById('totalTickets').textContent = total;
    document.getElementById('openTickets').textContent = open;
    document.getElementById('inProgressTickets').textContent = inProgress;
    document.getElementById('resolvedTickets').textContent = resolved;
}

function updateTypeCounts() {
    const all = state.tickets.length;
    const support = state.tickets.filter(t => (t.ticketType || 'support') === 'support').length;
    const bug = state.tickets.filter(t => t.ticketType === 'bug').length;
    const project = state.tickets.filter(t => t.ticketType === 'project').length;
    const referral = state.tickets.filter(t => t.ticketType === 'referral').length;

    document.getElementById('allTypeCount').textContent = all;
    document.getElementById('supportTypeCount').textContent = support;
    document.getElementById('bugTypeCount').textContent = bug;
    document.getElementById('projectTypeCount').textContent = project;
    document.getElementById('referralTypeCount').textContent = referral;
}

function populateFilters() {
    if (state.isAdmin) {
        const userFilter = document.getElementById('userFilter');
        userFilter.innerHTML = '<option value="">All Users</option>' + 
            state.users.map(u => '<option value="' + u.email + '">' + (u.name || u.email) + ' (' + u.ticketCount + ')</option>').join('');

        const companyFilter = document.getElementById('companyFilter');
        companyFilter.innerHTML = '<option value="">All Companies</option>' + 
            state.companies.map(c => '<option value="' + c.domain + '">' + c.companyName + ' (' + c.ticketCount + ')</option>').join('');
    }
}

function updatePendingAttachmentUI() {
    const container = document.getElementById('pendingAttachmentContainer');
    if (!container) return;

    if (!state.pendingAttachment) {
        container.innerHTML = '';
        return;
    }

    const att = state.pendingAttachment;
    let preview = '';
    if (att.type === 'image') {
        preview = '<img src="' + att.url + '" class="pending-attachment-preview" alt="Preview">';
    } else {
        preview = '<div class="pending-attachment-icon"><svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg></div>';
    }

    container.innerHTML = '<div class="pending-attachment">' + preview +
        '<div class="pending-attachment-info">' +
            '<div class="pending-attachment-name">' + att.filename + '</div>' +
            '<div class="pending-attachment-type">' + att.type + '</div>' +
        '</div>' +
        '<button class="pending-attachment-remove" onclick="removePendingAttachment()">' +
            '<svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>' +
        '</button>' +
    '</div>';
}

function removePendingAttachment() {
    state.pendingAttachment = null;
    updatePendingAttachmentUI();
}

function scrollNotesToBottom() {
    const container = document.getElementById('notesContainer');
    if (container) container.scrollTop = container.scrollHeight;
}

function formatDate(date) {
    if (!date) return '';
    const d = new Date(date);
    const now = new Date();
    const diffMs = now - d;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);

    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return diffMins + 'm ago';
    if (diffHours < 24) return diffHours + 'h ago';
    if (diffDays < 7) return diffDays + 'd ago';
    return d.toLocaleDateString();
}

function formatTime(date) {
    if (!date) return '';
    const d = new Date(date);
    return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

function formatStatus(status) {
    const map = {
        'open': 'Open',
        'in-progress': 'In Progress',
        'awaiting-response': 'Awaiting Response',
        'resolved': 'Resolved',
        'closed': 'Closed'
    };
    return map[status] || status;
}

function formatCategory(category) {
    const map = {
        'domains': 'Domains & Account',
        'billing': 'Plans & Billing',
        'payments': 'Payments',
        'marketing': 'Marketing & SEO',
        'stores': 'Wix Stores',
        'memberships': 'Memberships & Events',
        'velo': 'Velo & CMS',
        'content': 'Content / Design',
        'other': 'Custom',
        'bug': 'Bug Report',
        'project': 'Project'
    };
    return map[category] || category;
}

function formatTicketNumber(num) {
    const str = String(num).replace(/[^0-9]/g, '');
    if (str.length > 3) {
        return str.slice(0, 3) + '-' + str.slice(3);
    }
    return str;
}

function renderOpportunityBadge(ticket) {
    if (!ticket.opportunityCategory) return '';
    var colour = ticket.opportunityCategoryColour || '999999';
    if (colour.charAt(0) !== '#') colour = '#' + colour;
    // Light background: 20% opacity of colour
    var r = parseInt(colour.slice(1,3), 16);
    var g = parseInt(colour.slice(3,5), 16);
    var b = parseInt(colour.slice(5,7), 16);
    var bg = 'rgba(' + r + ',' + g + ',' + b + ',0.12)';
    return '<span class="opportunity-badge" style="background:' + bg + ';color:' + colour + ';">' +
        '<span class="opportunity-badge-dot" style="background:' + colour + ';"></span>' +
        ticket.opportunityCategory +
    '</span>';
}

function formatFullDateTime(date) {
    if (!date) return '';
    const d = new Date(date);
    const day = d.getDate();
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const month = months[d.getMonth()];
    const year = d.getFullYear();
    const hours = d.getHours().toString().padStart(2, '0');
    const mins = d.getMinutes().toString().padStart(2, '0');
    return day + ' ' + month + ' ' + year + ', ' + hours + ':' + mins;
}

function showToast(message, type) {
    type = type || 'success';
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toastMessage');
    toast.className = 'toast show ' + type;
    toastMessage.textContent = message;
    setTimeout(() => toast.classList.remove('show'), 3000);
}

function showAccessDenied(message) {
    document.getElementById('loadingOverlay').classList.add('hidden');
    document.getElementById('statsBar').style.display = 'none';
    document.getElementById('ticketTypeTabs').style.display = 'none';
    document.getElementById('statusTabs').style.display = 'none';
    document.getElementById('mainContent').style.display = 'none';
    document.getElementById('accessDenied').style.display = 'block';
    document.getElementById('accessDeniedMessage').textContent = message;
}

// ==========================================
// EVENT LISTENERS
// ==========================================
function initEventListeners() {
    document.getElementById('newTicketBtn').addEventListener('click', openModal);
    document.getElementById('closeModal').addEventListener('click', closeNewTicketModal);
    document.getElementById('cancelTicket').addEventListener('click', closeNewTicketModal);
    document.getElementById('submitTicket').addEventListener('click', submitTicket);
    document.getElementById('pacmanBtn').addEventListener('click', () => window.parent.postMessage({ action: 'pacman' }, '*'));
    document.getElementById('brandingBtn').addEventListener('click', () => window.parent.postMessage({ action: 'brandingGuide' }, '*'));
    document.getElementById('imageModal').addEventListener('click', closeImageModal);
    
    // Rules and Task History popups
    document.getElementById('rulesBtn').addEventListener('click', openRulesPopup);
    document.getElementById('feedbackBtn').addEventListener('click', () => {
        window.parent.postMessage({ action: 'navigateToFeedback' }, '*');
    });
    
    // Account dropdown
    document.getElementById('accountBtn').addEventListener('click', (e) => {
        e.stopPropagation();
        var dropdown = document.getElementById('accountDropdown');
        dropdown.classList.toggle('visible');
    });
    document.getElementById('logoutBtn').addEventListener('click', () => {
        document.getElementById('accountDropdown').classList.remove('visible');
        window.parent.postMessage({ action: 'logout' }, '*');
    });
    document.addEventListener('click', () => {
        document.getElementById('accountDropdown').classList.remove('visible');
    });
    document.getElementById('closeRulesPopup').addEventListener('click', closeRulesPopup);
    document.getElementById('rulesPopup').addEventListener('click', function(e) { if (e.target.id === 'rulesPopup') closeRulesPopup(); });
    document.getElementById('taskHistoryBtn').addEventListener('click', openTaskHistoryPopup);
    document.getElementById('closeTaskHistoryPopup').addEventListener('click', closeTaskHistoryPopup);
    document.getElementById('taskHistoryPopup').addEventListener('click', function(e) { if (e.target.id === 'taskHistoryPopup') closeTaskHistoryPopup(); });
    
    // Notification popup
    document.getElementById('notificationBtn').addEventListener('click', toggleNotificationPopup);
    document.getElementById('closeNotificationPopup').addEventListener('click', closeNotificationPopup);
    document.getElementById('clearAllNotifications').addEventListener('click', clearAllNotifications);
    // Close notification popup when clicking outside (for mobile backdrop)
    document.querySelector('.notification-wrapper').addEventListener('click', function(e) {
        if (e.target === this && this.classList.contains('mobile-open')) {
            closeNotificationPopup();
        }
    });

    document.getElementById('saveProfileBtn').addEventListener('click', () => {
        const name = document.getElementById('profileNameInput').value.trim();
        const companyName = document.getElementById('profileCompanyInput').value.trim();
        if (!name || !companyName) {
            showToast('Please fill in both fields', 'error');
            return;
        }
        window.parent.postMessage({ action: 'saveProfile', name: name, companyName: companyName }, '*');
    });

    document.getElementById('searchInput').addEventListener('input', (e) => {
        state.searchQuery = e.target.value;
        renderTickets();
    });

    document.getElementById('priorityFilter').addEventListener('change', (e) => {
        state.priorityFilter = e.target.value;
        renderTickets();
    });

    document.getElementById('userFilter').addEventListener('change', (e) => {
        state.userFilter = e.target.value;
        renderTickets();
    });

    document.getElementById('companyFilter').addEventListener('change', (e) => {
        state.companyFilter = e.target.value;
        renderTickets();
    });

    // Status tabs
    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            state.currentStatusFilter = tab.dataset.tab;
            renderTickets();
        });
    });

    // Type tabs
    document.querySelectorAll('.ticket-type-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            document.querySelectorAll('.ticket-type-tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            state.currentTypeFilter = tab.dataset.type;
            
            // Reset status filter to All Tickets
            state.currentStatusFilter = 'all';
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            var allTab = document.querySelector('.tab[data-tab="all"]');
            if (allTab) allTab.classList.add('active');
            
            // Reset priority filter to All Priorities
            state.priorityFilter = '';
            var prioritySelect = document.getElementById('priorityFilter');
            if (prioritySelect) prioritySelect.value = '';
            
            renderTickets();
        });
    });

    // Type selector in form
    document.querySelectorAll('.type-option').forEach(option => {
        option.addEventListener('click', () => {
            document.querySelectorAll('.type-option').forEach(o => o.classList.remove('selected'));
            option.classList.add('selected');
            state.selectedTicketType = option.dataset.type;

            // Show/hide category fields
            if (option.dataset.type === 'support') {
                document.getElementById('categoryFormGroup').style.display = 'block';
            } else {
                document.getElementById('categoryFormGroup').style.display = 'none';
            }
            
            // Show/hide referral fields
            if (option.dataset.type === 'referral') {
                document.getElementById('referralFieldsGroup').style.display = 'block';
                document.getElementById('subjectFormGroup').style.display = 'none';
                document.getElementById('descriptionFormGroup').style.display = 'none';
                document.getElementById('priorityFormGroup').style.display = 'none';
                document.getElementById('impactFormGroup').style.display = 'none';
            } else {
                document.getElementById('referralFieldsGroup').style.display = 'none';
                document.getElementById('subjectFormGroup').style.display = 'block';
                document.getElementById('descriptionFormGroup').style.display = 'block';
                document.getElementById('priorityFormGroup').style.display = 'block';
                document.getElementById('impactFormGroup').style.display = 'block';
            }
        });
    });

    // Category cards
    document.querySelectorAll('.category-card').forEach(card => {
        card.addEventListener('click', () => {
            document.querySelectorAll('.category-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            state.selectedCategory = card.dataset.category;
            var subjectField = document.getElementById('ticketSubject');
            if (card.dataset.category === 'other') {
                if (subjectField) { subjectField.value = ''; subjectField.focus(); }
            } else {
                var title = card.querySelector('.category-card-title');
                if (title && subjectField) subjectField.value = title.textContent.trim();
            }
        });
    });

    // Priority options
    document.querySelectorAll('.priority-option').forEach(option => {
        option.addEventListener('click', () => {
            document.querySelectorAll('.priority-option').forEach(o => o.classList.remove('selected'));
            option.classList.add('selected');
            state.selectedPriority = option.dataset.priority;
        });
    });

    // Impact options
    document.querySelectorAll('.impact-option').forEach(option => {
        option.addEventListener('click', () => {
            document.querySelectorAll('.impact-option').forEach(o => o.classList.remove('selected'));
            option.classList.add('selected');
            state.selectedImpact = option.dataset.impact;
        });
    });

    // Modal close on overlay click
    document.getElementById('newTicketModal').addEventListener('click', (e) => {
        if (e.target.id === 'newTicketModal') closeNewTicketModal();
    });
}

    </script>
</body>
</html>
