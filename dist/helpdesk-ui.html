<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Support Desk</title>
    <link href="https://fonts.googleapis.com/css2?family=Wix+Madefor+Text:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
/* ========================================
   HELPDESK GLASSMORPHISM STYLES
   ======================================== */

/* Animations */
@keyframes gradientShift {
    0%, 100% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
}
@keyframes spin { to { transform: rotate(360deg); } }
@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
@keyframes slideIn { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
@keyframes bellRing {
    0%, 100% { transform: rotate(0); }
    10%, 30%, 50%, 70%, 90% { transform: rotate(10deg); }
    20%, 40%, 60%, 80% { transform: rotate(-10deg); }
}

/* Reset & Base */
* { box-sizing: border-box; margin: 0; padding: 0; }

::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.15); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: rgba(0,0,0,0.25); }

:root {
    --accent: #e43292;
    --accent-light: #f5d0e3;
    --accent-dark: #c4287d;
    --white: #ffffff;
    --black: #1a1a1a;
    --grey-50: #fafafa;
    --grey-100: #f5f5f5;
    --grey-200: #eeeeee;
    --grey-300: #e0e0e0;
    --grey-400: #bdbdbd;
    --grey-500: #9e9e9e;
    --grey-600: #757575;
    --grey-700: #616161;
    --grey-800: #424242;
    --priority-low: #4caf50;
    --priority-medium: #ff9800;
    --priority-high: #f44336;
    --priority-urgent: #9c27b0;
    --status-open: #2196f3;
    --status-progress: #ff9800;
    --status-awaiting: #9c27b0;
    --status-resolved: #4caf50;
    --status-closed: #757575;
    --type-support: #2196f3;
    --type-bug: #f44336;
    --type-project: #9c27b0;
    --type-referral: #009688;
    --radius: 10px;
    --radius-sm: 6px;
    --shadow: 0 2px 8px rgba(0,0,0,0.08);
    --shadow-lg: 0 4px 16px rgba(0,0,0,0.12);
    --chat-sent: #dcf8c6;
    --chat-received: #ffffff;
    --glass-bg: rgba(255, 255, 255, 0.7);
    --glass-border: rgba(255, 255, 255, 0.3);
    --glass-blur: 20px;
    --text-primary: #1e293b;
    --text-secondary: #64748b;
    --text-muted: #94a3b8;
}

body {
    font-family: 'Wix Madefor Text', -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, sans-serif;
    background: linear-gradient(135deg, #fdf2f8 0%, #fce7f3 20%, #e2e8f0 40%, #cbd5e1 60%, #f1f5f9 80%, #fdf2f8 100%);
    background-size: 400% 400%;
    animation: gradientShift 15s ease infinite;
    color: var(--black);
    line-height: 1.5;
    height: 100vh;
    overflow: hidden;
}

/* ========================================
   LOADING OVERLAY
   ======================================== */
.loading-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: var(--white);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    transition: opacity 0.3s ease;
}
.loading-overlay.hidden { opacity: 0; pointer-events: none; }
.loader {
    width: 48px; height: 48px;
    border: 4px solid var(--grey-200);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

/* ========================================
   GLASS EFFECTS
   ======================================== */
.glass {
    background: rgba(255, 255, 255, 0.7);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.3);
}
.glass-card {
    background: rgba(255, 255, 255, 0.6);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border: 1px solid rgba(255, 255, 255, 0.4);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
}
.glass-dark {
    background: rgba(255, 255, 255, 0.5);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

/* ========================================
   APP LAYOUT
   ======================================== */
.app { display: flex; height: 100vh; overflow: hidden; }

/* ========================================
   SIDEBAR
   ======================================== */
.sidebar-wrapper { position: relative; display: flex; flex-shrink: 0; overflow: visible; }

.sidebar {
    width: 280px;
    background: rgba(255, 255, 255, 0.75);
    backdrop-filter: blur(24px);
    -webkit-backdrop-filter: blur(24px);
    border-right: 1px solid rgba(255, 255, 255, 0.3);
    padding: 24px 18px;
    display: flex;
    flex-direction: column;
    overflow: visible;
    transition: width 0.3s ease, padding 0.3s ease;
    height: 100vh;
    position: relative;
}
.sidebar.collapsed {
    width: 92px;
    padding: 24px 28px 24px 14px;
    overflow: visible;
    border-right: none;
}

.sidebar-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow-y: auto;
    overflow-x: visible;
    margin-bottom: 14px;
    scrollbar-width: none;
    -ms-overflow-style: none;
}
.sidebar-content::-webkit-scrollbar { display: none; }
.sidebar.collapsed .sidebar-content { margin-bottom: 0; overflow: visible; scrollbar-width: none; }
.sidebar.collapsed .sidebar-content::-webkit-scrollbar { display: none; }

/* Collapse Button */
.collapse-btn {
    position: absolute;
    right: -12px;
    top: 50%;
    transform: translateY(-50%);
    width: 12px; height: 36px;
    border-radius: 0 4px 4px 0;
    border: none;
    background: rgba(255, 255, 255, 0.75);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s ease;
    z-index: 100;
}
.collapse-btn:hover { background: rgba(240, 240, 240, 0.95); }
.collapse-btn svg { width: 8px; height: 8px; stroke: #94a3b8; stroke-width: 3; }
.collapse-btn:hover svg { stroke: #64748b; }

/* ========================================
   LOGO SECTION
   ======================================== */
.logo-section { display: flex; align-items: center; gap: 14px; margin-bottom: 24px; padding-left: 4px; }
.sidebar.collapsed .logo-section { justify-content: center; padding-left: 0; margin-bottom: 12px; }

.logo-icon {
    width: 48px; height: 48px;
    border-radius: 16px;
    background: linear-gradient(135deg, #e43292 0%, #c4287d 100%);
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 8px 24px rgba(228, 50, 146, 0.35);
    flex-shrink: 0;
}
.logo-icon img { width: 28px; height: 28px; object-fit: contain; }

.logo-text { display: block; }
.sidebar.collapsed .logo-text { display: none; }
.logo-title { font-weight: 700; color: var(--text-primary); font-size: 18px; letter-spacing: -0.3px; }
.logo-subtitle { font-size: 12px; color: var(--text-muted); font-weight: 500; }

/* ========================================
   COMPANY BRANDING (header center)
   ======================================== */
.header-branding {
    display: flex; align-items: center; gap: 10px;
    padding: 6px 16px; border-radius: 12px;
    background: rgba(255, 255, 255, 0.4);
    border: 1px solid rgba(255, 255, 255, 0.3);
}
.company-logo { max-height: 32px; max-width: 100px; object-fit: contain; }
.company-name { font-size: 14px; font-weight: 600; color: var(--accent); white-space: nowrap; }

/* ========================================
   CONTRACT CARD
   ======================================== */
.contract-card {
    background: linear-gradient(135deg, #e43292 0%, #c4287d 100%);
    border-radius: 20px; padding: 20px; color: #fff;
    margin-bottom: 24px;
    box-shadow: 0 12px 32px rgba(228, 50, 146, 0.3);
    display: none;
}
.contract-card.visible { display: block; }
.sidebar.collapsed .contract-card { border-radius: 14px; padding: 12px 8px; text-align: center; margin-bottom: 12px; }

.contract-title { font-size: 14px; font-weight: 600; margin-bottom: 16px; opacity: 0.95; }
.sidebar.collapsed .contract-title { display: none; }

.contract-stats { display: flex; justify-content: space-between; margin-bottom: 16px; }
.sidebar.collapsed .contract-stats { display: none; }
.contract-stat { text-align: center; }
.contract-stat-value { font-size: 32px; font-weight: 700; letter-spacing: -1px; }
.contract-stat-label { font-size: 11px; opacity: 0.8; font-weight: 500; }

.contract-progress { background: rgba(255,255,255,0.25); border-radius: 6px; height: 8px; margin-bottom: 8px; overflow: hidden; }
.sidebar.collapsed .contract-progress { display: none; }
.contract-progress-bar { background: #fff; border-radius: 6px; height: 100%; width: 0%; transition: width 0.5s ease; }
.monthly-progress-fill { transition: width 0.4s ease; }
.monthly-progress-fill.warning { background: #ff9800 !important; }
.monthly-progress-fill.danger { background: #f44336 !important; }

.contract-footer { font-size: 12px; opacity: 0.9; text-align: center; font-weight: 500; }
.sidebar.collapsed .contract-footer { display: none; }
.contract-mini { display: none; }
.sidebar.collapsed .contract-mini { display: block; }
.contract-mini-value { font-size: 20px; font-weight: 700; }
.contract-mini-label { font-size: 9px; opacity: 0.8; font-weight: 500; }
.contract-mini-used { color: #fff; }
.contract-mini-total { color: rgba(255,255,255,0.8); }

/* ========================================
   SECTION LABELS
   ======================================== */
.section-label {
    font-size: 11px; font-weight: 700; color: var(--text-muted);
    text-transform: uppercase; letter-spacing: 1px;
    margin-bottom: 10px; padding-left: 4px;
}
.sidebar.collapsed .section-label { display: none; }

/* ========================================
   TICKET TYPE TABS (sidebar)
   ======================================== */
.type-tabs { display: flex; flex-direction: column; gap: 6px; margin-bottom: 24px; }
.sidebar.collapsed .type-tabs { margin-bottom: 4px; }

.type-tab {
    display: flex; align-items: center; gap: 10px;
    padding: 12px 16px; width: 100%;
    border: none; border-radius: 14px;
    background: rgba(255, 255, 255, 0.4);
    color: var(--text-secondary);
    cursor: pointer; font-size: 14px; font-weight: 500;
    transition: all 0.3s ease; text-align: left;
    backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
    font-family: inherit;
}
.sidebar.collapsed .type-tab { justify-content: center; padding: 12px; }
.type-tab:hover { background: rgba(255, 255, 255, 0.6); }
.type-tab.active { background: linear-gradient(135deg, #e43292 0%, #c4287d 100%); color: #fff; font-weight: 600; }
.type-tab.active.support { background: rgba(33, 150, 243, 0.12); color: #1976d2; }
.type-tab.active.bug { background: rgba(244, 67, 54, 0.12); color: #d32f2f; }
.type-tab.active.project { background: rgba(156, 39, 176, 0.12); color: #7b1fa2; }
.type-tab.active.referral { background: rgba(0, 150, 136, 0.12); color: #00796b; }
.type-tab svg { width: 18px; height: 18px; flex-shrink: 0; }
.type-tab-label { flex: 1; }
.sidebar.collapsed .type-tab-label { display: none; }
.type-tab-count { background: rgba(0, 0, 0, 0.06); padding: 3px 10px; border-radius: 10px; font-size: 12px; font-weight: 600; }
.type-tab.active .type-tab-count { background: rgba(255,255,255,0.25); }
.sidebar.collapsed .type-tab-count { display: none; }

/* ========================================
   QUICK ACTIONS (sidebar)
   ======================================== */
.quick-actions { display: flex; flex-direction: column; gap: 6px; margin-bottom: 24px; overflow: visible; }
.sidebar.collapsed .quick-actions { margin-bottom: 0; }

.action-btn {
    display: flex; align-items: center; gap: 10px;
    padding: 11px 14px; width: 100%;
    border: none; border-radius: 12px;
    background: rgba(255, 255, 255, 0.3);
    color: #475569; cursor: pointer;
    font-size: 13px; font-weight: 500;
    transition: all 0.2s ease; text-align: left;
    backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
    position: relative; overflow: visible; font-family: inherit;
}
.sidebar.collapsed .action-btn { justify-content: center; padding: 11px; overflow: visible; }
.action-btn:hover { background: rgba(255, 255, 255, 0.6); }
.action-btn.admin-disabled { opacity: 0.35; pointer-events: none; cursor: default; }
.action-btn.admin-disabled:hover { background: transparent; }
.action-btn svg { width: 18px; height: 18px; stroke: #64748b; flex-shrink: 0; }
.action-btn-label { flex: 1; }
.sidebar.collapsed .action-btn-label { display: none; }

.action-badge {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    color: #fff; padding: 3px 8px; border-radius: 10px;
    font-size: 11px; font-weight: 600;
    box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
}
.action-badge.hidden { display: none; }
.sidebar.collapsed .action-badge {
    position: absolute; top: -6px; right: -12px;
    min-width: 18px; height: 18px; padding: 0 5px;
    display: flex; align-items: center; justify-content: center; z-index: 10;
}

.notification-wrapper { position: relative; overflow: visible; }

/* ========================================
   USER ACCOUNT (sidebar bottom)
   ======================================== */
.user-account {
    display: flex; align-items: center; gap: 12px;
    padding: 14px; border-radius: 16px;
    cursor: pointer; flex-shrink: 0;
}
.sidebar.collapsed .user-account {
    justify-content: center; padding: 8px;
    background: transparent !important; border: none !important;
    box-shadow: none !important;
    backdrop-filter: none !important; -webkit-backdrop-filter: none !important;
}

.user-avatar {
    width: 44px; height: 44px; border-radius: 14px;
    background: linear-gradient(135deg, #e43292 0%, #c4287d 100%);
    display: flex; align-items: center; justify-content: center;
    color: #fff; font-weight: 600; font-size: 15px;
    box-shadow: 0 4px 12px rgba(228, 50, 146, 0.25);
    flex-shrink: 0;
}
.user-info-text { flex: 1; }
.sidebar.collapsed .user-info-text { display: none; }
.user-name { font-weight: 600; color: var(--text-primary); font-size: 14px; }
.user-role, .user-email { font-size: 12px; color: var(--text-muted); font-weight: 500; }
.user-dropdown { color: var(--text-muted); font-size: 12px; }
.sidebar.collapsed .user-dropdown { display: none; }

/* Account Dropdown */
.account-dropdown {
    display: none; position: absolute;
    bottom: 78px; left: 14px; right: 14px;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    border-radius: 14px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.15);
    z-index: 200; overflow: hidden;
    border: 1px solid rgba(255, 255, 255, 0.4);
}
.account-dropdown.visible { display: block; }
.account-dropdown-header {
    padding: 12px 16px; font-size: 13px; font-weight: 600;
    color: var(--grey-600); border-bottom: 1px solid var(--grey-200);
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.account-dropdown-item {
    display: flex; align-items: center; gap: 8px; width: 100%;
    padding: 10px 16px; border: none; background: none;
    font-size: 14px; color: var(--grey-800);
    cursor: pointer; transition: background 0.15s; font-family: inherit;
}
.account-dropdown-item:hover { background: var(--grey-100); }
.account-dropdown-item svg { width: 18px; height: 18px; stroke: var(--grey-600); }

/* ========================================
   MAIN CONTENT
   ======================================== */
.main-content {
    flex: 1; display: flex; flex-direction: column;
    overflow: hidden; min-width: 0; padding: 16px;
}

/* ========================================
   HEADER
   ======================================== */
.header {
    border-radius: 20px; padding: 16px 24px;
    display: flex; align-items: center; justify-content: space-between;
    flex-shrink: 0; margin-bottom: 20px; min-height: 76px;
    flex-wrap: wrap; gap: 12px;
}
.header-left { display: flex; align-items: center; gap: 12px; }
.header-title { font-size: 26px; font-weight: 700; color: var(--text-primary); letter-spacing: -0.5px; line-height: 1; }

.live-indicator {
    display: inline-flex; align-items: center; gap: 6px;
    background: rgba(76, 175, 80, 0.12); color: #2e7d32;
    padding: 4px 10px; border-radius: 12px;
    font-size: 11px; font-weight: 600;
}
.live-indicator::before {
    content: ''; width: 8px; height: 8px;
    background: #4caf50; border-radius: 50%;
    animation: pulse 2s infinite;
}

.header-actions { display: flex; align-items: flex-start; gap: 14px; }

.search-box {
    display: flex; align-items: center; gap: 10px;
    background: rgba(255, 255, 255, 0.6);
    padding: 0 18px; border-radius: 14px; width: 240px;
    border: 1px solid rgba(255, 255, 255, 0.4); height: 44px;
}
.search-box svg { width: 18px; height: 18px; stroke: var(--text-muted); flex-shrink: 0; }
.search-box input {
    border: none; background: none; outline: none;
    font-size: 14px; color: var(--text-primary); width: 100%;
    font-weight: 500; font-family: inherit;
}

.header-buttons { display: flex; align-items: center; gap: 10px; }
.header-btn-group { display: flex; flex-direction: column; align-items: center; gap: 4px; }
.header-btn {
    width: 44px; height: 44px; border-radius: 14px;
    border: 1px solid rgba(255, 255, 255, 0.3);
    backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
    cursor: pointer; display: flex; align-items: center; justify-content: center;
    transition: transform 0.2s ease; position: relative;
}
.header-btn:hover { transform: scale(1.08); }
.header-btn.pacman { background: rgba(255, 235, 59, 0.4); }
.header-btn.project { background: rgba(33, 150, 243, 0.15); }
.header-btn.branding { background: rgba(156, 39, 176, 0.15); }
.header-btn[disabled] { opacity: 0.5; cursor: not-allowed; }
.header-btn[disabled]:hover { transform: none; }
.header-btn svg { width: 20px; height: 20px; stroke: #64748b; }
.header-btn img { width: 20px; height: 20px; object-fit: contain; }
.header-btn-label { font-size: 10px; color: var(--text-muted); font-weight: 500; }

.new-ticket-btn {
    padding: 0 24px; height: 44px;
    background: linear-gradient(135deg, #e43292 0%, #c4287d 100%);
    color: #fff; border: none; border-radius: 14px;
    font-weight: 600; font-size: 14px; cursor: pointer;
    display: flex; align-items: center; gap: 8px;
    box-shadow: 0 8px 24px rgba(228, 50, 146, 0.35);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    font-family: inherit;
}
.new-ticket-btn:hover { transform: translateY(-2px); box-shadow: 0 12px 32px rgba(228, 50, 146, 0.4); }
.new-ticket-btn svg { width: 18px; height: 18px; stroke: #fff; stroke-width: 2.5; }

.mobile-menu-btn {
    display: none; width: 40px; height: 40px;
    border: none; background: rgba(255, 255, 255, 0.6);
    border-radius: 12px; cursor: pointer;
    align-items: center; justify-content: center; flex-shrink: 0;
}
.mobile-menu-btn svg { width: 20px; height: 20px; stroke: #64748b; }

/* ========================================
   PROFILE SETUP BANNER
   ======================================== */
.profile-setup-banner {
    background: rgba(245, 208, 227, 0.6);
    backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
    border: 2px solid var(--accent);
    border-radius: 20px; padding: 20px; margin-bottom: 20px;
}
.profile-setup-content { display: flex; align-items: center; gap: 16px; flex-wrap: wrap; }
.profile-setup-icon {
    width: 48px; height: 48px; background: var(--accent);
    border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;
}
.profile-setup-icon svg { width: 24px; height: 24px; fill: var(--white); stroke: var(--white); }
.profile-setup-text { flex: 1; min-width: 200px; }
.profile-setup-text strong { display: block; font-size: 16px; color: var(--accent-dark); margin-bottom: 4px; }
.profile-setup-text span { font-size: 14px; color: var(--grey-700); }
.profile-setup-form { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
.profile-input {
    padding: 10px 14px; border: 1px solid rgba(255,255,255,0.5);
    border-radius: 12px; font-size: 14px; min-width: 150px;
    font-family: inherit; background: rgba(255,255,255,0.6);
    backdrop-filter: blur(8px);
}
.profile-input:focus { outline: none; border-color: var(--accent); }

/* ========================================
   ACCESS DENIED
   ======================================== */
.access-denied { text-align: center; padding: 60px 20px; }
.access-denied svg { width: 80px; height: 80px; stroke: var(--grey-400); margin-bottom: 24px; }
.access-denied h2 { font-size: 24px; margin-bottom: 12px; color: var(--text-primary); }
.access-denied p { font-size: 16px; color: var(--text-secondary); max-width: 400px; margin: 0 auto; }

/* ========================================
   CONTENT AREA
   ======================================== */
.content-area { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
.content-fixed { flex-shrink: 0; }

/* ========================================
   STATS ROW
   ======================================== */
.stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 16px; }
.stat-card {
    border-radius: 20px; padding: 20px 22px;
    display: flex; align-items: center; gap: 16px;
    transition: transform 0.2s ease;
}
.stat-card:hover { transform: translateY(-4px); }
.stat-icon { width: 52px; height: 52px; border-radius: 16px; display: flex; align-items: center; justify-content: center; }
.stat-icon svg { width: 24px; height: 24px; }
.stat-icon.pink { background: rgba(228, 50, 146, 0.1); }
.stat-icon.pink svg { stroke: #e43292; }
.stat-icon.blue { background: rgba(25, 118, 210, 0.1); }
.stat-icon.blue svg { stroke: #1976d2; }
.stat-icon.orange { background: rgba(245, 124, 0, 0.1); }
.stat-icon.orange svg { stroke: #f57c00; }
.stat-icon.green { background: rgba(56, 142, 60, 0.1); }
.stat-icon.green svg { stroke: #388e3c; }
.stat-label { font-size: 12px; color: var(--text-muted); margin-bottom: 4px; font-weight: 600; }
.stat-value { font-size: 28px; font-weight: 700; letter-spacing: -1px; }
.stat-value.pink { color: #e43292; }
.stat-value.blue { color: #1976d2; }
.stat-value.orange { color: #f57c00; }
.stat-value.green { color: #388e3c; }

/* ========================================
   STATUS TABS & FILTERS ROW
   ======================================== */
.status-tabs-row { display: grid; grid-template-columns: 1.5fr 2fr; gap: 20px; margin-bottom: 16px; align-items: center; }
.status-tabs { display: flex; gap: 4px; padding: 6px; border-radius: 16px; }
.status-tab {
    padding: 10px 18px; border: none; border-radius: 12px;
    background: transparent; color: var(--text-secondary);
    cursor: pointer; font-size: 13px; font-weight: 500;
    transition: all 0.25s ease; font-family: inherit;
}
.status-tab:hover { background: rgba(255, 255, 255, 0.5); color: var(--text-primary); }
.status-tab.active {
    background: rgba(255, 255, 255, 0.9); color: var(--text-primary);
    font-weight: 600; box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

.filters-row { display: flex; gap: 12px; align-items: center; justify-content: flex-end; }
.filter-select {
    padding: 10px 14px; border: 1px solid rgba(255,255,255,0.4);
    border-radius: 12px; font-size: 13px; font-family: inherit;
    cursor: pointer; background: rgba(255, 255, 255, 0.5);
    backdrop-filter: blur(8px); color: var(--text-secondary);
}
.filter-select:focus { outline: none; border-color: var(--accent); }

/* ========================================
   MAIN GRID
   ======================================== */
.main-grid { display: grid; grid-template-columns: 1.5fr 2fr; gap: 20px; flex: 1; min-height: 0; overflow: hidden; }

.ticket-list-column { display: flex; flex-direction: column; min-height: 0; overflow: hidden; }
.ticket-list-header { margin-bottom: 10px; }
.panel-title { font-size: 16px; font-weight: 700; color: var(--text-primary); letter-spacing: -0.3px; }

/* ========================================
   TICKET LIST
   ======================================== */
.ticket-list { border-radius: 24px; overflow-y: auto; overflow-x: hidden; flex: 1; min-height: 0; scrollbar-width: none; -ms-overflow-style: none; }
.ticket-list::-webkit-scrollbar { display: none; }

.ticket-item {
    padding: 18px 22px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.4);
    cursor: pointer; transition: all 0.2s ease;
}
.ticket-item:hover { background: rgba(255, 255, 255, 0.5); }
.ticket-item.active, .ticket-item.selected { background: rgba(228, 50, 146, 0.08); border-left: 3px solid var(--accent); }
.ticket-item-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
.ticket-number { font-weight: 600; color: var(--accent); font-size: 14px; }
.ticket-number-block { display: flex; flex-direction: column; gap: 2px; }
.ticket-datetime { font-size: 11px; color: var(--text-muted); font-weight: 400; }
.ticket-subject { font-weight: 600; color: var(--text-primary); font-size: 15px; margin-bottom: 4px; }
.ticket-meta { display: flex; align-items: center; gap: 10px; font-size: 12px; color: var(--text-muted); font-weight: 500; }

.ticket-status { padding: 4px 10px; border-radius: 8px; font-size: 11px; font-weight: 600; }
.ticket-status.open { background: rgba(33, 150, 243, 0.15); color: #1976d2; }
.ticket-status.in-progress { background: rgba(255, 152, 0, 0.15); color: #f57c00; }
.ticket-status.awaiting-response { background: rgba(156, 39, 176, 0.12); color: #7b1fa2; }
.ticket-status.resolved { background: rgba(76, 175, 80, 0.15); color: #388e3c; }
.ticket-status.closed { background: rgba(0,0,0,0.06); color: var(--status-closed); }

.ticket-priority { display: inline-flex; align-items: center; gap: 6px; }
.priority-dot { width: 10px; height: 10px; border-radius: 50%; }
.priority-dot.low { background: var(--priority-low); box-shadow: 0 2px 8px rgba(76, 175, 80, 0.5); }
.priority-dot.medium { background: var(--priority-medium); box-shadow: 0 2px 8px rgba(255, 152, 0, 0.5); }
.priority-dot.high { background: var(--priority-high); box-shadow: 0 2px 8px rgba(244, 67, 54, 0.5); }
.priority-dot.urgent { background: var(--priority-urgent); box-shadow: 0 2px 8px rgba(156, 39, 176, 0.5); }

.ticket-type-badge { padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; margin-left: 8px; }
.ticket-type-badge.type-support { background: rgba(33, 150, 243, 0.12); color: var(--type-support); }
.ticket-type-badge.type-bug { background: rgba(244, 67, 54, 0.12); color: var(--type-bug); }
.ticket-type-badge.type-project { background: rgba(156, 39, 176, 0.12); color: var(--type-project); }
.ticket-type-badge.type-referral { background: rgba(0, 150, 136, 0.12); color: var(--type-referral); }

.ticket-locked-badge { display: inline-flex; align-items: center; justify-content: center; margin-left: 8px; padding: 4px; background: rgba(0,0,0,0.06); border-radius: 50%; }
.ticket-locked-badge svg { width: 14px; height: 14px; fill: var(--grey-600); stroke: var(--grey-600); }
.ticket-locked-banner {
    display: flex; align-items: center; justify-content: center; gap: 8px;
    padding: 12px 16px; background: rgba(248, 250, 252, 0.6);
    border: 1px solid rgba(255,255,255,0.4); border-radius: 12px;
    color: var(--text-secondary); font-size: 13px; margin-top: 12px;
}
.ticket-locked-banner svg { width: 18px; height: 18px; stroke: var(--text-secondary); }
.project-value-display { font-size: 12px; color: var(--type-project); font-weight: 600; margin-top: 4px; }

.empty-state { text-align: center; padding: 60px 20px; color: var(--text-secondary); flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; }
.empty-state svg { width: 80px; height: 80px; stroke: var(--grey-300); margin-bottom: 16px; }
.empty-state h3 { font-size: 18px; margin-bottom: 8px; color: var(--text-primary); }
.empty-state p { font-size: 14px; }

/* ========================================
   TICKET DETAIL PANEL
   ======================================== */
.ticket-detail-panel { border-radius: 24px; display: flex; flex-direction: column; overflow: hidden; min-height: 0; }
.ticket-detail-content { padding: 24px; flex: 1; overflow-y: auto; min-height: 0; }
.detail-header { margin-bottom: 24px; }
.detail-title { font-size: 22px; font-weight: 700; margin-bottom: 8px; color: var(--text-primary); }
.detail-meta { display: flex; gap: 14px; flex-wrap: wrap; font-size: 13px; color: var(--text-secondary); }
.detail-meta-item { display: flex; align-items: center; gap: 6px; }
.detail-meta-item svg { width: 16px; height: 16px; fill: var(--grey-500); stroke: var(--text-secondary); }

.detail-section { margin-bottom: 24px; }
.detail-section-title { font-size: 11px; font-weight: 700; color: var(--text-muted); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
.detail-description { background: rgba(248, 250, 252, 0.6); padding: 16px; border-radius: 12px; font-size: 14px; line-height: 1.6; white-space: pre-wrap; color: var(--text-primary); }
.detail-info-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
.detail-info-item { background: rgba(248, 250, 252, 0.5); padding: 12px 16px; border-radius: 12px; }
.detail-info-label { font-size: 12px; color: var(--text-muted); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }
.detail-info-value { font-weight: 500; font-size: 14px; color: var(--text-primary); }

/* Admin Type Section */
.admin-type-section { margin-top: 16px; padding: 16px; background: rgba(248, 250, 252, 0.5); border-radius: 14px; border: 1px solid rgba(255,255,255,0.3); display: none; }
.admin-type-section.visible { display: block; }
.admin-type-section h4 { font-size: 13px; font-weight: 600; margin-bottom: 12px; color: var(--text-secondary); }
.admin-type-selector { display: flex; gap: 8px; }
.admin-type-btn {
    padding: 8px 16px; border: 1px solid rgba(0,0,0,0.08); border-radius: 10px;
    background: rgba(255, 255, 255, 0.6); cursor: pointer;
    font-size: 13px; font-weight: 500; transition: all 0.2s ease; font-family: inherit;
}
.admin-type-btn:hover { background: rgba(255, 255, 255, 0.8); }
.admin-type-btn.active { color: var(--white); }
.admin-type-btn.active[data-type="support"] { background: var(--type-support); border-color: var(--type-support); }
.admin-type-btn.active[data-type="bug"] { background: var(--type-bug); border-color: var(--type-bug); }
.admin-type-btn.active[data-type="project"] { background: var(--type-project); border-color: var(--type-project); }
.admin-type-btn.active[data-type="referral"] { background: var(--type-referral); border-color: var(--type-referral); }

/* Project Value */
.project-value-section { margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.3); display: none; }
.project-value-section.visible { display: block; }
.project-value-label { font-weight: 600; font-size: 13px; margin-bottom: 8px; }
.project-value-input-wrapper { display: flex; align-items: center; gap: 8px; }
.project-value-prefix { font-size: 18px; font-weight: 600; color: var(--text-secondary); }
.project-value-input { flex: 1; padding: 10px 14px; border: 1px solid rgba(255,255,255,0.4); border-radius: 12px; font-size: 16px; font-weight: 600; font-family: inherit; background: rgba(255,255,255,0.5); }
.project-value-input:focus { outline: none; border-color: var(--accent); }
.project-value-save-btn { padding: 10px 16px; background: var(--type-project); color: var(--white); border: none; border-radius: 10px; cursor: pointer; font-weight: 500; font-family: inherit; }
.project-value-info { margin-top: 8px; font-size: 12px; color: var(--text-secondary); }
.project-value-save-full { width: 100%; margin-top: 4px; padding: 8px 16px; position: relative; }
.project-value-save-full.loading { pointer-events: none; opacity: 0.7; color: transparent; }
.project-value-save-full.loading::after {
    content: ''; position: absolute; top: 50%; left: 50%;
    width: 16px; height: 16px; margin: -8px 0 0 -8px;
    border: 2px solid rgba(255,255,255,0.3); border-top-color: #fff;
    border-radius: 50%; animation: spin 0.6s linear infinite;
}

/* ========================================
   STATUS NOTES
   ======================================== */
.status-notes-section {
    background: rgba(232, 245, 233, 0.6); backdrop-filter: blur(8px);
    border: 1px solid rgba(165, 214, 167, 0.5); border-radius: 14px; padding: 16px; margin-top: 16px;
}
.status-notes-section .detail-section-title { color: #2e7d32; }
.status-notes-list { max-height: 200px; overflow-y: auto; }
.status-note-item { background: rgba(255, 255, 255, 0.7); padding: 10px 12px; border-radius: 10px; margin-bottom: 8px; border-left: 3px solid #4caf50; }
.status-note-item:last-child { margin-bottom: 0; }
.status-note-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
.status-note-date { font-size: 11px; color: var(--grey-500); }
.status-note-delete { width: 24px; height: 24px; border: none; background: transparent; cursor: pointer; border-radius: 4px; display: flex; align-items: center; justify-content: center; opacity: 0.5; transition: all 0.2s; }
.status-note-delete:hover { opacity: 1; background: rgba(255, 235, 238, 0.7); }
.status-note-delete svg { width: 16px; height: 16px; fill: #d32f2f; }
.status-note-content { font-size: 14px; line-height: 1.5; color: var(--text-primary); white-space: pre-wrap; }
.status-notes-list .no-notes { padding: 20px; text-align: center; color: var(--grey-500); font-style: italic; background: rgba(255, 255, 255, 0.5); border-radius: 10px; }
.internal-notes-input-wrapper { display: flex; flex-direction: column; gap: 8px; margin-top: 12px; }
.internal-notes-textarea { width: 100%; min-height: 80px; padding: 12px; border: 1px solid rgba(255,255,255,0.4); border-radius: 10px; font-size: 14px; font-family: inherit; resize: vertical; background: rgba(255,255,255,0.6); }
.internal-notes-textarea:focus { outline: none; border-color: #2e7d32; }
.internal-notes-input-wrapper .btn { align-self: flex-end; }

/* Status Actions */
.status-actions { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 16px; }
.status-btn {
    padding: 8px 16px; border-radius: 10px; font-size: 13px; font-weight: 500;
    cursor: pointer; border: 1px solid rgba(0,0,0,0.08);
    background: rgba(255, 255, 255, 0.6); color: var(--text-secondary);
    transition: all 0.2s ease; font-family: inherit;
}
.status-btn:hover { border-color: var(--accent); }
.status-btn.active {
    background: linear-gradient(135deg, #e43292 0%, #c4287d 100%);
    color: var(--white); border-color: transparent;
    box-shadow: 0 4px 12px rgba(228, 50, 146, 0.25);
}

/* ========================================
   NOTES / CHAT
   ======================================== */
.notes-section { margin-top: 24px; }
.notes-container {
    background: rgba(248, 250, 252, 0.6); backdrop-filter: blur(8px);
    border-radius: 16px; padding: 16px;
    min-height: 300px; max-height: 400px; overflow-y: auto;
    display: flex; flex-direction: column; gap: 8px;
}
.note-bubble { max-width: 85%; padding: 12px 16px; border-radius: 18px; position: relative; word-wrap: break-word; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
.note-bubble.sent { background: linear-gradient(135deg, #e43292 0%, #c4287d 100%); color: #fff; align-self: flex-end; border-bottom-right-radius: 4px; box-shadow: 0 4px 12px rgba(228, 50, 146, 0.25); }
.note-bubble.received { background: rgba(255, 255, 255, 0.9); color: var(--text-primary); align-self: flex-start; border-bottom-left-radius: 4px; }
.note-author { font-size: 11px; font-weight: 700; color: #e43292; margin-bottom: 4px; }
.note-bubble.sent .note-author { color: rgba(255,255,255,0.85); }
.note-content { font-size: 13px; line-height: 1.5; white-space: pre-wrap; }
.note-time { font-size: 10px; opacity: 0.7; text-align: right; margin-top: 6px; font-weight: 500; }
.note-attachment { margin-top: 8px; }
.note-attachment img { max-width: 200px; max-height: 200px; border-radius: 10px; cursor: pointer; }

/* ========================================
   MEDIA PLAYER
   ======================================== */
.media-player { border-radius: 12px; overflow: hidden; background: #1a1a2e; max-width: 280px; }
.media-player .video-wrapper { position: relative; background: #000; }
.media-player video { display: block; width: 100%; max-height: 200px; object-fit: contain; }
.video-play-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.35); cursor: pointer; transition: background 0.2s; }
.video-play-overlay:hover { background: rgba(0,0,0,0.5); }
.video-play-overlay svg { width: 48px; height: 48px; fill: #fff; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.4)); }
.media-player.playing .video-play-overlay { display: none; }
.media-controls { display: flex; align-items: center; gap: 6px; padding: 6px 8px; }
.media-btn { background: none; border: none; cursor: pointer; padding: 2px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: background 0.15s; flex-shrink: 0; }
.media-btn:hover { background: rgba(255,255,255,0.15); }
.media-btn svg { width: 20px; height: 20px; fill: #fff; }
.play-btn .icon-pause { display: none; }
.media-player.playing .play-btn .icon-play { display: none; }
.media-player.playing .play-btn .icon-pause { display: block; }
.volume-btn .icon-vol-off { display: none; }
.media-player.muted .volume-btn .icon-vol-on { display: none; }
.media-player.muted .volume-btn .icon-vol-off { display: block; }
.media-progress { flex: 1; height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px; cursor: pointer; position: relative; min-width: 40px; }
.media-progress:hover { height: 6px; }
.media-progress-fill { height: 100%; background: var(--accent); border-radius: 2px; width: 0; transition: width 0.1s linear; pointer-events: none; }
.media-time { font-size: 11px; color: rgba(255,255,255,0.7); white-space: nowrap; min-width: 70px; text-align: center; font-variant-numeric: tabular-nums; }
.media-filename { padding: 4px 8px 6px; font-size: 11px; color: rgba(255,255,255,0.5); display: flex; align-items: center; gap: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.audio-player { max-width: 260px; }
.audio-player .media-controls { padding: 8px 10px; }
.audio-player .play-btn svg { width: 22px; height: 22px; }
.video-player { max-width: 280px; }
.fullscreen-btn { margin-left: auto; }

.note-attachment-doc { display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: rgba(0,0,0,0.05); border-radius: 10px; text-decoration: none; color: var(--text-primary); }
.note-attachment-doc svg { width: 24px; height: 24px; fill: var(--grey-600); stroke: var(--grey-600); }
.note-attachment-doc span { font-size: 13px; word-break: break-all; }

/* Note Input */
.note-input-container { display: flex; gap: 8px; margin-top: 12px; align-items: flex-end; }
.note-input-wrapper { flex: 1; display: flex; align-items: flex-end; gap: 8px; background: rgba(255, 255, 255, 0.8); border-radius: 24px; padding: 8px 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); border: 1px solid rgba(0,0,0,0.06); }
.note-input-actions { display: flex; gap: 4px; }
.note-action-btn { width: 36px; height: 36px; border: none; background: transparent; cursor: pointer; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: background 0.2s; }
.note-action-btn:hover { background: rgba(0,0,0,0.05); }
.note-action-btn svg { width: 22px; height: 22px; fill: var(--grey-600); stroke: var(--grey-600); }
.note-textarea { flex: 1; border: none; resize: none; font-size: 14px; font-family: inherit; line-height: 1.4; max-height: 100px; min-height: 24px; padding: 6px 0; background: transparent; }
.note-textarea:focus { outline: none; }
.note-send-btn { width: 44px; height: 44px; border-radius: 50%; background: linear-gradient(135deg, #e43292 0%, #c4287d 100%); border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; flex-shrink: 0; box-shadow: 0 4px 12px rgba(228, 50, 146, 0.3); }
.note-send-btn:hover { transform: scale(1.05); }
.note-send-btn svg { width: 22px; height: 22px; fill: var(--white); stroke: var(--white); }

/* Pending Attachments */
.pending-attachment { display: flex; align-items: center; gap: 8px; padding: 8px; background: rgba(248, 250, 252, 0.6); border-radius: 10px; margin-bottom: 8px; }
.pending-attachment-preview { width: 40px; height: 40px; object-fit: cover; border-radius: 10px; }
.pending-attachment-icon { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.05); border-radius: 10px; }
.pending-attachment-icon svg { width: 24px; height: 24px; fill: var(--grey-600); }
.pending-attachment-info { flex: 1; }
.pending-attachment-name { font-size: 13px; font-weight: 500; }
.pending-attachment-type { font-size: 11px; color: var(--text-secondary); }
.pending-attachment-remove { width: 24px; height: 24px; border: none; background: rgba(0,0,0,0.08); border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }
.pending-attachment-remove svg { width: 14px; height: 14px; fill: var(--grey-700); }

/* ========================================
   BUTTONS
   ======================================== */
.btn { padding: 10px 20px; border-radius: 12px; font-weight: 500; font-size: 14px; cursor: pointer; transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 8px; border: none; font-family: inherit; }
.btn svg { width: 18px; height: 18px; fill: currentColor; }
.btn-primary { background: linear-gradient(135deg, #e43292 0%, #c4287d 100%); color: var(--white); box-shadow: 0 4px 12px rgba(228, 50, 146, 0.25); }
.btn-primary:hover { transform: translateY(-1px); box-shadow: 0 6px 16px rgba(228, 50, 146, 0.35); }
.btn-secondary { background: rgba(255, 255, 255, 0.6); color: var(--text-primary); border: 1px solid rgba(0,0,0,0.08); }
.btn-secondary:hover { background: rgba(255, 255, 255, 0.8); }
.btn-danger { background: rgba(254, 242, 242, 0.8); color: #dc2626; border: 1px solid rgba(254, 202, 202, 0.5); }
.btn-danger:hover { background: rgba(254, 226, 226, 0.9); }
.btn-loader { width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-top-color: #fff; border-radius: 50%; animation: spin 0.8s linear infinite; display: inline-block; }
.btn-primary.loading { pointer-events: none; opacity: 0.7; }
.btn-primary.loading .btn-text { display: none; }
.btn-primary.loading .btn-loader { display: inline-block !important; }

/* ========================================
   MODALS
   ======================================== */
.modal-overlay {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.4); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
    display: none; align-items: flex-start; justify-content: center;
    z-index: 1000; padding: 40px 20px;
}
.modal-overlay.active { display: flex; }
.modal {
    background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px);
    border-radius: 24px; width: 100%; max-width: 600px; max-height: 90vh;
    overflow: hidden; display: flex; flex-direction: column;
    box-shadow: 0 24px 48px rgba(0,0,0,0.15); border: 1px solid rgba(255,255,255,0.3);
}
.modal-header { padding: 22px 26px; background: linear-gradient(135deg, #e43292 0%, #c4287d 100%); color: #fff; display: flex; justify-content: space-between; align-items: center; }
.modal-title { font-size: 20px; font-weight: 700; display: flex; align-items: center; gap: 10px; }
.modal-title svg { width: 20px; height: 20px; stroke: #fff; }
.modal-close { background: rgba(255,255,255,0.2); border: none; border-radius: 10px; padding: 8px; color: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; width: 36px; height: 36px; transition: background 0.2s; }
.modal-close:hover { background: rgba(255,255,255,0.35); }
.modal-close svg { width: 24px; height: 24px; fill: #fff; stroke: #fff; }
.modal-body { padding: 24px; overflow-y: auto; flex: 1; }
.modal-footer { padding: 16px 24px; border-top: 1px solid rgba(0,0,0,0.06); display: flex; justify-content: flex-end; gap: 12px; }

/* ========================================
   FORMS
   ======================================== */
.form-group { margin-bottom: 20px; }
.form-label { display: block; font-weight: 500; margin-bottom: 8px; font-size: 14px; color: var(--text-primary); }
.required { color: #f44336; }
.form-input, .form-textarea, .form-select { width: 100%; padding: 12px 16px; border: 1px solid rgba(0,0,0,0.08); border-radius: 12px; font-size: 14px; font-family: inherit; transition: border-color 0.2s; background: rgba(255,255,255,0.6); }
.form-input:focus, .form-textarea:focus, .form-select:focus { outline: none; border-color: var(--accent); }
.form-textarea { resize: vertical; min-height: 120px; }
.field-error { color: #f44336; font-size: 12px; margin-top: 4px; display: none; }
.form-input.invalid, .form-textarea.invalid { border-color: #f44336; background: rgba(244, 67, 54, 0.05); }
.form-input.invalid:focus, .form-textarea.invalid:focus { border-color: #f44336; box-shadow: 0 0 0 2px rgba(244, 67, 54, 0.2); }

/* Ticket Type Selector */
.ticket-type-selector { display: flex; gap: 12px; margin-bottom: 24px; }
.type-option { flex: 1; padding: 16px; border: 2px solid rgba(0,0,0,0.06); border-radius: 16px; cursor: pointer; text-align: center; transition: all 0.2s ease; background: rgba(255,255,255,0.5); }
.type-option:hover { border-color: var(--grey-400); }
.type-option.selected { border-color: var(--accent); background: rgba(245, 208, 227, 0.3); }
.type-option svg { width: 32px; height: 32px; margin-bottom: 8px; }
.type-option[data-type="support"] svg { fill: var(--type-support); stroke: var(--type-support); }
.type-option[data-type="bug"] svg { fill: var(--type-bug); stroke: var(--type-bug); }
.type-option[data-type="project"] svg { fill: var(--type-project); stroke: var(--type-project); }
.type-option[data-type="referral"] svg { fill: var(--type-referral); stroke: var(--type-referral); }
.type-option-title { font-weight: 600; font-size: 14px; margin-bottom: 4px; }
.type-option-desc { font-size: 12px; color: var(--text-secondary); }

/* Category Grid */
.category-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
.category-card { padding: 16px; border: 2px solid rgba(0,0,0,0.06); border-radius: 14px; cursor: pointer; text-align: center; transition: all 0.2s ease; background: rgba(255,255,255,0.5); }
.category-card:hover { border-color: var(--accent); background: rgba(255,255,255,0.7); }
.category-card.selected { border-color: var(--accent); background: rgba(245, 208, 227, 0.3); }
.category-card svg { width: 32px; height: 32px; fill: var(--grey-600); stroke: var(--grey-600); margin-bottom: 8px; }
.category-card.selected svg { fill: var(--accent); stroke: var(--accent); }
.category-card-title { font-size: 13px; font-weight: 500; }

/* Priority & Impact */
.priority-selector, .impact-selector { display: flex; gap: 8px; }
.priority-option, .impact-option { flex: 1; padding: 12px; border: 2px solid rgba(0,0,0,0.06); border-radius: 12px; cursor: pointer; text-align: center; font-size: 13px; font-weight: 500; transition: all 0.2s ease; background: rgba(255,255,255,0.5); }
.priority-option:hover, .impact-option:hover { border-color: var(--grey-400); }
.priority-option.selected, .impact-option.selected { color: var(--white); }
.priority-option.selected.low { background: var(--priority-low); border-color: var(--priority-low); }
.priority-option.selected.medium { background: var(--priority-medium); border-color: var(--priority-medium); }
.priority-option.selected.high { background: var(--priority-high); border-color: var(--priority-high); }
.priority-option.selected.urgent { background: var(--priority-urgent); border-color: var(--priority-urgent); }
.impact-option.selected.none { background: var(--grey-500); border-color: var(--grey-500); }
.impact-option.selected.minor { background: var(--priority-low); border-color: var(--priority-low); }
.impact-option.selected.moderate { background: var(--priority-medium); border-color: var(--priority-medium); }
.impact-option.selected.major { background: var(--priority-high); border-color: var(--priority-high); }
.impact-option.selected.critical { background: var(--priority-urgent); border-color: var(--priority-urgent); }

.referral-fields-group { margin-top: 16px; }

/* ========================================
   NOTIFICATION POPUP (modal overlay)
   ======================================== */
.notification-popup-overlay {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.4); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
    display: none; align-items: flex-start; justify-content: center;
    z-index: 1000; padding: 40px 20px;
}
.notification-popup-overlay.active { display: flex; }
.notification-popup-content {
    background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px);
    border-radius: 20px; width: 100%; max-width: 480px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.15);
    border: 1px solid rgba(255,255,255,0.4);
    max-height: 80vh; display: flex; flex-direction: column;
}
.notification-popup-content .modal-header { display: flex; justify-content: space-between; align-items: center; }
.notification-popup-actions { display: flex; align-items: center; gap: 8px; }
.notification-clear-btn { padding: 6px 12px; background: transparent; border: 1px solid rgba(0,0,0,0.12); border-radius: 8px; font-size: 12px; font-weight: 400; cursor: pointer; color: var(--text-muted); font-family: inherit; }
.notification-clear-btn:hover { background: rgba(0,0,0,0.04); color: var(--text-primary); }
.notification-list { overflow-y: auto; max-height: 60vh; scrollbar-width: none; -ms-overflow-style: none; }
.notification-list::-webkit-scrollbar { display: none; }
.notification-item { padding: 12px 16px; border-bottom: 1px solid rgba(0,0,0,0.04); cursor: pointer; transition: background 0.2s; }
.notification-item:hover { background: rgba(228, 50, 146, 0.06); }
.notification-item:last-child { border-bottom: none; }
.notification-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
.notification-ticket { font-weight: 600; color: var(--accent); font-size: 13px; }
.notification-time { font-size: 11px; color: var(--text-muted); }
.notification-subject { font-weight: 500; font-size: 14px; margin-bottom: 4px; color: var(--text-primary); }
.notification-message { font-size: 13px; color: var(--text-secondary); line-height: 1.4; }
.notification-message strong { color: var(--text-primary); }
.notification-empty { padding: 40px 20px; text-align: center; color: var(--text-muted); font-size: 14px; }
.notification-badge { display: none; }
.bell-ringing svg { animation: bellRing 0.5s ease; }

/* ========================================
   RULES & TASK HISTORY POPUPS
   ======================================== */
.rules-popup-overlay, .task-history-overlay {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.4); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
    display: none; align-items: flex-start; justify-content: center;
    z-index: 1000; padding: 40px 20px;
}
.rules-popup-overlay.active, .task-history-overlay.active { display: flex; }
.rules-popup-content, .task-history-content {
    background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px);
    border-radius: 24px; width: 100%; max-width: 520px; max-height: 85vh;
    overflow: hidden; display: flex; flex-direction: column;
    box-shadow: 0 24px 48px rgba(0,0,0,0.15); border: 1px solid rgba(255,255,255,0.3);
}
.task-history-content { max-width: 700px; }
.rules-popup-header, .task-history-header { padding: 20px 24px; background: linear-gradient(135deg, #e43292 0%, #c4287d 100%); color: var(--white); display: flex; justify-content: space-between; align-items: center; }
.rules-popup-header h3, .task-history-header h3 { font-size: 18px; font-weight: 600; margin: 0; }
.rules-popup-close, .task-history-close { background: rgba(255,255,255,0.2); border: none; color: var(--white); cursor: pointer; padding: 8px; border-radius: 10px; display: flex; align-items: center; justify-content: center; }
.rules-popup-close:hover, .task-history-close:hover { background: rgba(255,255,255,0.35); }
.rules-popup-close svg, .task-history-close svg { width: 24px; height: 24px; fill: currentColor; stroke: currentColor; }
.rules-popup-body { padding: 24px; overflow-y: auto; }
.rules-list { list-style: none; padding: 0; margin: 0; }
.rules-list li { padding: 12px 16px; border-bottom: 1px solid rgba(0,0,0,0.04); font-size: 14px; line-height: 1.5; display: flex; align-items: flex-start; gap: 10px; }
.rules-list li:last-child { border-bottom: none; }
.rules-list li svg { width: 18px; height: 18px; fill: var(--accent); flex-shrink: 0; margin-top: 2px; }
.rules-highlight { background: rgba(245, 208, 227, 0.4); border: 1px solid rgba(228, 50, 146, 0.3); border-radius: 14px; padding: 16px; margin-bottom: 16px; text-align: center; }
.rules-highlight-number { font-size: 28px; font-weight: 700; color: var(--accent); }
.rules-highlight-label { font-size: 13px; color: var(--text-secondary); margin-top: 4px; }
.rules-highlight-row { display: flex; gap: 16px; margin-bottom: 16px; }
.rules-highlight-row .rules-highlight { flex: 1; margin-bottom: 0; }

/* Task History */
.task-history-body { padding: 24px; overflow-y: auto; flex: 1; }
.task-history-table { width: 100%; border-collapse: collapse; font-size: 13px; }
.task-history-table th { text-align: left; padding: 10px 12px; background: rgba(248, 250, 252, 0.6); border-bottom: 2px solid rgba(0,0,0,0.06); font-weight: 600; font-size: 12px; text-transform: uppercase; letter-spacing: 0.3px; color: var(--text-secondary); white-space: nowrap; }
.task-history-table td { padding: 10px 12px; border-bottom: 1px solid rgba(0,0,0,0.04); vertical-align: top; }
.task-history-table tr:hover td { background: rgba(248, 250, 252, 0.5); }
.task-history-type-badge { display: inline-block; padding: 2px 8px; border-radius: 8px; font-size: 11px; font-weight: 600; }
.task-history-type-badge.PROJECT { background: rgba(156, 39, 176, 0.12); color: var(--type-project); }
.task-history-type-badge.REFERRAL { background: rgba(0, 150, 136, 0.12); color: var(--type-referral); }
.task-history-type-badge.FEEDBACK { background: rgba(33, 150, 243, 0.12); color: var(--type-support); }
.task-history-type-badge.SUPPORT { background: rgba(33, 150, 243, 0.12); color: var(--type-support); }
.task-history-type-badge.BUG { background: rgba(244, 67, 54, 0.12); color: var(--type-bug); }
.task-history-type-badge.UNUSED { background: rgba(255, 152, 0, 0.12); color: #e65100; }
.task-history-type-badge.OVERUSE { background: rgba(244, 67, 54, 0.12); color: #c62828; }
.task-history-type-badge.RENEWAL { background: rgba(76, 175, 80, 0.12); color: #2e7d32; }
.task-history-empty { text-align: center; padding: 40px 20px; color: var(--text-muted); font-size: 14px; }
.task-history-summary { display: flex; gap: 16px; margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid rgba(0,0,0,0.06); }
.task-history-stat { flex: 1; text-align: center; padding: 12px; background: rgba(248, 250, 252, 0.5); border-radius: 12px; }
.task-history-stat-value { font-size: 22px; font-weight: 700; color: var(--accent); }
.task-history-stat-label { font-size: 11px; color: var(--text-secondary); margin-top: 2px; }

/* PO Checkbox */
.po-checkbox-wrapper { display: flex; align-items: center; gap: 8px; padding: 10px 0; cursor: pointer; user-select: none; }
.po-checkbox { width: 18px; height: 18px; accent-color: var(--accent); cursor: pointer; }
.po-checkbox-text { font-size: 13px; font-weight: 500; color: var(--grey-800); }
.po-status-badge { display: inline-flex; align-items: center; gap: 4px; padding: 3px 8px; border-radius: 8px; font-size: 11px; font-weight: 600; }
.po-status-badge.received { background: rgba(232, 245, 233, 0.7); color: #2e7d32; }
.po-status-badge.pending { background: rgba(255, 243, 224, 0.7); color: #e65100; }

/* ========================================
   TOAST
   ======================================== */
.toast { position: fixed; bottom: 24px; right: 24px; background: var(--text-primary); color: var(--white); padding: 16px 24px; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.2); display: none; align-items: center; gap: 12px; z-index: 1001; animation: slideIn 0.3s ease; backdrop-filter: blur(16px); }
.toast.show { display: flex; }
.toast.success { background: #388e3c; }
.toast.error { background: #d32f2f; }

/* ========================================
   IMAGE MODAL
   ======================================== */
.image-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; z-index: 1002; cursor: pointer; }
.image-modal.active { display: flex; }
.image-modal img { max-width: 90%; max-height: 90%; object-fit: contain; border-radius: 8px; }

/* No Tasks Warning */
.no-tasks-warning { background: rgba(255, 243, 224, 0.7); border: 1px solid rgba(255, 183, 77, 0.5); border-radius: 12px; padding: 12px 16px; margin: 12px 0; display: flex; align-items: center; gap: 8px; font-size: 13px; color: #e65100; }
.no-tasks-warning svg { width: 20px; height: 20px; fill: #e65100; flex-shrink: 0; }

/* Feedback Button */
.feedback-btn { display: flex; align-items: center; gap: 5px; background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3); color: #fff; padding: 6px 12px; border-radius: 10px; cursor: pointer; font-size: 12px; font-weight: 600; transition: background 0.2s; white-space: nowrap; font-family: inherit; }
.feedback-btn:hover { background: rgba(255,255,255,0.25); }
.feedback-btn svg { width: 16px; height: 16px; fill: currentColor; stroke: currentColor; }

/* Opportunity Badge */
.opportunity-badge { display: inline-flex; align-items: center; gap: 5px; padding: 4px 10px; border-radius: 8px; font-size: 12px; font-weight: 600; white-space: nowrap; }
.opportunity-badge-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }

/* ========================================
   MOBILE OVERLAY
   ======================================== */
.mobile-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); z-index: 998; }
.mobile-overlay.active { display: block; }
.mobile-back-btn { display: none; align-items: center; gap: 6px; padding: 10px 16px; background: rgba(255, 255, 255, 0.6); border: none; border-radius: 12px; color: var(--text-secondary); font-size: 14px; font-weight: 500; cursor: pointer; margin-bottom: 12px; font-family: inherit; }
.mobile-back-btn svg { width: 18px; height: 18px; stroke: var(--text-secondary); }
.mobile-back-btn.visible { display: flex; }

/* ========================================
   REFERRAL MODAL
   ======================================== */
.referral-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(8px); display: none; align-items: flex-start; padding: 40px 20px; justify-content: center; z-index: 1000; }
.referral-modal.active { display: flex; }
.referral-modal-content { background: rgba(255,255,255,0.95); backdrop-filter: blur(24px); border-radius: 24px; width: 100%; max-width: 500px; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 24px 48px rgba(0,0,0,0.15); }
.referral-modal-header { padding: 20px 24px; background: linear-gradient(135deg, #e43292 0%, #c4287d 100%); color: var(--white); display: flex; justify-content: space-between; align-items: center; }
.referral-modal-title { font-size: 18px; font-weight: 600; }
.referral-modal-close { background: transparent; border: none; color: var(--white); cursor: pointer; padding: 4px; }
.referral-modal-close svg { width: 24px; height: 24px; fill: currentColor; }
.referral-modal-body { padding: 24px; overflow-y: auto; }
.referral-form-group { margin-bottom: 16px; }
.referral-form-label { display: block; font-weight: 500; margin-bottom: 6px; font-size: 14px; }
.referral-form-input, .referral-form-textarea { width: 100%; padding: 10px 14px; border: 1px solid rgba(0,0,0,0.08); border-radius: 12px; font-size: 14px; font-family: inherit; background: rgba(255,255,255,0.6); }
.referral-form-input:focus, .referral-form-textarea:focus { outline: none; border-color: var(--accent); }
.referral-form-textarea { resize: vertical; min-height: 80px; }
.referral-submit-btn { width: 100%; padding: 12px; background: linear-gradient(135deg, #e43292 0%, #c4287d 100%); color: var(--white); border: none; border-radius: 12px; font-weight: 600; cursor: pointer; margin-top: 8px; font-family: inherit; }
.referral-submit-btn:hover { transform: translateY(-1px); }
.referral-list { margin-top: 24px; border-top: 1px solid rgba(0,0,0,0.06); padding-top: 16px; }
.referral-list-title { font-weight: 600; font-size: 14px; margin-bottom: 12px; }
.referral-item { padding: 12px; background: rgba(248, 250, 252, 0.5); border-radius: 12px; margin-bottom: 8px; }
.referral-item-company { font-weight: 600; font-size: 14px; }
.referral-item-email { font-size: 13px; color: var(--text-secondary); }
.referral-item-date { font-size: 11px; color: var(--text-muted); margin-top: 4px; }
.referral-bonus { background: rgba(245, 208, 227, 0.4); color: var(--accent-dark); padding: 12px; border-radius: 12px; text-align: center; margin-bottom: 16px; }
.referral-bonus strong { font-size: 18px; }

/* ========================================
   RESPONSIVE: TABLET (768-1024px)
   ======================================== */
@media (max-width: 1024px) {
    .sidebar { width: 240px; padding: 20px 14px; }
    .sidebar.collapsed { width: 72px; padding: 20px 20px 20px 12px; }
    .main-grid { grid-template-columns: 1fr 1.5fr; gap: 16px; }
    .stats-row { gap: 12px; }
    .stat-card { padding: 16px 18px; }
    .stat-value { font-size: 24px; }
    .header-buttons { gap: 8px; }
    .search-box { width: 200px; }
}

/* ========================================
   RESPONSIVE: MOBILE (below 768px)
   ======================================== */
@media (max-width: 768px) {
    .mobile-menu-btn { display: flex; }
    .sidebar-wrapper { position: fixed; top: 0; left: -300px; height: 100vh; z-index: 999; transition: left 0.3s ease; }
    .sidebar-wrapper.mobile-open { left: 0; }
    .sidebar { width: 280px; height: 100vh; box-shadow: 4px 0 24px rgba(0, 0, 0, 0.15); }
    .sidebar.collapsed { width: 280px; padding: 24px 18px; border-right: 1px solid rgba(255, 255, 255, 0.3); }
    .sidebar.collapsed .logo-text, .sidebar.collapsed .contract-title, .sidebar.collapsed .contract-stats, .sidebar.collapsed .contract-progress, .sidebar.collapsed .contract-footer, .sidebar.collapsed .section-label, .sidebar.collapsed .type-tab-label, .sidebar.collapsed .type-tab-count, .sidebar.collapsed .action-btn-label, .sidebar.collapsed .user-info-text, .sidebar.collapsed .user-dropdown { display: block; }
    .sidebar.collapsed .contract-mini { display: none; }
    .sidebar.collapsed .logo-section, .sidebar.collapsed .type-tab, .sidebar.collapsed .action-btn, .sidebar.collapsed .user-account { justify-content: flex-start; }
    .sidebar.collapsed .action-badge { position: static; }
    .collapse-btn { display: none; }
    .main-content { padding: 12px; width: 100%; }
    .header { padding: 12px 16px; margin-bottom: 12px; min-height: auto; border-radius: 16px; }
    .header-title { font-size: 20px; }
    .header-actions { gap: 8px; }
    .search-box { display: none; }
    .header-branding { display: none !important; }
    .header-btn-label { display: none; }
    .header-btn-group { gap: 0; }
    .header-btn { width: 40px; height: 40px; border-radius: 12px; }
    .new-ticket-btn { padding: 0 16px; height: 40px; font-size: 13px; }
    .new-ticket-btn span { display: none; }
    .new-ticket-btn svg { margin: 0; }
    .stats-row { grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 12px; }
    .stat-card { padding: 14px 16px; border-radius: 16px; }
    .stat-icon { width: 40px; height: 40px; border-radius: 12px; }
    .stat-icon svg { width: 20px; height: 20px; }
    .stat-value { font-size: 22px; }
    .stat-label { font-size: 11px; }
    .status-tabs-row { grid-template-columns: 1fr; margin-bottom: 12px; gap: 10px; }
    .status-tabs { overflow-x: auto; white-space: nowrap; padding: 4px; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
    .status-tabs::-webkit-scrollbar { display: none; }
    .status-tab { padding: 8px 14px; font-size: 12px; }
    .filters-row { justify-content: flex-start; }
    .main-grid { grid-template-columns: 1fr; gap: 0; position: relative; }
    .ticket-list { border-radius: 20px; max-height: none; }
    .ticket-list.hidden-mobile { display: none; }
    .ticket-list-column.hidden-mobile { display: none; }
    .ticket-detail-panel { display: none; border-radius: 20px; }
    .ticket-detail-panel.active { display: flex; }
    .ticket-item { padding: 14px 16px; gap: 12px; }
    .ticket-subject { font-size: 14px; }
    .ticket-status { font-size: 10px; padding: 3px 8px; }
    .ticket-meta { font-size: 11px; }
    .detail-header { padding: 16px; }
    .detail-title { font-size: 18px; }
    .detail-section { padding: 14px 16px; }
    .detail-info-grid { grid-template-columns: 1fr; }
    .category-grid { grid-template-columns: 1fr 1fr; }
    .modal { margin: 20px; max-width: calc(100% - 40px); border-radius: 20px; }
    .modal-header { padding: 18px 20px; }
    .modal-title { font-size: 16px; }
    .modal-body { padding: 20px; }
}

/* ========================================
   RESPONSIVE: SMALL MOBILE (below 480px)
   ======================================== */
@media (max-width: 480px) {
    .header { padding: 10px 12px; }
    .header-title { font-size: 18px; }
    .header-btn { width: 36px; height: 36px; }
    .header-btn svg, .header-btn img { width: 16px; height: 16px; }
    .new-ticket-btn { width: 36px; height: 36px; padding: 0; border-radius: 50%; justify-content: center; }
    .stats-row { gap: 8px; }
    .stat-card { padding: 12px; gap: 10px; }
    .stat-icon { width: 36px; height: 36px; }
    .stat-value { font-size: 20px; }
    .ticket-item { padding: 12px; }
    .ticket-subject { font-size: 13px; }
    .ticket-type-selector { flex-direction: column; }
    .priority-selector, .impact-selector { flex-wrap: wrap; }
    .priority-option, .impact-option { flex: 1 1 45%; }
}

    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay"><div class="loader"></div></div>
    <audio id="notificationSound" preload="auto"><source src="data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA//tQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAABhgC7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7//////////////////////////////////////////////////////////////////8AAAAATGF2YzU4LjEzAAAAAAAAAAAAAAAAJAAAAAAAAAAAAYYNjnFZAAAAAAAAAAAAAAAAAAAA" type="audio/mp3"></audio>

    <div class="app">
        <!-- Mobile Overlay -->
        <div class="mobile-overlay" id="mobileOverlay"></div>

        <!-- Sidebar Wrapper -->
        <div class="sidebar-wrapper" id="sidebarWrapper">
            <div class="sidebar" id="sidebar">
                <!-- Sidebar scrollable content -->
                <div class="sidebar-content">
                    <!-- Logo -->
                    <div class="logo-section">
                        <div class="logo-icon">
                            <img src="https://static.wixstatic.com/media/65ccc7_382b4222d3644830a86f3e629bfcfdcb~mv2.png" alt="Tiny Panda" style="width: 28px; height: 28px; object-fit: contain;">
                        </div>
                        <div class="logo-text">
                            <div class="logo-title">Project Support Desk</div>
                            <div class="logo-subtitle">Tiny Panda</div>
                        </div>
                    </div>

                    <!-- Contract Card -->
                    <div class="contract-card" id="contractBanner">
                        <div class="contract-title" id="contractName">-</div>
                        <div class="contract-stats">
                            <div class="contract-stat">
                                <div class="contract-stat-value" id="baseTasks">0</div>
                                <div class="contract-stat-label">Contracted</div>
                            </div>
                            <div class="contract-stat">
                                <div class="contract-stat-value" id="adjustedTasks">0</div>
                                <div class="contract-stat-label">Available</div>
                            </div>
                        </div>
                        <div class="contract-progress" id="contractMonthly">
                            <div class="contract-progress-bar" id="monthlyProgressFill" style="width:0%"></div>
                        </div>
                        <div class="contract-footer"><span id="usedThisMonth">0</span> of <span id="monthlyLimit">0</span> used this month</div>
                        <div class="contract-mini">
                            <div class="contract-mini-value"><span class="contract-mini-used">0</span>/<span class="contract-mini-total">0</span></div>
                            <div class="contract-mini-label">used</div>
                        </div>
                    </div>

                    <!-- Ticket Types -->
                    <div class="section-label">Ticket Types</div>
                    <div class="type-tabs" id="ticketTypeTabs">
                        <button class="type-tab active ticket-type-tab" data-type="all">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M15 5v2"></path><path d="M15 11v2"></path><path d="M15 17v2"></path>
                                <path d="M5 5h14a2 2 0 0 1 2 2v3a2 2 0 0 0 0 4v3a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-3a2 2 0 0 0 0-4V7a2 2 0 0 1 2-2z"></path>
                            </svg>
                            <span class="type-tab-label">All Tickets</span>
                            <span class="type-tab-count" id="allTypeCount">0</span>
                        </button>
                        <button class="type-tab support ticket-type-tab" data-type="support">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M3 18v-6a9 9 0 0 1 18 0v6"></path>
                                <path d="M21 19a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2h3zM3 19a2 2 0 0 0 2 2h1a2 2 0 0 0 2-2v-3a2 2 0 0 0-2-2H3z"></path>
                            </svg>
                            <span class="type-tab-label">Support</span>
                            <span class="type-tab-count" id="supportTypeCount">0</span>
                        </button>
                        <button class="type-tab bug ticket-type-tab" data-type="bug">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="m8 2 1.88 1.88"></path><path d="M14.12 3.88 16 2"></path>
                                <path d="M9 7.13v-1a3.003 3.003 0 1 1 6 0v1"></path>
                                <path d="M12 20c-3.3 0-6-2.7-6-6v-3a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v3c0 3.3-2.7 6-6 6"></path>
                                <path d="M12 20v-9"></path>
                                <path d="M6.53 9C4.6 8.8 3 7.1 3 5"></path><path d="M6 13H2"></path>
                                <path d="M3 21c0-2.1 1.7-3.9 3.8-4"></path><path d="M20.97 5c0 2.1-1.6 3.8-3.5 4"></path>
                                <path d="M22 13h-4"></path><path d="M17.2 17c2.1.1 3.8 1.9 3.8 4"></path>
                            </svg>
                            <span class="type-tab-label">Bugs</span>
                            <span class="type-tab-count" id="bugTypeCount">0</span>
                        </button>
                        <button class="type-tab project ticket-type-tab" data-type="project">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.2A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13c0 1.1.9 2 2 2Z"></path>
                                <path d="M8 10v4"></path><path d="M12 10v2"></path><path d="M16 10v6"></path>
                            </svg>
                            <span class="type-tab-label">Projects</span>
                            <span class="type-tab-count" id="projectTypeCount">0</span>
                        </button>
                        <button class="type-tab referral ticket-type-tab" data-type="referral">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="m11 17 2 2a1 1 0 1 0 3-3"></path>
                                <path d="m14 14 2.5 2.5a1 1 0 1 0 3-3l-3.88-3.88a3 3 0 0 0-4.24 0l-.88.88a1 1 0 1 1-3-3l2.81-2.81a5.79 5.79 0 0 1 7.06-.87l.47.28a2 2 0 0 0 1.42.25L21 4"></path>
                                <path d="m21 3 1 11h-2"></path>
                                <path d="M3 3 2 14l6.5 6.5a1 1 0 1 0 3-3"></path><path d="M3 4h8"></path>
                            </svg>
                            <span class="type-tab-label">Referrals</span>
                            <span class="type-tab-count" id="referralTypeCount">0</span>
                        </button>
                    </div>

                    <!-- Quick Actions -->
                    <div class="section-label">Quick Actions</div>
                    <div class="quick-actions">
                        <button class="action-btn" id="rulesBtn">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M8 21h12a2 2 0 0 0 2-2v-2H10v2a2 2 0 1 1-4 0V5a2 2 0 1 0-4 0v3h4"></path>
                                <path d="M19 17V5a2 2 0 0 0-2-2H4"></path>
                            </svg>
                            <span class="action-btn-label">Rules</span>
                        </button>
                        <button class="action-btn" id="taskHistoryBtn">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="12" y1="20" x2="12" y2="10"></line>
                                <line x1="18" y1="20" x2="18" y2="4"></line>
                                <line x1="6" y1="20" x2="6" y2="16"></line>
                            </svg>
                            <span class="action-btn-label">Task History</span>
                        </button>
                        <button class="action-btn" id="feedbackBtn">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                            </svg>
                            <span class="action-btn-label">Feedback</span>
                        </button>
                        <div class="notification-wrapper">
                            <button class="action-btn" id="notificationBtn">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"></path>
                                    <path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"></path>
                                </svg>
                                <span class="action-btn-label">Notifications</span>
                                <span class="action-badge hidden" id="notificationBadge">0</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- User Account - Fixed at bottom -->
                <div class="user-account glass-card" id="userInfo">
                    <div class="user-avatar" id="userAvatar">?</div>
                    <div class="user-info-text">
                        <div class="user-name" id="userName">Loading...</div>
                    </div>
                    <span class="user-dropdown"></span>
                </div>
                <!-- Account Dropdown -->
                <div class="account-dropdown" id="accountDropdown">
                    <div class="account-dropdown-header" id="accountUserName">Account</div>
                    <button class="account-dropdown-item" id="accountBtn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                        Account Settings
                    </button>
                    <button class="account-dropdown-item" id="logoutBtn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                            <polyline points="16 17 21 12 16 7"></polyline>
                            <line x1="21" y1="12" x2="9" y2="12"></line>
                        </svg>
                        Logout
                    </button>
                </div>
            </div>

            <!-- Collapse button -->
            <button class="collapse-btn" id="collapseBtn" title="Toggle sidebar">
                <svg id="collapseIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M11 7l-4 5 4 5"></path>
                    <path d="M17 7l-4 5 4 5"></path>
                </svg>
            </button>
        </div>

        <!-- Main Content -->
        <div class="main-content" id="mainContent">
            <!-- Header -->
            <header class="header glass">
                <div class="header-left">
                    <button class="mobile-menu-btn" id="mobileMenuBtn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="3" y1="12" x2="21" y2="12"></line>
                            <line x1="3" y1="6" x2="21" y2="6"></line>
                            <line x1="3" y1="18" x2="21" y2="18"></line>
                        </svg>
                    </button>
                    <h1 class="header-title">Tickets</h1>
                    <span class="live-indicator" id="liveIndicator" style="display: none;">Live</span>
                </div>
                <!-- Company Branding (shown when profile has company) -->
                <div class="header-branding" id="headerCenter" style="display: none;">
                    <img class="company-logo" id="companyLogo" src="" alt="Company Logo" style="display: none;">
                    <div class="company-name" id="companyName"></div>
                </div>
                <div class="header-actions">
                    <div class="search-box">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                        <input type="text" id="searchInput" placeholder="Search tickets...">
                    </div>
                    <div class="header-buttons">
                        <div class="header-btn-group">
                            <button class="header-btn pacman" id="pacmanBtn">
                                <img src="https://static.wixstatic.com/media/65ccc7_953f1c7576724572800deed9cdf2957b~mv2.png" alt="Pacman" style="width: 20px; height: 20px;">
                            </button>
                            <span class="header-btn-label">Pacman</span>
                        </div>
                        <div class="header-btn-group">
                            <button class="header-btn project" id="projectBtn" disabled>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.2A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13c0 1.1.9 2 2 2Z"></path>
                                </svg>
                            </button>
                            <span class="header-btn-label">Project</span>
                        </div>
                        <div class="header-btn-group">
                            <button class="header-btn branding" id="brandingBtn">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="13.5" cy="6.5" r=".5"></circle><circle cx="17.5" cy="10.5" r=".5"></circle>
                                    <circle cx="8.5" cy="7.5" r=".5"></circle><circle cx="6.5" cy="12.5" r=".5"></circle>
                                    <path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.555C21.965 6.012 17.461 2 12 2z"></path>
                                </svg>
                            </button>
                            <span class="header-btn-label">Branding</span>
                        </div>
                    </div>
                    <button class="new-ticket-btn" id="newTicketBtn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        <span>New Ticket</span>
                    </button>
                </div>
            </header>

            <!-- Profile Setup Banner -->
            <div class="profile-setup-banner" id="profileSetupBanner" style="display: none;">
                <div class="profile-setup-content">
                    <div class="profile-setup-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                    </div>
                    <div class="profile-setup-text">
                        <strong>Complete your profile</strong>
                        <span>Please enter your name and company to continue</span>
                    </div>
                    <div class="profile-setup-form">
                        <input type="text" id="profileNameInput" placeholder="Your Name" class="profile-input">
                        <input type="text" id="profileCompanyInput" placeholder="Company Name" class="profile-input">
                        <button class="btn btn-primary" id="saveProfileBtn">Save Profile</button>
                    </div>
                </div>
            </div>

            <!-- Access Denied -->
            <div class="access-denied" id="accessDenied" style="display: none;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                </svg>
                <h2>Access Denied</h2>
                <p id="accessDeniedMessage">Your email is not registered in the system. Please contact the administrator.</p>
            </div>

            <!-- Content Area -->
            <div class="content-area">
                <!-- Fixed content above grid -->
                <div class="content-fixed">
                    <!-- Stats Row -->
                    <div class="stats-row" id="statsBar">
                        <div class="stat-card glass-card">
                            <div class="stat-icon pink">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M15 5v2"></path><path d="M15 11v2"></path><path d="M15 17v2"></path>
                                    <path d="M5 5h14a2 2 0 0 1 2 2v3a2 2 0 0 0 0 4v3a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-3a2 2 0 0 0 0-4V7a2 2 0 0 1 2-2z"></path>
                                </svg>
                            </div>
                            <div>
                                <div class="stat-label">Total Tickets</div>
                                <div class="stat-value pink" id="totalTickets">0</div>
                            </div>
                        </div>
                        <div class="stat-card glass-card">
                            <div class="stat-icon blue">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path>
                                    <polyline points="14 2 14 8 20 8"></polyline>
                                </svg>
                            </div>
                            <div>
                                <div class="stat-label">Open</div>
                                <div class="stat-value blue" id="openTickets">0</div>
                            </div>
                        </div>
                        <div class="stat-card glass-card">
                            <div class="stat-icon orange">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <line x1="12" y1="2" x2="12" y2="6"></line><line x1="12" y1="18" x2="12" y2="22"></line>
                                    <line x1="4.93" y1="4.93" x2="7.76" y2="7.76"></line><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"></line>
                                    <line x1="2" y1="12" x2="6" y2="12"></line><line x1="18" y1="12" x2="22" y2="12"></line>
                                    <line x1="4.93" y1="19.07" x2="7.76" y2="16.24"></line><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"></line>
                                </svg>
                            </div>
                            <div>
                                <div class="stat-label">In Progress</div>
                                <div class="stat-value orange" id="inProgressTickets">0</div>
                            </div>
                        </div>
                        <div class="stat-card glass-card">
                            <div class="stat-icon green">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                                </svg>
                            </div>
                            <div>
                                <div class="stat-label">Resolved</div>
                                <div class="stat-value green" id="resolvedTickets">0</div>
                            </div>
                        </div>
                    </div>

                    <!-- Status Tabs & Filters -->
                    <div class="status-tabs-row">
                        <div class="status-tabs glass-dark" id="statusTabs">
                            <button class="status-tab tab active" data-tab="all">All Tickets</button>
                            <button class="status-tab tab" data-tab="open">Open</button>
                            <button class="status-tab tab" data-tab="in-progress">In Progress</button>
                            <button class="status-tab tab" data-tab="resolved">Resolved</button>
                        </div>
                        <div class="filters-row">
                            <select class="filter-select" id="priorityFilter">
                                <option value="">All Priorities</option>
                                <option value="low">Low</option>
                                <option value="medium">Medium</option>
                                <option value="high">High</option>
                                <option value="urgent">Urgent</option>
                            </select>
                            <select class="filter-select" id="userFilter" style="display: none;">
                                <option value="">All Users</option>
                            </select>
                            <select class="filter-select" id="companyFilter" style="display: none;">
                                <option value="">All Companies</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Main Grid -->
                <div class="main-grid">
                    <!-- Ticket List Column -->
                    <div class="ticket-list-column">
                        <div class="ticket-list glass-card" id="ticketList">
                        <div class="empty-state">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.2A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13c0 1.1.9 2 2 2Z"></path>
                            </svg>
                            <h3>No tickets yet</h3>
                            <p>Create your first ticket to get started</p>
                        </div>
                    </div>
                    </div>

                    <!-- Mobile Back Button -->
                    <button class="mobile-back-btn" id="mobileBackBtn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M19 12H5"></path>
                            <path d="M12 19l-7-7 7-7"></path>
                        </svg>
                        Back to Tickets
                    </button>

                    <!-- Ticket Detail -->
                    <div class="ticket-detail-panel glass-card" id="ticketDetailPanel">
                        <div class="empty-state" id="noTicketSelected">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                            </svg>
                            <h3>Select a ticket</h3>
                            <p>Choose a ticket from the list to view details</p>
                        </div>
                        <div class="ticket-detail-content" id="ticketDetailContent" style="display: none;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- No Tasks Warning -->
    <div class="no-tasks-warning" id="noTasksWarning" style="display: none;">
        You have reached your monthly task limit. Please contact support for additional tasks.
    </div>

    <!-- New Ticket Modal -->
    <div class="modal-overlay" id="newTicketModal">
        <div class="modal glass-card">
            <div class="modal-header">
                <h2 class="modal-title">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    <span>Create New Ticket</span>
                </h2>
                <button class="modal-close" id="closeModal">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <form id="ticketForm">
                    <!-- Ticket Type Selector -->
                    <div class="form-group">
                        <label class="form-label">What type of request is this? <span class="required">*</span></label>
                        <div class="ticket-type-selector" id="ticketTypeSelector">
                            <div class="type-option selected" data-type="support">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M3 18v-6a9 9 0 0 1 18 0v6"></path>
                                    <path d="M21 19a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2h3zM3 19a2 2 0 0 0 2 2h1a2 2 0 0 0 2-2v-3a2 2 0 0 0-2-2H3z"></path>
                                </svg>
                                <div class="type-option-title">Support</div>
                                <div class="type-option-desc">Help with existing features</div>
                            </div>
                            <div class="type-option" data-type="bug">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="m8 2 1.88 1.88"></path><path d="M14.12 3.88 16 2"></path>
                                    <path d="M9 7.13v-1a3.003 3.003 0 1 1 6 0v1"></path>
                                    <path d="M12 20c-3.3 0-6-2.7-6-6v-3a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v3c0 3.3-2.7 6-6 6"></path>
                                </svg>
                                <div class="type-option-title">Bug Report</div>
                                <div class="type-option-desc">Something isn't working (FREE)</div>
                            </div>
                            <div class="type-option" data-type="project">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.2A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13c0 1.1.9 2 2 2Z"></path>
                                </svg>
                                <div class="type-option-title">New Project</div>
                                <div class="type-option-desc">Request new development</div>
                            </div>
                            <div class="type-option" data-type="referral">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="m11 17 2 2a1 1 0 1 0 3-3"></path>
                                    <path d="m14 14 2.5 2.5a1 1 0 1 0 3-3l-3.88-3.88a3 3 0 0 0-4.24 0l-.88.88a1 1 0 1 1-3-3l2.81-2.81a5.79 5.79 0 0 1 7.06-.87l.47.28a2 2 0 0 0 1.42.25L21 4"></path>
                                </svg>
                                <div class="type-option-title">Referral</div>
                                <div class="type-option-desc">Refer a company</div>
                            </div>
                        </div>
                    </div>

                    <!-- Referral Fields -->
                    <div id="referralFieldsGroup" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">Company Being Referred <span class="required">*</span></label>
                            <input type="text" id="referralCompanyName" class="form-input" placeholder="Company name">
                            <div class="field-error" id="referralCompanyError">Company name is required</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Contact Email <span class="required">*</span></label>
                            <input type="email" id="referralEmailAddress" class="form-input" placeholder="contact@company.com">
                            <div class="field-error" id="referralEmailError">Valid email address is required</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone (Optional)</label>
                            <input type="text" id="referralPhoneNumber" class="form-input" placeholder="+44 123 456 7890">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Comment (Optional)</label>
                            <textarea id="referralCommentText" class="form-textarea" style="min-height: 80px;" placeholder="Any additional information..."></textarea>
                        </div>
                    </div>

                    <!-- Category (Support only) -->
                    <div class="form-group" id="categoryFormGroup">
                        <label class="form-label">Category</label>
                        <div class="category-grid" id="categoryGrid">
                            <div class="category-card" data-category="other">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
                                </svg>
                                <div class="category-card-title">Custom / Type your own</div>
                            </div>
                            <div class="category-card" data-category="domains">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <line x1="2" y1="12" x2="22" y2="12"></line>
                                    <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                                </svg>
                                <div class="category-card-title">Domains & Account</div>
                            </div>
                            <div class="category-card" data-category="billing">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                                    <line x1="1" y1="10" x2="23" y2="10"></line>
                                </svg>
                                <div class="category-card-title">Plans & Billing</div>
                            </div>
                            <div class="category-card" data-category="payments">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <line x1="12" y1="1" x2="12" y2="23"></line>
                                    <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                                </svg>
                                <div class="category-card-title">Payments</div>
                            </div>
                            <div class="category-card" data-category="marketing">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                                </svg>
                                <div class="category-card-title">Marketing & SEO</div>
                            </div>
                            <div class="category-card" data-category="stores">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle>
                                    <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                                </svg>
                                <div class="category-card-title">Wix Stores</div>
                            </div>
                            <div class="category-card" data-category="memberships">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                    <circle cx="9" cy="7" r="4"></circle>
                                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                                </svg>
                                <div class="category-card-title">Memberships & Events</div>
                            </div>
                            <div class="category-card" data-category="velo">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="16 18 22 12 16 6"></polyline>
                                    <polyline points="8 6 2 12 8 18"></polyline>
                                </svg>
                                <div class="category-card-title">Velo & CMS</div>
                            </div>
                            <div class="category-card" data-category="content">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                    <line x1="3" y1="9" x2="21" y2="9"></line>
                                    <line x1="9" y1="21" x2="9" y2="9"></line>
                                </svg>
                                <div class="category-card-title">Content / Design</div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group" id="subjectFormGroup">
                        <label class="form-label">Subject <span class="required">*</span></label>
                        <input type="text" id="ticketSubject" class="form-input" placeholder="Brief description of your issue">
                        <div class="field-error" id="subjectError">Subject is required (min 5 characters)</div>
                    </div>

                    <div class="form-group" id="descriptionFormGroup">
                        <label class="form-label">Description <span class="required">*</span></label>
                        <textarea id="ticketDescription" class="form-textarea" placeholder="Please provide as much detail as possible..."></textarea>
                        <div class="field-error" id="descriptionError">Description is required (min 10 characters)</div>
                    </div>

                    <div class="form-group" id="priorityFormGroup">
                        <label class="form-label">Priority</label>
                        <div class="priority-selector" id="prioritySelector">
                            <div class="priority-option low" data-priority="low">Low</div>
                            <div class="priority-option medium selected" data-priority="medium">Medium</div>
                            <div class="priority-option high" data-priority="high">High</div>
                            <div class="priority-option urgent" data-priority="urgent">Urgent</div>
                        </div>
                    </div>

                    <div class="form-group" id="impactFormGroup">
                        <label class="form-label">Business Impact</label>
                        <div class="impact-selector" id="impactSelector">
                            <div class="impact-option none" data-impact="none">None</div>
                            <div class="impact-option minor" data-impact="minor">Minor</div>
                            <div class="impact-option moderate selected" data-impact="moderate">Moderate</div>
                            <div class="impact-option major" data-impact="major">Major</div>
                            <div class="impact-option critical" data-impact="critical">Critical</div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelTicket">Cancel</button>
                <button class="btn btn-primary" id="submitTicket">
                    <span class="btn-text">Create Ticket</span>
                    <span class="btn-loader" style="display: none;"></span>
                </button>
            </div>
        </div>
    </div>

    <!-- Notification Popup (modal overlay) -->
    <div class="modal-overlay notification-popup-overlay" id="notificationPopup">
        <div class="modal glass-card notification-popup-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"></path>
                        <path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"></path>
                    </svg>
                    <span>Notifications</span>
                </h3>
                <div class="notification-popup-actions">
                    <button class="notification-clear-btn" id="clearAllNotifications">Clear All</button>
                    <button class="modal-close" id="closeNotificationPopup">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="modal-body">
                <div class="notification-list" id="notificationList">
                    <div class="notification-empty">No new notifications</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Rules Popup -->
    <div class="modal-overlay rules-popup-overlay" id="rulesPopup">
        <div class="modal glass-card rules-popup-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M8 21h12a2 2 0 0 0 2-2v-2H10v2a2 2 0 1 1-4 0V5a2 2 0 1 0-4 0v3h4"></path>
                        <path d="M19 17V5a2 2 0 0 0-2-2H4"></path>
                    </svg>
                    <span>Contract Rules</span>
                </h3>
                <button class="modal-close" id="closeRulesPopup">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="modal-body" id="rulesPopupBody">
                <!-- Populated dynamically -->
            </div>
        </div>
    </div>

    <!-- Task History Popup -->
    <div class="modal-overlay task-history-overlay" id="taskHistoryPopup">
        <div class="modal glass-card task-history-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="12" y1="20" x2="12" y2="10"></line>
                        <line x1="18" y1="20" x2="18" y2="4"></line>
                        <line x1="6" y1="20" x2="6" y2="16"></line>
                    </svg>
                    <span>Task History</span>
                </h3>
                <button class="modal-close" id="closeTaskHistoryPopup">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="modal-body" id="taskHistoryPopupBody">
                <div style="text-align:center;padding:40px;color:#94a3b8;">Loading task history...</div>
            </div>
        </div>
    </div>

    <!-- Image Modal -->
    <div class="image-modal" id="imageModal">
        <img src="" alt="Full size image" id="imageModalImg">
    </div>

    <!-- Toast -->
    <div class="toast" id="toast">
        <span id="toastMessage"></span>
    </div>

    <!-- JavaScript -->
    <script>
// ==========================================
// HELPDESK UI SCRIPTS - helpdesk-scripts.js
// ==========================================

// ==========================================
// STATE MANAGEMENT
// ==========================================
const state = {
    user: null,
    profile: null,
    isAdmin: false,
    domain: null,
    tickets: [],
    users: [],
    companies: [],
    selectedTicket: null,
    selectedCategory: null,
    selectedPriority: 'medium',
    selectedImpact: 'moderate',
    selectedTicketType: 'support',
    currentStatusFilter: 'all',
    currentTypeFilter: 'all',
    searchQuery: '',
    priorityFilter: '',
    userFilter: '',
    companyFilter: '',
    pendingAttachment: null,
    contract: null,
    referrals: [],
    referralCount: 0,
    taskHistory: [],
    notificationCount: 0,
    unreadNotes: {},
    notifications: []
};

// ==========================================
// INITIALIZATION
// ==========================================
document.addEventListener('DOMContentLoaded', () => {
    window.parent.postMessage({ action: 'ready' }, '*');
    initEventListeners();
});

window.addEventListener('message', (event) => {
    const data = event.data;
    if (!data || !data.action) return;

    switch (data.action) {
        case 'setUser': handleSetUser(data); break;
        case 'setTickets': handleSetTickets(data); break;
        case 'accessDenied': showAccessDenied(data.message); break;
        case 'error': 
            showToast(data.message, 'error'); 
            document.getElementById('submitTicket').classList.remove('loading');
            break;
        case 'ticketCreated': handleTicketCreated(data); break;
        case 'noteAdded': handleNoteAdded(data); break;
        case 'statusUpdated': handleStatusUpdated(data); break;
        case 'ticketDeleted': handleTicketDeleted(data); break;
        case 'profileSaved': handleProfileSaved(data); break;
        case 'fileUploaded': handleFileUploaded(data); break;
        case 'uploadCancelled': state.pendingAttachment = null; updatePendingAttachmentUI(); break;
        case 'uploadError': showToast(data.message || 'Upload failed', 'error'); break;
        case 'showLiveIndicator': if (data.show) document.getElementById('liveIndicator').style.display = 'inline-flex'; break;
        case 'setContractInfo': handleContractInfo(data.contract); break;
        case 'setReferrals': handleSetReferrals(data); break;
        case 'setTaskHistory': handleSetTaskHistory(data); break;
        case 'referralAdded': showToast('Referral submitted! +' + data.tasksAdded + ' tasks added', 'success'); break;
        case 'ticketTypeUpdated': handleTicketTypeUpdated(data); break;
        case 'projectValueUpdated': handleProjectValueUpdated(data); break;
        case 'internalNotesUpdated': handleInternalNotesUpdated(data); break;
        case 'statusNoteDeleted': handleStatusNoteDeleted(data); break;
        case 'realtimeNoteAdded': handleRealtimeNoteAdded(data); break;
        case 'realtimeStatusUpdated': handleRealtimeStatusUpdated(data); break;
        case 'realtimeTicketCreated': handleRealtimeTicketCreated(data); break;
        case 'realtimeTicketDeleted': handleRealtimeTicketDeleted(data); break;
    }
});

// ==========================================
// HANDLERS
// ==========================================
function handleSetUser(data) {
    state.user = data.user;
    state.isAdmin = data.isAdmin;
    state.profile = data.profile;
    state.domain = data.domain;

    document.getElementById('loadingOverlay').classList.add('hidden');
    document.getElementById('userName').textContent = data.user.name || data.user.email;
    document.getElementById('userAvatar').textContent = (data.user.name || data.user.email).charAt(0).toUpperCase();
    document.getElementById('accountUserName').textContent = data.user.name || data.user.email;

    if (data.profile && data.profile.companyName) {
        document.getElementById('companyName').textContent = data.profile.companyName;
        document.getElementById('headerCenter').style.display = 'flex';
        if (data.profile.image) {
            document.getElementById('companyLogo').src = data.profile.image;
            document.getElementById('companyLogo').style.display = 'block';
        }
    }

    if (!data.hasProfile && !data.isAdmin) {
        document.getElementById('profileSetupBanner').style.display = 'block';
    }

    if (data.isAdmin) {
        document.getElementById('userFilter').style.display = 'block';
        document.getElementById('companyFilter').style.display = 'block';
    }
}

function handleSetTickets(data) {
    state.tickets = data.tickets || [];
    state.users = data.users || [];
    state.companies = data.companies || [];
    renderTickets();
    updateStats();
    updateTypeCounts();
    populateFilters();
}

function handleContractInfo(contract) {
    state.contract = contract;
    const banner = document.getElementById('contractBanner');
    if (contract) {
        document.getElementById('contractName').textContent = contract.contractName || '-';
        document.getElementById('baseTasks').textContent = contract.baseTasks || 0;
        document.getElementById('adjustedTasks').textContent = contract.adjustedTasks || 0;
        
        // Monthly usage display
        var tasksPerMonth = contract.tasksPerMonth || 0;
        var usedThisMonth = contract.usedThisMonth || 0;
        document.getElementById('usedThisMonth').textContent = usedThisMonth;
        document.getElementById('monthlyLimit').textContent = tasksPerMonth;
        
        var pct = tasksPerMonth > 0 ? Math.min((usedThisMonth / tasksPerMonth) * 100, 100) : 0;
        var fill = document.getElementById('monthlyProgressFill');
        fill.style.width = pct + '%';
        fill.className = 'contract-progress-bar monthly-progress-fill';
        if (pct >= 100) fill.classList.add('danger');
        else if (pct >= 80) fill.classList.add('warning');
        
        // Show/hide monthly bar
        document.getElementById('contractMonthly').style.display = tasksPerMonth > 0 ? 'block' : 'none';
        
        banner.classList.add('visible');
        
        // Check if no tasks remaining  show warning if present
        var warningEl = document.getElementById('noTasksWarning');
        if (warningEl) {
            warningEl.style.display = (contract.adjustedTasks <= 0) ? 'flex' : 'none';
        }
    } else {
        banner.classList.remove('visible');
    }
}

function handleSetReferrals(data) {
    state.referrals = data.referrals || [];
    state.referralCount = data.count || 0;
}

function handleSetTaskHistory(data) {
    state.taskHistory = data.taskHistory || [];
    renderTaskHistory();
}

function handleTicketCreated(data) {
    document.getElementById('submitTicket').classList.remove('loading');
    state.tickets.unshift(data.ticket);
    renderTickets();
    updateStats();
    updateTypeCounts();
    closeModal();
    showToast('Ticket created successfully!', 'success');
    selectTicket(data.ticket._id);
}

function handleNoteAdded(data) {
    const ticket = state.tickets.find(t => t._id === data.ticketId);
    if (ticket) {
        if (!ticket.notes) ticket.notes = [];
        ticket.notes.push(data.note);
        if (state.selectedTicket && state.selectedTicket._id === data.ticketId) {
            state.selectedTicket = ticket;
            renderTicketDetail(ticket);
        }
    }
}

function handleStatusUpdated(data) {
    const ticket = state.tickets.find(t => t._id === data.ticketId);
    if (ticket) {
        ticket.status = data.status;
        renderTickets();
        updateStats();
        if (state.selectedTicket && state.selectedTicket._id === data.ticketId) {
            state.selectedTicket = ticket;
            renderTicketDetail(ticket);
        }
    }
}

function handleTicketDeleted(data) {
    state.tickets = state.tickets.filter(t => t._id !== data.ticketId);
    renderTickets();
    updateStats();
    updateTypeCounts();
    if (state.selectedTicket && state.selectedTicket._id === data.ticketId) {
        state.selectedTicket = null;
        document.getElementById('ticketDetailContent').style.display = 'none';
        document.getElementById('noTicketSelected').style.display = 'block';
    }
    showToast('Ticket deleted', 'success');
}

function handleProfileSaved(data) {
    state.profile = data.profile;
    document.getElementById('profileSetupBanner').style.display = 'none';
    if (data.profile.companyName) {
        document.getElementById('companyName').textContent = data.profile.companyName;
        document.getElementById('headerCenter').style.display = 'flex';
    }
    showToast('Profile saved!', 'success');
}

function handleFileUploaded(data) {
    state.pendingAttachment = { url: data.url, type: data.fileType, filename: data.filename };
    updatePendingAttachmentUI();
}

function handleTicketTypeUpdated(data) {
    const ticket = state.tickets.find(t => t._id === data.ticketId);
    if (ticket) {
        ticket.ticketType = data.ticketType;
        renderTickets();
        updateTypeCounts();
        if (state.selectedTicket && state.selectedTicket._id === data.ticketId) {
            state.selectedTicket = ticket;
            renderTicketDetail(ticket);
        }
    }
    showToast('Ticket type updated', 'success');
}

function handleProjectValueUpdated(data) {
    const ticket = state.tickets.find(t => t._id === data.ticketId);
    if (ticket) {
        ticket.projectValue = data.projectValue;
        if (data.purchaseOrderReceived !== undefined) {
            ticket.purchaseOrderReceived = data.purchaseOrderReceived;
        }
        if (data.opportunityCategory !== undefined) {
            ticket.opportunityCategory = data.opportunityCategory;
            ticket.opportunityCategoryColour = data.opportunityCategoryColour || '';
        }
        renderTickets();
        if (state.selectedTicket && state.selectedTicket._id === data.ticketId) {
            state.selectedTicket = ticket;
            renderTicketDetail(ticket);
        }
    }
    showToast('Project value updated to ' + data.projectValue + (data.purchaseOrderReceived ? ' (PO received)' : ''), 'success');
}

function handleInternalNotesUpdated(data) {
    const ticket = state.tickets.find(t => t._id === data.ticketId);
    if (ticket) {
        ticket.internalNotes = data.internalNotes;
        if (state.selectedTicket && state.selectedTicket._id === data.ticketId) {
            state.selectedTicket = ticket;
            // Re-render the status notes list
            const notesList = document.getElementById('statusNotesList');
            if (notesList) {
                notesList.innerHTML = renderStatusNotes(data.internalNotes, state.isAdmin);
            }
        }
    }
    // Remove loader and clear input
    const saveBtn = document.getElementById('saveInternalNotes');
    if (saveBtn) saveBtn.classList.remove('loading');
    const input = document.getElementById('internalNotesInput');
    if (input) input.value = '';
    
    showToast('Status note saved', 'success');
}

function handleStatusNoteDeleted(data) {
    const ticket = state.tickets.find(t => t._id === data.ticketId);
    if (ticket) {
        ticket.internalNotes = data.internalNotes;
        if (state.selectedTicket && state.selectedTicket._id === data.ticketId) {
            state.selectedTicket = ticket;
            const notesList = document.getElementById('statusNotesList');
            if (notesList) {
                notesList.innerHTML = renderStatusNotes(data.internalNotes, state.isAdmin);
            }
        }
    }
    showToast('Status note deleted', 'success');
}

function handleRealtimeNoteAdded(data) {
    const ticket = state.tickets.find(t => t._id === data.ticketId);
    if (ticket) {
        if (!ticket.notes) ticket.notes = [];
        const noteExists = ticket.notes.some(n => n.id === data.note.id);
        if (!noteExists) {
            ticket.notes.push(data.note);
            if (state.selectedTicket && state.selectedTicket._id === data.ticketId) {
                state.selectedTicket = ticket;
                renderTicketDetail(ticket);
            } else {
                incrementNotifications(data.ticketId, data.note);
            }
        }
    }
}

function handleRealtimeStatusUpdated(data) {
    handleStatusUpdated(data);
}

function handleRealtimeTicketCreated(data) {
    if (data.ticket && !state.tickets.find(t => t._id === data.ticket._id)) {
        state.tickets.unshift(data.ticket);
        renderTickets();
        updateStats();
        updateTypeCounts();
    }
}

function handleRealtimeTicketDeleted(data) {
    handleTicketDeleted(data);
}

// ==========================================
// NOTIFICATIONS
// ==========================================
function incrementNotifications(ticketId, noteData) {
    if (!state.unreadNotes[ticketId]) state.unreadNotes[ticketId] = 0;
    state.unreadNotes[ticketId]++;
    
    // Find ticket info
    const ticket = state.tickets.find(t => t._id === ticketId);
    
    // Add to notifications array
    state.notifications.unshift({
        ticketId: ticketId,
        ticketNumber: ticket ? ticket.ticketNumber : 'Unknown',
        ticketSubject: ticket ? ticket.subject : 'Unknown Ticket',
        author: noteData ? noteData.author : 'Support Team',
        message: noteData ? (noteData.content || 'Sent an attachment') : 'New message',
        date: new Date().toISOString()
    });
    
    updateNotificationBadge();
    renderNotificationPopup();
    playNotificationSound();
    document.getElementById('notificationBtn').classList.add('bell-ringing');
    setTimeout(() => document.getElementById('notificationBtn').classList.remove('bell-ringing'), 500);
    
    // Fire event to widget
    window.parent.postMessage({ 
        action: 'notificationReceived', 
        ticketId: ticketId, 
        totalCount: state.notificationCount 
    }, '*');
}

function updateNotificationBadge() {
    const total = Object.values(state.unreadNotes).reduce((a, b) => a + b, 0);
    state.notificationCount = total;
    const badge = document.getElementById('notificationBadge');
    badge.textContent = total;
    badge.classList.toggle('hidden', total === 0);
}

function clearNotificationsForTicket(ticketId) {
    if (state.unreadNotes[ticketId]) {
        delete state.unreadNotes[ticketId];
        // Remove notifications for this ticket
        state.notifications = state.notifications.filter(n => n.ticketId !== ticketId);
        updateNotificationBadge();
        renderNotificationPopup();
    }
}

function toggleNotificationPopup(e) {
    e.preventDefault();
    e.stopPropagation();
    const popup = document.getElementById('notificationPopup');
    popup.classList.toggle('active');
}

function closeNotificationPopup() {
    document.getElementById('notificationPopup').classList.remove('active');
}

function renderNotificationPopup() {
    const container = document.getElementById('notificationList');
    if (!container) return;
    
    if (state.notifications.length === 0) {
        container.innerHTML = '<div class="notification-empty">No new notifications</div>';
        return;
    }
    
    container.innerHTML = state.notifications.map((notif, index) => 
        '<div class="notification-item" data-ticket-id="' + notif.ticketId + '" data-index="' + index + '">' +
            '<div class="notification-item-header">' +
                '<span class="notification-ticket">#' + formatTicketNumber(notif.ticketNumber) + '</span>' +
                '<span class="notification-time">' + formatFullDateTime(notif.date) + '</span>' +
            '</div>' +
            '<div class="notification-subject">' + notif.ticketSubject + '</div>' +
            '<div class="notification-message"><strong>' + notif.author + ':</strong> ' + truncateText(notif.message, 50) + '</div>' +
        '</div>'
    ).join('');
    
    // Add click handlers
    container.querySelectorAll('.notification-item').forEach(item => {
        item.addEventListener('click', () => {
            const ticketId = item.dataset.ticketId;
            selectTicket(ticketId);
            closeNotificationPopup();
        });
    });
}

function truncateText(text, maxLength) {
    if (!text) return '';
    if (text.length <= maxLength) return text;
    return text.substring(0, maxLength) + '...';
}

function clearAllNotifications() {
    state.notifications = [];
    state.unreadNotes = {};
    updateNotificationBadge();
    renderNotificationPopup();
}

function playNotificationSound() {
    try {
        const audio = document.getElementById('notificationSound');
        audio.currentTime = 0;
        audio.play().catch(() => {});
    } catch (e) { /* ignore */ }
}

// ==========================================
// RENDERING
// ==========================================
function renderTickets() {
    const container = document.getElementById('ticketList');
    let filtered = state.tickets.filter(ticket => {
        if (state.currentStatusFilter !== 'all' && ticket.status !== state.currentStatusFilter) return false;
        if (state.currentTypeFilter !== 'all' && (ticket.ticketType || 'support') !== state.currentTypeFilter) return false;
        if (state.searchQuery) {
            const q = state.searchQuery.toLowerCase();
            if (!ticket.subject.toLowerCase().includes(q) && 
                !ticket.ticketNumber.toLowerCase().includes(q) && 
                !(ticket.description || '').toLowerCase().includes(q)) return false;
        }
        if (state.priorityFilter && ticket.priority !== state.priorityFilter) return false;
        if (state.userFilter && ticket.userEmail !== state.userFilter) return false;
        if (state.companyFilter && ticket.domain !== state.companyFilter) return false;
        return true;
    });

    if (filtered.length === 0) {
        container.innerHTML = '<div class="empty-state"><svg viewBox="0 0 24 24"><path d="M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm-1 12H5c-.55 0-1-.45-1-1V9c0-.55.45-1 1-1h14c.55 0 1 .45 1 1v8c0 .55-.45 1-1 1z"/></svg><h3>No tickets found</h3><p>Try adjusting your filters</p></div>';
        return;
    }

    container.innerHTML = filtered.map(ticket => {
        const ticketType = ticket.ticketType || 'support';
        const typeLabel = ticketType.charAt(0).toUpperCase() + ticketType.slice(1);
        const unread = state.unreadNotes[ticket._id] || 0;
        return '<div class="ticket-item ' + (state.selectedTicket && state.selectedTicket._id === ticket._id ? 'active' : '') + '" data-id="' + ticket._id + '">' +
            '<div class="ticket-item-header">' +
                '<div class="ticket-number-block">' +
                    '<span class="ticket-number">#' + formatTicketNumber(ticket.ticketNumber) + (unread > 0 ? ' <span style="color:#f44336;font-weight:bold;">(' + unread + ' new)</span>' : '') + '</span>' +
                    '<span class="ticket-datetime">' + formatFullDateTime(ticket._createdDate) + '</span>' +
                '</div>' +
                '<span class="ticket-status ' + ticket.status + '">' + formatStatus(ticket.status) + '</span>' +
            '</div>' +
            '<div class="ticket-subject">' + ticket.subject + '<span class="ticket-type-badge type-' + ticketType + '">' + typeLabel + '</span></div>' +
            (ticketType === 'project' && ticket.projectValue ? '<div class="project-value-display">' + ticket.projectValue.toLocaleString() + '</div>' : '') +
            (ticketType === 'referral' && ticket.projectValue && state.isAdmin ? '<div class="project-value-display" style="color:var(--type-referral);">' + ticket.projectValue.toLocaleString() + '</div>' : '') +
            (ticketType === 'referral' && ticket.opportunityCategory && !state.isAdmin ? '<div class="project-value-display">' + renderOpportunityBadge(ticket) + '</div>' : '') +
            '<div class="ticket-meta">' +
                '<span class="ticket-priority"><span class="priority-dot ' + ticket.priority + '"></span> ' + ticket.priority + '</span>' +
                '<span>' + formatDate(ticket._createdDate) + '</span>' +
                (state.isAdmin ? '<span>' + (ticket.userName || ticket.userEmail) + '</span>' : '') +
            '</div>' +
        '</div>';
    }).join('');

    container.querySelectorAll('.ticket-item').forEach(item => {
        item.addEventListener('click', () => selectTicket(item.dataset.id));
    });
}

function renderTicketDetail(ticket) {
    const container = document.getElementById('ticketDetailContent');
    const ticketType = ticket.ticketType || 'support';
    const isLocked = (ticket.status === 'resolved' || ticket.status === 'closed') && !state.isAdmin;

    let adminTypeSection = '';
    if (state.isAdmin) {
        adminTypeSection = '<div class="admin-type-section visible">' +
            '<h4>Change Ticket Type</h4>' +
            '<div class="admin-type-selector">' +
                '<button class="admin-type-btn ' + (ticketType === 'support' ? 'active' : '') + '" data-type="support" onclick="changeTicketType(\'' + ticket._id + '\', \'support\')">Support</button>' +
                '<button class="admin-type-btn ' + (ticketType === 'bug' ? 'active' : '') + '" data-type="bug" onclick="changeTicketType(\'' + ticket._id + '\', \'bug\')">Bug</button>' +
                '<button class="admin-type-btn ' + (ticketType === 'project' ? 'active' : '') + '" data-type="project" onclick="changeTicketType(\'' + ticket._id + '\', \'project\')">Project</button>' +
                '<button class="admin-type-btn ' + (ticketType === 'referral' ? 'active' : '') + '" data-type="referral" onclick="changeTicketType(\'' + ticket._id + '\', \'referral\')">Referral</button>' +
            '</div>' +
            '<div class="project-value-section ' + (ticketType === 'project' || ticketType === 'referral' ? 'visible' : '') + '">' +
                '<div class="project-value-label">Project Value</div>' +
                '<div class="project-value-input-wrapper">' +
                    '<span class="project-value-prefix"></span>' +
                    '<input type="number" class="project-value-input" id="projectValueInput" value="' + (ticket.projectValue || 0) + '" min="0" step="100">' +
                '</div>' +
                '<label class="po-checkbox-wrapper">' +
                    '<input type="checkbox" class="po-checkbox" id="poReceivedCheckbox" ' + (ticket.purchaseOrderReceived ? 'checked' : '') + '>' +
                    '<span class="po-checkbox-text">Purchase Order Received</span>' +
                '</label>' +
                '<button class="project-value-save-btn project-value-save-full" onclick="saveProjectValue(\'' + ticket._id + '\')">Save</button>' +
                (ticketType === 'referral' ? '<div class="project-value-info">Every 1,000 = 1 extra task (capped at 5,000). Tasks allocated when PO received.</div>' : '<div class="project-value-info">Every 1,000 = 5 extra tasks. Tasks allocated when PO received.</div>') +
            '</div>' +
        '</div>';
    }

    container.innerHTML = '<button class="btn btn-secondary" onclick="closeDetail()" style="margin-bottom: 16px; display: none;" id="backBtn">' +
        '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>Back</button>' +
        '<div class="detail-header">' +
            '<h2 class="detail-title">' + ticket.subject + '</h2>' +
            '<div class="detail-meta">' +
                '<span class="detail-meta-item"><svg viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>' + formatDate(ticket._createdDate) + '</span>' +
                '<span class="detail-meta-item"><svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>' + (ticket.userName || ticket.userEmail) + '</span>' +
                '<span class="ticket-type-badge type-' + ticketType + '">' + ticketType.charAt(0).toUpperCase() + ticketType.slice(1) + '</span>' +
                (isLocked ? '<span class="ticket-locked-badge" title="This ticket is resolved and read-only"><svg viewBox="0 0 24 24"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/></svg></span>' : '') +
            '</div>' +
        '</div>' +
        '<div class="detail-section"><h3 class="detail-section-title">Description</h3><div class="detail-description">' + ticket.description + '</div></div>' +
        '<div class="detail-section"><h3 class="detail-section-title">Details</h3>' +
            '<div class="detail-info-grid">' +
                '<div class="detail-info-item"><div class="detail-info-label">Ticket Number</div><div class="detail-info-value">#' + formatTicketNumber(ticket.ticketNumber) + '</div></div>' +
                '<div class="detail-info-item"><div class="detail-info-label">Status</div><div class="detail-info-value"><span class="ticket-status ' + ticket.status + '">' + formatStatus(ticket.status) + '</span></div></div>' +
                '<div class="detail-info-item"><div class="detail-info-label">Priority</div><div class="detail-info-value"><span class="ticket-priority"><span class="priority-dot ' + ticket.priority + '"></span> ' + ticket.priority.charAt(0).toUpperCase() + ticket.priority.slice(1) + '</span></div></div>' +
                '<div class="detail-info-item"><div class="detail-info-label">Category</div><div class="detail-info-value">' + (ticket.customCategory || formatCategory(ticket.category)) + '</div></div>' +
                '<div class="detail-info-item"><div class="detail-info-label">Business Impact</div><div class="detail-info-value">' + ((ticket.businessImpact || 'moderate').charAt(0).toUpperCase() + (ticket.businessImpact || 'moderate').slice(1)) + '</div></div>' +
                (ticketType === 'project' && ticket.projectValue ? '<div class="detail-info-item"><div class="detail-info-label">Project Value</div><div class="detail-info-value" style="color:var(--type-project);font-weight:600;">' + ticket.projectValue.toLocaleString() + '</div></div>' : '') +
                (ticketType === 'referral' && ticket.projectValue && state.isAdmin ? '<div class="detail-info-item"><div class="detail-info-label">Project Value</div><div class="detail-info-value" style="color:var(--type-referral);font-weight:600;">' + ticket.projectValue.toLocaleString() + '</div></div>' : '') +
                (ticketType === 'referral' && ticket.opportunityCategory && !state.isAdmin ? '<div class="detail-info-item"><div class="detail-info-label">Opportunity</div><div class="detail-info-value">' + renderOpportunityBadge(ticket) + '</div></div>' : '') +
                ((ticketType === 'project' || ticketType === 'referral') && ticket.projectValue && state.isAdmin ? '<div class="detail-info-item"><div class="detail-info-label">PO Status</div><div class="detail-info-value"><span class="po-status-badge ' + (ticket.purchaseOrderReceived ? 'received' : 'pending') + '">' + (ticket.purchaseOrderReceived ? ' PO Received' : ' Awaiting PO') + '</span></div></div>' : '') +
                (ticketType === 'referral' && ticket.companyReferred ? '<div class="detail-info-item"><div class="detail-info-label">Company Referred</div><div class="detail-info-value">' + ticket.companyReferred + '</div></div>' : '') +
                (ticketType === 'referral' && ticket.referralEmail ? '<div class="detail-info-item"><div class="detail-info-label">Referral Contact</div><div class="detail-info-value">' + ticket.referralEmail + '</div></div>' : '') +
            '</div>' +
        '</div>' +
        (state.isAdmin ? '<div class="detail-section"><h3 class="detail-section-title">Update Status</h3>' +
            '<div class="status-actions">' +
                ['open', 'in-progress', 'awaiting-response', 'resolved', 'closed'].map(s => '<button class="status-btn ' + (ticket.status === s ? 'active' : '') + '" data-status="' + s + '">' + formatStatus(s) + '</button>').join('') +
            '</div>' + adminTypeSection + '</div>' +
            '<div class="detail-section"><button class="btn btn-danger" onclick="deleteTicket(\'' + ticket._id + '\')">' +
                '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>Delete Ticket</button></div>' : '') +
        '<div class="detail-section status-notes-section">' +
            '<h3 class="detail-section-title">Status Notes</h3>' +
            '<div class="status-notes-list" id="statusNotesList">' + renderStatusNotes(ticket.internalNotes, state.isAdmin) + '</div>' +
            (state.isAdmin ? '<div class="internal-notes-input-wrapper">' +
                '<textarea class="internal-notes-textarea" id="internalNotesInput" placeholder="Add a new status note..."></textarea>' +
                '<button class="btn btn-primary" id="saveInternalNotes" onclick="addStatusNote(\'' + ticket._id + '\')">' +
                    '<span class="btn-text">Add Note</span>' +
                    '<span class="btn-loader" style="display: none;"></span>' +
                '</button>' +
            '</div>' : '') +
        '</div>' +
        '<div class="notes-section"><h3 class="detail-section-title">Messages</h3>' +
            '<div class="notes-container" id="notesContainer">' + renderNotes(ticket.notes || []) + '</div>' +
            (isLocked ? '<div class="ticket-locked-banner"><svg viewBox="0 0 24 24"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/></svg><span>This ticket has been resolved</span></div>' :
            '<div id="pendingAttachmentContainer"></div>' +
            '<div class="note-input-container">' +
                '<div class="note-input-wrapper">' +
                    '<div class="note-input-actions">' +
                        '<button class="note-action-btn" id="attachBtn" title="Attach file">' +
                            '<svg viewBox="0 0 24 24"><path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5c0-1.38 1.12-2.5 2.5-2.5s2.5 1.12 2.5 2.5v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z"/></svg>' +
                        '</button>' +
                    '</div>' +
                    '<textarea class="note-textarea" id="noteInput" placeholder="Type a message..." rows="1"></textarea>' +
                '</div>' +
                '<button class="note-send-btn" id="sendNoteBtn">' +
                    '<svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>' +
                '</button>' +
            '</div>') +
        '</div>';

    container.style.display = 'block';
    document.getElementById('noTicketSelected').style.display = 'none';

    if (window.innerWidth <= 768) {
        document.getElementById('ticketDetailPanel').classList.add('active');
        document.getElementById('backBtn').style.display = 'inline-flex';
        // Hide ticket list on mobile when viewing detail
        var listCol = document.querySelector('.ticket-list-column');
        if (listCol) listCol.classList.add('hidden-mobile');
        // Show mobile back button
        var mobileBack = document.getElementById('mobileBackBtn');
        if (mobileBack) mobileBack.classList.add('visible');
    }

    container.querySelectorAll('.status-btn').forEach(btn => {
        btn.addEventListener('click', () => updateStatus(ticket._id, btn.dataset.status));
    });

    const attachBtn = document.getElementById('attachBtn');
    const sendNoteBtn = document.getElementById('sendNoteBtn');
    const noteInput = document.getElementById('noteInput');
    
    if (attachBtn) {
        attachBtn.addEventListener('click', () => {
            window.parent.postMessage({ action: 'requestUpload' }, '*');
        });
    }

    if (sendNoteBtn) {
        sendNoteBtn.addEventListener('click', () => sendNote(ticket._id));
    }
    
    if (noteInput) {
        noteInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendNote(ticket._id);
            }
        });
    }

    updatePendingAttachmentUI();
    scrollNotesToBottom();
    initMediaPlayers();
}

function renderNotes(notes) {
    if (!notes || notes.length === 0) {
        return '<div style="text-align:center;color:var(--grey-500);padding:40px;">No messages yet</div>';
    }

    return notes.map(note => {
        const isSent = note.author === 'Support Team' ? state.isAdmin : !state.isAdmin;
        let attachmentHtml = '';

        if (note.attachment) {
            const att = note.attachment;
            // Detect actual type  fallback from URL if type is wrong
            var mediaType = att.type || 'document';
            if (att.url && att.url.indexOf('video.wixstatic.com') !== -1) mediaType = 'video';
            if (mediaType === 'image' && att.filename) {
                var ext = att.filename.split('.').pop().toLowerCase();
                if (['mp4','webm','mov','avi','mkv','m4v'].indexOf(ext) !== -1) mediaType = 'video';
                if (['mp3','wav','ogg','aac','m4a','flac','wma'].indexOf(ext) !== -1) mediaType = 'audio';
            }
            
            var pid = 'player-' + (note.id || Math.random().toString(36).slice(2));
            
            if (mediaType === 'image') {
                attachmentHtml = '<div class="note-attachment"><img src="' + att.url + '" alt="' + att.filename + '" onclick="openImageModal(\'' + att.url + '\')"></div>';
            } else if (mediaType === 'video') {
                attachmentHtml = '<div class="note-attachment"><div class="media-player video-player" id="' + pid + '">' +
                    '<div class="video-wrapper">' +
                        '<video preload="metadata" playsinline>' +
                            '<source src="' + att.url + '" type="video/mp4">' +
                        '</video>' +
                        '<div class="video-play-overlay" onclick="toggleMediaPlay(\'' + pid + '\')">' +
                            '<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>' +
                        '</div>' +
                    '</div>' +
                    '<div class="media-controls">' +
                        '<button class="media-btn play-btn" onclick="toggleMediaPlay(\'' + pid + '\')">' +
                            '<svg class="icon-play" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>' +
                            '<svg class="icon-pause" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>' +
                        '</button>' +
                        '<div class="media-progress" onclick="seekMedia(event, \'' + pid + '\')">' +
                            '<div class="media-progress-fill"></div>' +
                        '</div>' +
                        '<span class="media-time">0:00 / 0:00</span>' +
                        '<button class="media-btn fullscreen-btn" onclick="toggleFullscreen(\'' + pid + '\')">' +
                            '<svg viewBox="0 0 24 24"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg>' +
                        '</button>' +
                    '</div>' +
                    '<div class="media-filename">' + (att.filename || 'Video') + '</div>' +
                '</div></div>';
            } else if (mediaType === 'audio') {
                attachmentHtml = '<div class="note-attachment"><div class="media-player audio-player" id="' + pid + '" data-audio-url="' + att.url + '">' +
                    '<div class="media-controls">' +
                        '<button class="media-btn play-btn" onclick="toggleMediaPlay(\'' + pid + '\')">' +
                            '<svg class="icon-play" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>' +
                            '<svg class="icon-pause" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>' +
                        '</button>' +
                        '<div class="media-progress" onclick="seekMedia(event, \'' + pid + '\')">' +
                            '<div class="media-progress-fill"></div>' +
                        '</div>' +
                        '<span class="media-time">0:00 / 0:00</span>' +
                        '<button class="media-btn volume-btn" onclick="toggleMute(\'' + pid + '\')">' +
                            '<svg class="icon-vol-on" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>' +
                            '<svg class="icon-vol-off" viewBox="0 0 24 24"><path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/></svg>' +
                        '</button>' +
                    '</div>' +
                    '<div class="media-filename"><svg viewBox="0 0 24 24" style="width:14px;height:14px;fill:currentColor;"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55C7.79 13 6 14.79 6 17s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg> ' + (att.filename || 'Audio') + '</div>' +
                '</div></div>';
            } else {
                attachmentHtml = '<div class="note-attachment"><a href="' + att.url + '" target="_blank" class="note-attachment-doc"><svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg><span>' + att.filename + '</span></a></div>';
            }
        }

        return '<div class="note-bubble ' + (isSent ? 'sent' : 'received') + '">' +
            (!isSent ? '<div class="note-author">' + note.author + '</div>' : '') +
            (note.content ? '<div class="note-content">' + note.content + '</div>' : '') +
            attachmentHtml +
            '<div class="note-time">' + formatTime(note.date) + '</div>' +
        '</div>';
    }).join('');
}

function renderReferralList() {
    // Legacy - referrals now shown as ticket type
}

// ==========================================
// RULES POPUP
// ==========================================
function openRulesPopup() {
    const contract = state.contract;
    if (!contract) return;

    const maxTasksPerMonth = Math.round(contract.tasksPerMonth || Math.floor((contract.baseTasks || 0) / 12));
    const body = document.getElementById('rulesPopupBody');

    const hoursPerMonth = Math.round(maxTasksPerMonth * 2.4 * 10) / 10;

    body.innerHTML = '<div class="rules-highlight-row">' +
            '<div class="rules-highlight">' +
                '<div class="rules-highlight-number">' + maxTasksPerMonth + '</div>' +
                '<div class="rules-highlight-label">Max tasks per calendar month</div>' +
            '</div>' +
            '<div class="rules-highlight">' +
                '<div class="rules-highlight-number">' + hoursPerMonth + '</div>' +
                '<div class="rules-highlight-label">Max hours per calendar month</div>' +
            '</div>' +
        '</div>' +
        '<ul class="rules-list">' +
            '<li><svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>' +
                '<span>All tasks requested must fit within the <strong>' + hoursPerMonth + '-hour limit</strong>.</span></li>' +
            '<li><svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>' +
                '<span>Tasks or hours unused within a calendar month <strong>do not accumulate or roll over</strong> to the subsequent month.</span></li>' +
            '<li><svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>' +
                '<span>Average task duration: <strong>2.4 hours</strong></span></li>' +
            '<li><svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>' +
                '<span>Earn extra tasks by referring businesses  qualified referrals with a purchase order <strong>add bonus tasks</strong> based on project size.</span></li>' +
        '</ul>';

    document.getElementById('rulesPopup').classList.add('active');
}

function closeRulesPopup() {
    document.getElementById('rulesPopup').classList.remove('active');
}

// ==========================================
// TASK HISTORY POPUP
// ==========================================
function openTaskHistoryPopup() {
    document.getElementById('taskHistoryPopup').classList.add('active');
    document.getElementById('taskHistoryPopupBody').innerHTML = '<div style="text-align:center;padding:40px;color:var(--grey-500);">Loading task history...</div>';
    window.parent.postMessage({ action: 'getTaskHistory' }, '*');
}

function closeTaskHistoryPopup() {
    document.getElementById('taskHistoryPopup').classList.remove('active');
}

function renderTaskHistory() {
    const container = document.getElementById('taskHistoryPopupBody');
    const history = state.taskHistory;

    if (!history || history.length === 0) {
        container.innerHTML = '<div class="task-history-empty">No task history found</div>';
        return;
    }

    // Summary stats
    const totalTasks = history.length;
    const totalValue = history.reduce(function(sum, h) { return sum + (h.taskValue || 0); }, 0);
    const support = history.filter(function(h) { return h.taskType === 'SUPPORT'; }).length;
    const bugs = history.filter(function(h) { return h.taskType === 'BUG'; }).length;
    const projects = history.filter(function(h) { return h.taskType === 'PROJECT'; }).length;
    const referrals = history.filter(function(h) { return h.taskType === 'REFERRAL'; }).length;

    var html = '<div class="task-history-summary">' +
        '<div class="task-history-stat"><div class="task-history-stat-value">' + totalTasks + '</div><div class="task-history-stat-label">Total Entries</div></div>' +
        '<div class="task-history-stat"><div class="task-history-stat-value">' + totalValue.toFixed(1) + '</div><div class="task-history-stat-label">Net Task Value</div></div>' +
        '<div class="task-history-stat"><div class="task-history-stat-value">' + support + '</div><div class="task-history-stat-label">Support</div></div>' +
        '<div class="task-history-stat"><div class="task-history-stat-value">' + bugs + '</div><div class="task-history-stat-label">Bugs</div></div>' +
        '<div class="task-history-stat"><div class="task-history-stat-value">' + projects + '</div><div class="task-history-stat-label">Projects</div></div>' +
        '<div class="task-history-stat"><div class="task-history-stat-value">' + referrals + '</div><div class="task-history-stat-label">Referrals</div></div>' +
    '</div>';

    html += '<table class="task-history-table"><thead><tr>' +
        '<th>Date</th><th>Type</th><th>Ticket</th><th>Description</th><th>Task Value</th>' +
    '</tr></thead><tbody>';

    history.forEach(function(item) {
        var valueDisplay = item.taskValue || 0;
        var valueStyle = 'font-weight:600;text-align:center;';
        if (valueDisplay < 0) valueStyle += 'color:#c62828;';
        else if (valueDisplay > 0) valueStyle += 'color:#2e7d32;';
        
        html += '<tr>' +
            '<td>' + formatFullDateTime(item.taskCreatedDate) + '</td>' +
            '<td><span class="task-history-type-badge ' + (item.taskType || '') + '">' + (item.taskType || '-') + '</span></td>' +
            '<td>' + (item.ticketNumber ? '#' + formatTicketNumber(item.ticketNumber) : '-') + '</td>' +
            '<td>' + (item.description || '-') + '</td>' +
            '<td style="' + valueStyle + '">' + (valueDisplay > 0 ? '+' : '') + valueDisplay + '</td>' +
        '</tr>';
    });

    html += '</tbody></table>';
    container.innerHTML = html;
}

// ==========================================
// ACTIONS
// ==========================================
function selectTicket(id) {
    const ticket = state.tickets.find(t => t._id === id);
    if (ticket) {
        state.selectedTicket = ticket;
        clearNotificationsForTicket(id);
        renderTickets();
        renderTicketDetail(ticket);
        
        // Close mobile sidebar if open
        document.getElementById('sidebarWrapper').classList.remove('mobile-open');
        document.getElementById('mobileOverlay').classList.remove('active');
        
        // Scroll the ticket into view in the list
        setTimeout(() => {
            const ticketElement = document.querySelector('.ticket-item[data-id="' + id + '"]');
            if (ticketElement) {
                ticketElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }, 50);
    }
}

function closeDetail() {
    document.getElementById('ticketDetailPanel').classList.remove('active');
    // Restore ticket list on mobile
    var listCol = document.querySelector('.ticket-list-column');
    if (listCol) listCol.classList.remove('hidden-mobile');
    var mobileBack = document.getElementById('mobileBackBtn');
    if (mobileBack) mobileBack.classList.remove('visible');
}

function sendNote(ticketId) {
    const input = document.getElementById('noteInput');
    const content = input.value.trim();

    if (!content && !state.pendingAttachment) return;

    const noteData = { action: 'addNote', ticketId: ticketId, content: content, ticket: state.selectedTicket };
    if (state.pendingAttachment) {
        noteData.attachment = state.pendingAttachment;
    }

    window.parent.postMessage(noteData, '*');
    input.value = '';
    state.pendingAttachment = null;
    updatePendingAttachmentUI();
}

function updateStatus(ticketId, status) {
    window.parent.postMessage({ action: 'updateStatus', ticketId: ticketId, status: status }, '*');
}

function deleteTicket(ticketId) {
    if (confirm('Are you sure you want to delete this ticket?')) {
        window.parent.postMessage({ action: 'deleteTicket', ticketId: ticketId }, '*');
    }
}

function changeTicketType(ticketId, newType) {
    window.parent.postMessage({ action: 'updateTicketType', ticketId: ticketId, ticketType: newType }, '*');
}

function saveProjectValue(ticketId) {
    const input = document.getElementById('projectValueInput');
    const value = parseFloat(input.value) || 0;
    const poCheckbox = document.getElementById('poReceivedCheckbox');
    const purchaseOrderReceived = poCheckbox ? poCheckbox.checked : false;
    var saveBtn = document.querySelector('.project-value-save-full');
    if (saveBtn) saveBtn.classList.add('loading');
    window.parent.postMessage({ action: 'updateProjectValue', ticketId: ticketId, value: value, purchaseOrderReceived: purchaseOrderReceived }, '*');
}

function addStatusNote(ticketId) {
    const input = document.getElementById('internalNotesInput');
    const saveBtn = document.getElementById('saveInternalNotes');
    const content = input.value.trim();
    
    if (!content) {
        showToast('Please enter a note', 'error');
        return;
    }
    
    // Show loader
    saveBtn.classList.add('loading');
    
    window.parent.postMessage({ action: 'addStatusNote', ticketId: ticketId, content: content }, '*');
}

function deleteStatusNote(ticketId, noteId) {
    if (!confirm('Delete this status note?')) return;
    window.parent.postMessage({ action: 'deleteStatusNote', ticketId: ticketId, noteId: noteId }, '*');
}

function renderStatusNotes(notesData, isAdmin) {
    let notes = [];
    if (notesData) {
        try {
            notes = typeof notesData === 'string' ? JSON.parse(notesData) : notesData;
            if (!Array.isArray(notes)) notes = [];
        } catch (e) {
            notes = [];
        }
    }
    
    if (notes.length === 0) {
        return '<div class="no-notes">No status notes yet</div>';
    }
    
    return notes.map(note => 
        '<div class="status-note-item" data-note-id="' + note.id + '">' +
            '<div class="status-note-header">' +
                '<span class="status-note-date">' + formatFullDateTime(note.date) + '</span>' +
                (isAdmin ? '<button class="status-note-delete" onclick="deleteStatusNote(\'' + state.selectedTicket._id + '\', \'' + note.id + '\')" title="Delete note">' +
                    '<svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>' +
                '</button>' : '') +
            '</div>' +
            '<div class="status-note-content">' + note.content + '</div>' +
        '</div>'
    ).join('');
}

// ==========================================
// MODAL FUNCTIONS
// ==========================================
function openModal() {
    document.getElementById('newTicketModal').classList.add('active');
    resetForm();
    window.scrollTo(0, 0);
    window.parent.postMessage({ action: 'modalOpened', modal: 'newTicket' }, '*');
}

function closeModal() {
    document.getElementById('newTicketModal').classList.remove('active');
}

function closeNewTicketModal() {
    closeModal();
    // Clear validation states
    document.getElementById('ticketSubject').classList.remove('invalid');
    document.getElementById('ticketDescription').classList.remove('invalid');
    document.getElementById('subjectError').style.display = 'none';
    document.getElementById('descriptionError').style.display = 'none';
    document.getElementById('submitTicket').classList.remove('loading');
    // Clear referral validation
    var rc = document.getElementById('referralCompanyName');
    var re = document.getElementById('referralEmailAddress');
    if (rc) rc.classList.remove('invalid');
    if (re) re.classList.remove('invalid');
    var rce = document.getElementById('referralCompanyError');
    var ree = document.getElementById('referralEmailError');
    if (rce) rce.style.display = 'none';
    if (ree) ree.style.display = 'none';
}

function openReferralModal() {
    // Legacy - referrals now handled via new ticket form
    openModal();
    // Auto-select referral type
    setTimeout(function() {
        var referralOption = document.querySelector('.type-option[data-type="referral"]');
        if (referralOption) referralOption.click();
    }, 100);
}

function closeReferralModal() {
    // Legacy stub
}

function openImageModal(url) {
    document.getElementById('imageModalImg').src = url;
    document.getElementById('imageModal').classList.add('active');
    window.scrollTo(0, 0);
    window.parent.postMessage({ action: 'modalOpened', modal: 'image' }, '*');
}

function closeImageModal() {
    document.getElementById('imageModal').classList.remove('active');
}

// ==========================================
// CUSTOM MEDIA PLAYER CONTROLS
// ==========================================
var audioRegistry = {};

function getMediaElement(playerId) {
    var player = document.getElementById(playerId);
    if (!player) return null;
    // Check for video element in DOM
    var video = player.querySelector('video');
    if (video) return video;
    // Check audio registry
    if (audioRegistry[playerId]) return audioRegistry[playerId];
    return null;
}

function createAudioForPlayer(playerId, url) {
    if (audioRegistry[playerId]) return audioRegistry[playerId];
    var audio = new Audio();
    audio.crossOrigin = 'anonymous';
    audio.preload = 'auto';
    audio.src = url;
    audioRegistry[playerId] = audio;
    return audio;
}

function formatMediaTime(seconds) {
    if (isNaN(seconds) || !isFinite(seconds)) return '0:00';
    var m = Math.floor(seconds / 60);
    var s = Math.floor(seconds % 60);
    return m + ':' + (s < 10 ? '0' : '') + s;
}

function toggleMediaPlay(playerId) {
    var player = document.getElementById(playerId);
    if (!player) return;
    
    // Lazily create Audio object for audio players
    var audioUrl = player.getAttribute('data-audio-url');
    if (audioUrl && !audioRegistry[playerId]) {
        createAudioForPlayer(playerId, audioUrl);
        startProgressUpdate(playerId);
    }
    
    var media = getMediaElement(playerId);
    if (!media) return;
    
    if (media.paused) {
        // Pause all other players first
        document.querySelectorAll('.media-player').forEach(function(p) {
            if (p.id !== playerId) {
                var otherMedia = getMediaElement(p.id);
                if (otherMedia && !otherMedia.paused) {
                    otherMedia.pause();
                    p.classList.remove('playing');
                }
            }
        });
        startProgressUpdate(playerId);
        var playPromise = media.play();
        if (playPromise !== undefined) {
            playPromise.then(function() {
                player.classList.add('playing');
            }).catch(function(err) {
                console.error('Playback failed:', err);
                player.classList.remove('playing');
                // Try without crossOrigin
                if (audioUrl && media.crossOrigin) {
                    media.crossOrigin = null;
                    media.src = audioUrl;
                    media.load();
                    media.addEventListener('canplay', function retryPlay() {
                        media.removeEventListener('canplay', retryPlay);
                        media.play().then(function() {
                            player.classList.add('playing');
                        }).catch(function(e2) {
                            console.error('Retry also failed:', e2);
                            var timeEl = player.querySelector('.media-time');
                            if (timeEl) timeEl.textContent = 'Playback error';
                        });
                    });
                }
            });
        } else {
            player.classList.add('playing');
        }
    } else {
        media.pause();
        player.classList.remove('playing');
    }
}

function seekMedia(event, playerId) {
    var media = getMediaElement(playerId);
    if (!media || !media.duration) return;
    var bar = event.currentTarget;
    var rect = bar.getBoundingClientRect();
    var ratio = Math.max(0, Math.min(1, (event.clientX - rect.left) / rect.width));
    media.currentTime = ratio * media.duration;
    updateProgress(playerId);
}

function updateProgress(playerId) {
    var media = getMediaElement(playerId);
    var player = document.getElementById(playerId);
    if (!media || !player) return;
    
    var fill = player.querySelector('.media-progress-fill');
    var timeEl = player.querySelector('.media-time');
    
    if (fill && media.duration) {
        fill.style.width = ((media.currentTime / media.duration) * 100) + '%';
    }
    if (timeEl) {
        timeEl.textContent = formatMediaTime(media.currentTime) + ' / ' + formatMediaTime(media.duration);
    }
    
    // Hide video overlay when playing
    var overlay = player.querySelector('.video-play-overlay');
    if (overlay) {
        overlay.style.display = media.paused ? 'flex' : 'none';
    }
}

function startProgressUpdate(playerId) {
    var media = getMediaElement(playerId);
    if (!media) return;
    
    media.onended = function() {
        var player = document.getElementById(playerId);
        if (player) player.classList.remove('playing');
        var overlay = player ? player.querySelector('.video-play-overlay') : null;
        if (overlay) overlay.style.display = 'flex';
    };
    media.ontimeupdate = function() { updateProgress(playerId); };
    media.onloadedmetadata = function() { updateProgress(playerId); };
    media.onerror = function(e) {
        console.error('Media error for ' + playerId + ':', media.error);
        var player = document.getElementById(playerId);
        var timeEl = player ? player.querySelector('.media-time') : null;
        if (timeEl) timeEl.textContent = 'Error';
        if (player) player.classList.remove('playing');
    };
}

function toggleMute(playerId) {
    var media = getMediaElement(playerId);
    if (!media) return;
    media.muted = !media.muted;
    var player = document.getElementById(playerId);
    if (player) {
        if (media.muted) player.classList.add('muted');
        else player.classList.remove('muted');
    }
}

function toggleFullscreen(playerId) {
    var player = document.getElementById(playerId);
    if (!player) return;
    var video = player.querySelector('video');
    if (!video) return;
    if (video.requestFullscreen) video.requestFullscreen();
    else if (video.webkitRequestFullscreen) video.webkitRequestFullscreen();
    else if (video.webkitEnterFullscreen) video.webkitEnterFullscreen();
}

// Initialize any media players already in the DOM
function initMediaPlayers() {
    document.querySelectorAll('.media-player').forEach(function(player) {
        var media = player.querySelector('video') || player.querySelector('audio');
        if (media) startProgressUpdate(player.id);
    });
}


function resetForm() {
    document.getElementById('ticketForm').reset();
    state.selectedCategory = null;
    state.selectedPriority = 'medium';
    state.selectedImpact = 'moderate';
    state.selectedTicketType = 'support';

    document.querySelectorAll('.category-card').forEach(c => c.classList.remove('selected'));
    document.querySelectorAll('.priority-option').forEach(p => p.classList.remove('selected'));
    document.querySelectorAll('.impact-option').forEach(i => i.classList.remove('selected'));
    document.querySelectorAll('.type-option').forEach(t => t.classList.remove('selected'));

    document.querySelector('.priority-option.medium').classList.add('selected');
    document.querySelector('.impact-option.moderate').classList.add('selected');
    document.querySelector('.type-option[data-type="support"]').classList.add('selected');

    document.getElementById('categoryFormGroup').style.display = 'block';
    document.getElementById('referralFieldsGroup').style.display = 'none';
    document.getElementById('subjectFormGroup').style.display = 'block';
    document.getElementById('descriptionFormGroup').style.display = 'block';
    document.getElementById('priorityFormGroup').style.display = 'block';
    document.getElementById('impactFormGroup').style.display = 'block';
    
    // Clear validation states
    document.getElementById('ticketSubject').classList.remove('invalid');
    document.getElementById('ticketDescription').classList.remove('invalid');
    document.getElementById('subjectError').style.display = 'none';
    document.getElementById('descriptionError').style.display = 'none';
    document.getElementById('submitTicket').classList.remove('loading');
    
    // Clear referral validation
    var refCompany = document.getElementById('referralCompanyName');
    var refEmail = document.getElementById('referralEmailAddress');
    if (refCompany) { refCompany.classList.remove('invalid'); refCompany.value = ''; }
    if (refEmail) { refEmail.classList.remove('invalid'); refEmail.value = ''; }
    var refPhone = document.getElementById('referralPhoneNumber');
    var refComment = document.getElementById('referralCommentText');
    if (refPhone) refPhone.value = '';
    if (refComment) refComment.value = '';
    var refCompanyErr = document.getElementById('referralCompanyError');
    var refEmailErr = document.getElementById('referralEmailError');
    if (refCompanyErr) refCompanyErr.style.display = 'none';
    if (refEmailErr) refEmailErr.style.display = 'none';
}

function submitTicket() {
    const ticketType = state.selectedTicketType;
    const subject = document.getElementById('ticketSubject').value.trim();
    const description = document.getElementById('ticketDescription').value.trim();
    const subjectInput = document.getElementById('ticketSubject');
    const descriptionInput = document.getElementById('ticketDescription');
    const subjectError = document.getElementById('subjectError');
    const descriptionError = document.getElementById('descriptionError');
    const submitBtn = document.getElementById('submitTicket');
    
    // Clear previous validation states
    subjectInput.classList.remove('invalid');
    descriptionInput.classList.remove('invalid');
    subjectError.style.display = 'none';
    descriptionError.style.display = 'none';
    
    // Clear referral validation
    var refCompanyInput = document.getElementById('referralCompanyName');
    var refEmailInput = document.getElementById('referralEmailAddress');
    var refCompanyError = document.getElementById('referralCompanyError');
    var refEmailError = document.getElementById('referralEmailError');
    if (refCompanyInput) refCompanyInput.classList.remove('invalid');
    if (refEmailInput) refEmailInput.classList.remove('invalid');
    if (refCompanyError) refCompanyError.style.display = 'none';
    if (refEmailError) refEmailError.style.display = 'none';
    
    let hasError = false;
    
    if (ticketType !== 'referral') {
        if (subject.length < 5) {
            subjectInput.classList.add('invalid');
            subjectError.style.display = 'block';
            hasError = true;
        }
        if (description.length < 10) {
            descriptionInput.classList.add('invalid');
            descriptionError.style.display = 'block';
            hasError = true;
        }
    }
    
    // Referral-specific validation
    var referralData = {};
    if (ticketType === 'referral') {
        var companyReferred = refCompanyInput ? refCompanyInput.value.trim() : '';
        var emailAddress = refEmailInput ? refEmailInput.value.trim() : '';
        var phone = document.getElementById('referralPhoneNumber') ? document.getElementById('referralPhoneNumber').value.trim() : '';
        var comment = document.getElementById('referralCommentText') ? document.getElementById('referralCommentText').value.trim() : '';
        
        if (!companyReferred) {
            if (refCompanyInput) refCompanyInput.classList.add('invalid');
            if (refCompanyError) refCompanyError.style.display = 'block';
            hasError = true;
        }
        if (!emailAddress || !emailAddress.includes('@')) {
            if (refEmailInput) refEmailInput.classList.add('invalid');
            if (refEmailError) refEmailError.style.display = 'block';
            hasError = true;
        }
        
        referralData = {
            companyReferred: companyReferred,
            emailAddress: emailAddress,
            phone: phone,
            comment: comment
        };
    }
    
    if (hasError) {
        showToast('Please fill in the required fields', 'error');
        return;
    }
    
    // Check if user has available tasks for support tickets
    if (ticketType === 'support' && state.contract && state.contract.adjustedTasks <= 0) {
        showToast('You have used all your contracted tasks for this period. Please contact support.', 'error');
        return;
    }
    
    // Show loader
    submitBtn.classList.add('loading');

    var messageData = {
        action: 'createTicket',
        ticketType: ticketType,
        category: ticketType === 'support' ? (state.selectedCategory || 'general') : ticketType,
        customCategory: (document.getElementById('customCategory') ? document.getElementById('customCategory').value.trim() : ''),
        subject: ticketType === 'referral' ? 'Referral' : subject,
        description: ticketType === 'referral' ? '' : description,
        priority: ticketType === 'referral' ? 'medium' : state.selectedPriority,
        businessImpact: ticketType === 'referral' ? 'none' : state.selectedImpact
    };
    
    // Add referral fields if referral type
    if (ticketType === 'referral') {
        messageData.companyReferred = referralData.companyReferred;
        messageData.referralEmail = referralData.emailAddress;
        messageData.referralPhone = referralData.phone;
        messageData.referralComment = referralData.comment;
        messageData.subject = 'Referral: ' + referralData.companyReferred;
    }

    window.parent.postMessage(messageData, '*');
}

function submitReferral(e) {
    // Legacy - referrals now submitted through the new ticket form
    if (e) e.preventDefault();
}

// ==========================================
// UTILITIES
// ==========================================
function updateStats() {
    const total = state.tickets.length;
    const open = state.tickets.filter(t => t.status === 'open').length;
    const inProgress = state.tickets.filter(t => t.status === 'in-progress').length;
    const resolved = state.tickets.filter(t => t.status === 'resolved' || t.status === 'closed').length;

    document.getElementById('totalTickets').textContent = total;
    document.getElementById('openTickets').textContent = open;
    document.getElementById('inProgressTickets').textContent = inProgress;
    document.getElementById('resolvedTickets').textContent = resolved;
}

function updateTypeCounts() {
    const all = state.tickets.length;
    const support = state.tickets.filter(t => (t.ticketType || 'support') === 'support').length;
    const bug = state.tickets.filter(t => t.ticketType === 'bug').length;
    const project = state.tickets.filter(t => t.ticketType === 'project').length;
    const referral = state.tickets.filter(t => t.ticketType === 'referral').length;

    document.getElementById('allTypeCount').textContent = all;
    document.getElementById('supportTypeCount').textContent = support;
    document.getElementById('bugTypeCount').textContent = bug;
    document.getElementById('projectTypeCount').textContent = project;
    document.getElementById('referralTypeCount').textContent = referral;
}

function populateFilters() {
    if (state.isAdmin) {
        const userFilter = document.getElementById('userFilter');
        userFilter.innerHTML = '<option value="">All Users</option>' + 
            state.users.map(u => '<option value="' + u.email + '">' + (u.name || u.email) + ' (' + u.ticketCount + ')</option>').join('');

        const companyFilter = document.getElementById('companyFilter');
        companyFilter.innerHTML = '<option value="">All Companies</option>' + 
            state.companies.map(c => '<option value="' + c.domain + '">' + c.companyName + ' (' + c.ticketCount + ')</option>').join('');
    }
}

function updatePendingAttachmentUI() {
    const container = document.getElementById('pendingAttachmentContainer');
    if (!container) return;

    if (!state.pendingAttachment) {
        container.innerHTML = '';
        return;
    }

    const att = state.pendingAttachment;
    let preview = '';
    if (att.type === 'image') {
        preview = '<img src="' + att.url + '" class="pending-attachment-preview" alt="Preview">';
    } else {
        preview = '<div class="pending-attachment-icon"><svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg></div>';
    }

    container.innerHTML = '<div class="pending-attachment">' + preview +
        '<div class="pending-attachment-info">' +
            '<div class="pending-attachment-name">' + att.filename + '</div>' +
            '<div class="pending-attachment-type">' + att.type + '</div>' +
        '</div>' +
        '<button class="pending-attachment-remove" onclick="removePendingAttachment()">' +
            '<svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>' +
        '</button>' +
    '</div>';
}

function removePendingAttachment() {
    state.pendingAttachment = null;
    updatePendingAttachmentUI();
}

function scrollNotesToBottom() {
    const container = document.getElementById('notesContainer');
    if (container) container.scrollTop = container.scrollHeight;
}

function formatDate(date) {
    if (!date) return '';
    const d = new Date(date);
    const now = new Date();
    const diffMs = now - d;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);

    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return diffMins + 'm ago';
    if (diffHours < 24) return diffHours + 'h ago';
    if (diffDays < 7) return diffDays + 'd ago';
    return d.toLocaleDateString();
}

function formatTime(date) {
    if (!date) return '';
    const d = new Date(date);
    return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

function formatStatus(status) {
    const map = {
        'open': 'Open',
        'in-progress': 'In Progress',
        'awaiting-response': 'Awaiting Response',
        'resolved': 'Resolved',
        'closed': 'Closed'
    };
    return map[status] || status;
}

function formatCategory(category) {
    const map = {
        'domains': 'Domains & Account',
        'billing': 'Plans & Billing',
        'payments': 'Payments',
        'marketing': 'Marketing & SEO',
        'stores': 'Wix Stores',
        'memberships': 'Memberships & Events',
        'velo': 'Velo & CMS',
        'content': 'Content / Design',
        'other': 'Custom',
        'bug': 'Bug Report',
        'project': 'Project'
    };
    return map[category] || category;
}

function formatTicketNumber(num) {
    const str = String(num).replace(/[^0-9]/g, '');
    if (str.length > 3) {
        return str.slice(0, 3) + '-' + str.slice(3);
    }
    return str;
}

function renderOpportunityBadge(ticket) {
    if (!ticket.opportunityCategory) return '';
    var colour = ticket.opportunityCategoryColour || '999999';
    if (colour.charAt(0) !== '#') colour = '#' + colour;
    // Light background: 20% opacity of colour
    var r = parseInt(colour.slice(1,3), 16);
    var g = parseInt(colour.slice(3,5), 16);
    var b = parseInt(colour.slice(5,7), 16);
    var bg = 'rgba(' + r + ',' + g + ',' + b + ',0.12)';
    return '<span class="opportunity-badge" style="background:' + bg + ';color:' + colour + ';">' +
        '<span class="opportunity-badge-dot" style="background:' + colour + ';"></span>' +
        ticket.opportunityCategory +
    '</span>';
}

function formatFullDateTime(date) {
    if (!date) return '';
    const d = new Date(date);
    const day = d.getDate();
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const month = months[d.getMonth()];
    const year = d.getFullYear();
    const hours = d.getHours().toString().padStart(2, '0');
    const mins = d.getMinutes().toString().padStart(2, '0');
    return day + ' ' + month + ' ' + year + ', ' + hours + ':' + mins;
}

function showToast(message, type) {
    type = type || 'success';
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toastMessage');
    toast.className = 'toast show ' + type;
    toastMessage.textContent = message;
    setTimeout(() => toast.classList.remove('show'), 3000);
}

function showAccessDenied(message) {
    document.getElementById('loadingOverlay').classList.add('hidden');
    document.getElementById('statsBar').style.display = 'none';
    document.getElementById('ticketTypeTabs').style.display = 'none';
    document.getElementById('statusTabs').style.display = 'none';
    document.getElementById('mainContent').style.display = 'none';
    document.getElementById('accessDenied').style.display = 'block';
    document.getElementById('accessDeniedMessage').textContent = message;
}

// ==========================================
// EVENT LISTENERS
// ==========================================
function initEventListeners() {
    document.getElementById('newTicketBtn').addEventListener('click', openModal);
    document.getElementById('closeModal').addEventListener('click', closeNewTicketModal);
    document.getElementById('cancelTicket').addEventListener('click', closeNewTicketModal);
    document.getElementById('submitTicket').addEventListener('click', submitTicket);
    document.getElementById('pacmanBtn').addEventListener('click', () => window.parent.postMessage({ action: 'pacman' }, '*'));
    document.getElementById('brandingBtn').addEventListener('click', () => window.parent.postMessage({ action: 'brandingGuide' }, '*'));
    document.getElementById('imageModal').addEventListener('click', closeImageModal);
    
    // Rules and Task History popups
    document.getElementById('rulesBtn').addEventListener('click', openRulesPopup);
    document.getElementById('feedbackBtn').addEventListener('click', () => {
        window.parent.postMessage({ action: 'navigateToFeedback' }, '*');
    });
    
    // Account dropdown - userInfo toggles, accountBtn goes to settings
    document.getElementById('userInfo').addEventListener('click', (e) => {
        e.stopPropagation();
        var dropdown = document.getElementById('accountDropdown');
        dropdown.classList.toggle('visible');
    });
    document.getElementById('accountBtn').addEventListener('click', () => {
        document.getElementById('accountDropdown').classList.remove('visible');
        window.parent.postMessage({ action: 'accountSettings' }, '*');
    });
    document.getElementById('logoutBtn').addEventListener('click', () => {
        document.getElementById('accountDropdown').classList.remove('visible');
        window.parent.postMessage({ action: 'logout' }, '*');
    });
    document.addEventListener('click', () => {
        document.getElementById('accountDropdown').classList.remove('visible');
    });

    // Project button
    document.getElementById('projectBtn').addEventListener('click', () => {
        window.parent.postMessage({ action: 'projectDashboard' }, '*');
    });

    // Sidebar collapse/expand
    document.getElementById('collapseBtn').addEventListener('click', () => {
        document.getElementById('sidebar').classList.toggle('collapsed');
    });

    // Mobile menu open/close
    document.getElementById('mobileMenuBtn').addEventListener('click', () => {
        document.getElementById('sidebarWrapper').classList.add('mobile-open');
        document.getElementById('mobileOverlay').classList.add('active');
    });
    document.getElementById('mobileOverlay').addEventListener('click', () => {
        document.getElementById('sidebarWrapper').classList.remove('mobile-open');
        document.getElementById('mobileOverlay').classList.remove('active');
    });

    // Mobile back button (from detail view)
    document.getElementById('mobileBackBtn').addEventListener('click', closeDetail);
    document.getElementById('closeRulesPopup').addEventListener('click', closeRulesPopup);
    document.getElementById('rulesPopup').addEventListener('click', function(e) { if (e.target.id === 'rulesPopup') closeRulesPopup(); });
    document.getElementById('taskHistoryBtn').addEventListener('click', openTaskHistoryPopup);
    document.getElementById('closeTaskHistoryPopup').addEventListener('click', closeTaskHistoryPopup);
    document.getElementById('taskHistoryPopup').addEventListener('click', function(e) { if (e.target.id === 'taskHistoryPopup') closeTaskHistoryPopup(); });
    
    // Notification popup (modal overlay)
    document.getElementById('notificationBtn').addEventListener('click', toggleNotificationPopup);
    document.getElementById('closeNotificationPopup').addEventListener('click', closeNotificationPopup);
    document.getElementById('clearAllNotifications').addEventListener('click', clearAllNotifications);
    document.getElementById('notificationPopup').addEventListener('click', function(e) { if (e.target.id === 'notificationPopup') closeNotificationPopup(); });

    document.getElementById('saveProfileBtn').addEventListener('click', () => {
        const name = document.getElementById('profileNameInput').value.trim();
        const companyName = document.getElementById('profileCompanyInput').value.trim();
        if (!name || !companyName) {
            showToast('Please fill in both fields', 'error');
            return;
        }
        window.parent.postMessage({ action: 'saveProfile', name: name, companyName: companyName }, '*');
    });

    document.getElementById('searchInput').addEventListener('input', (e) => {
        state.searchQuery = e.target.value;
        renderTickets();
    });

    document.getElementById('priorityFilter').addEventListener('change', (e) => {
        state.priorityFilter = e.target.value;
        renderTickets();
    });

    document.getElementById('userFilter').addEventListener('change', (e) => {
        state.userFilter = e.target.value;
        renderTickets();
    });

    document.getElementById('companyFilter').addEventListener('change', (e) => {
        state.companyFilter = e.target.value;
        renderTickets();
    });

    // Status tabs
    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            state.currentStatusFilter = tab.dataset.tab;
            renderTickets();
        });
    });

    // Type tabs
    document.querySelectorAll('.ticket-type-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            document.querySelectorAll('.ticket-type-tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            state.currentTypeFilter = tab.dataset.type;
            
            // Reset status filter to All Tickets
            state.currentStatusFilter = 'all';
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            var allTab = document.querySelector('.tab[data-tab="all"]');
            if (allTab) allTab.classList.add('active');
            
            // Reset priority filter to All Priorities
            state.priorityFilter = '';
            var prioritySelect = document.getElementById('priorityFilter');
            if (prioritySelect) prioritySelect.value = '';
            
            renderTickets();
        });
    });

    // Type selector in form
    document.querySelectorAll('.type-option').forEach(option => {
        option.addEventListener('click', () => {
            document.querySelectorAll('.type-option').forEach(o => o.classList.remove('selected'));
            option.classList.add('selected');
            state.selectedTicketType = option.dataset.type;

            // Show/hide category fields
            if (option.dataset.type === 'support') {
                document.getElementById('categoryFormGroup').style.display = 'block';
            } else {
                document.getElementById('categoryFormGroup').style.display = 'none';
            }
            
            // Show/hide referral fields
            if (option.dataset.type === 'referral') {
                document.getElementById('referralFieldsGroup').style.display = 'block';
                document.getElementById('subjectFormGroup').style.display = 'none';
                document.getElementById('descriptionFormGroup').style.display = 'none';
                document.getElementById('priorityFormGroup').style.display = 'none';
                document.getElementById('impactFormGroup').style.display = 'none';
            } else {
                document.getElementById('referralFieldsGroup').style.display = 'none';
                document.getElementById('subjectFormGroup').style.display = 'block';
                document.getElementById('descriptionFormGroup').style.display = 'block';
                document.getElementById('priorityFormGroup').style.display = 'block';
                document.getElementById('impactFormGroup').style.display = 'block';
            }
        });
    });

    // Category cards
    document.querySelectorAll('.category-card').forEach(card => {
        card.addEventListener('click', () => {
            document.querySelectorAll('.category-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            state.selectedCategory = card.dataset.category;
            var subjectField = document.getElementById('ticketSubject');
            if (card.dataset.category === 'other') {
                if (subjectField) { subjectField.value = ''; subjectField.focus(); }
            } else {
                var title = card.querySelector('.category-card-title');
                if (title && subjectField) subjectField.value = title.textContent.trim();
            }
        });
    });

    // Priority options
    document.querySelectorAll('.priority-option').forEach(option => {
        option.addEventListener('click', () => {
            document.querySelectorAll('.priority-option').forEach(o => o.classList.remove('selected'));
            option.classList.add('selected');
            state.selectedPriority = option.dataset.priority;
        });
    });

    // Impact options
    document.querySelectorAll('.impact-option').forEach(option => {
        option.addEventListener('click', () => {
            document.querySelectorAll('.impact-option').forEach(o => o.classList.remove('selected'));
            option.classList.add('selected');
            state.selectedImpact = option.dataset.impact;
        });
    });

    // Modal close on overlay click
    document.getElementById('newTicketModal').addEventListener('click', (e) => {
        if (e.target.id === 'newTicketModal') closeNewTicketModal();
    });
}

    </script>
</body>
</html>